<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro Docente Integral ¬∑ MEP</title>
    <!-- Font Awesome (iconos profesionales) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- jsPDF y html2canvas para PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Roboto, system-ui, sans-serif; }
        :root { --bg: #f3f6f9; --sidebar: #0b2b40; --card: #ffffff; --text: #1e2f3e; --border: #cbd5e0; --accent: #0b5e7e; --accent-light: #e6f0f5; --success: #2e7d32; --warning: #b85c00; --danger: #b33; --btn-hover: #104e6b; --shadow: 0 8px 20px rgba(0,0,0,0.05); --header-bg: #f9fbfd; }
        body.dark { --bg: #1a2632; --sidebar: #0a1c2c; --card: #2a3745; --text: #e2e8f0; --border: #4a5568; --accent-light: #1e3f54; --header-bg: #1e2e3b; --shadow: 0 8px 20px rgba(0,0,0,0.3); }
        body { background: var(--bg); color: var(--text); display: flex; min-height: 100vh; transition: background 0.2s; }
        /* sidebar fijo */
        .sidebar { width: 280px; background: var(--sidebar); color: #ecf0f3; padding: 2rem 1rem; overflow-y: auto; box-shadow: 2px 0 10px rgba(0,0,0,0.2); }
        .sidebar h2 { font-weight: 400; font-size: 1.3rem; margin-bottom: 2rem; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #2c4b61; padding-bottom: 1rem; }
        .sidebar nav { display: flex; flex-direction: column; gap: 0.5rem; }
        .sidebar button { background: none; border: none; color: #cfdfe9; text-align: left; padding: 0.9rem 1rem; font-size: 1rem; border-radius: 10px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 12px; }
        .sidebar button i { width: 24px; font-size: 1.2rem; }
        .sidebar button:hover { background: #1d445b; color: white; }
        .sidebar button.active { background: #145a7a; color: white; font-weight: 500; box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
        /* contenido principal */
        .main-content { flex: 1; padding: 2rem; overflow-y: auto; max-height: 100vh; }
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; background: var(--header-bg); padding: 1rem 2rem; border-radius: 40px; box-shadow: var(--shadow); }
        .header-bar h1 { font-size: 1.6rem; font-weight: 400; display: flex; align-items: center; gap: 10px; }
        .modo-toggle { background: var(--card); border: 1px solid var(--border); padding: 0.5rem 1.2rem; border-radius: 40px; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }
        /* tarjetas y formularios */
        .card { background: var(--card); border-radius: 28px; padding: 1.8rem; box-shadow: var(--shadow); margin-bottom: 2rem; border: 1px solid var(--border); }
        .card h3 { margin-bottom: 1.5rem; font-weight: 400; border-left: 6px solid var(--accent); padding-left: 1rem; }
        .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px,1fr)); gap: 2rem; }
        .btn { background: white; border: 1px solid var(--border); padding: 0.7rem 1.5rem; border-radius: 40px; cursor: pointer; font-weight: 500; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; color: var(--text); }
        .btn-primary { background: var(--accent); color: white; border: none; }
        .btn-primary:hover { background: var(--btn-hover); }
        .btn-danger { background: #c93e3e; color: white; border: none; }
        .btn-sm { padding: 0.4rem 1rem; font-size: 0.9rem; }
        input, select, textarea { background: var(--bg); border: 1px solid var(--border); padding: 0.8rem 1rem; border-radius: 30px; width: 100%; margin-bottom: 1rem; color: var(--text); }
        label { font-weight: 500; margin-bottom: 0.3rem; display: block; }
        .table { width: 100%; border-collapse: collapse; background: var(--card); border-radius: 20px; overflow: hidden; }
        .table th { background: var(--accent-light); text-align: left; padding: 1rem; }
        .table td { padding: 0.8rem 1rem; border-bottom: 1px solid var(--border); }
        .fila-acciones i { margin: 0 5px; cursor: pointer; opacity: 0.7; }
        .fila-acciones i:hover { opacity: 1; color: var(--accent); }
        .toast { position: fixed; bottom: 30px; right: 30px; background: var(--accent); color: white; padding: 1rem 2rem; border-radius: 60px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); display: none; z-index: 999; }
        .alert-warning { background: #fff3cd; border-left: 8px solid #ffc107; padding: 1rem; border-radius: 16px; }
        .barra-acciones { display: flex; gap: 10px; flex-wrap: wrap; margin: 1rem 0; }
        .total-val { font-weight: 700; font-size: 1.3rem; }
        .check-confirm { display: flex; gap: 20px; align-items: center; }
    </style>
</head>
<body>
<div class="sidebar">
    <h2><i class="fas fa-chalkboard-teacher"></i> Registro MEP</h2>
    <nav id="menuNav">
        <button data-tab="tab1" class="active"><i class="fas fa-cog"></i> Configuraci√≥n</button>
        <button data-tab="tab2"><i class="fas fa-users"></i> Grupos y Estud.</button>
        <button data-tab="tab3"><i class="fas fa-star"></i> Evaluaci√≥n</button>
        <button data-tab="tab4"><i class="fas fa-tasks"></i> Instrumentos</button>
        <button data-tab="tab5"><i class="fas fa-calendar-check"></i> Asistencia</button>
        <button data-tab="tab6"><i class="fas fa-book-open"></i> Bit√°cora</button>
        <button data-tab="tab7"><i class="fas fa-chart-bar"></i> Reportes x Periodo</button>
        <button data-tab="tab8"><i class="fas fa-file-certificate"></i> Acta Final</button>
        <button data-tab="tab9"><i class="fas fa-database"></i> Respaldos</button>
    </nav>
    <div style="margin-top: auto; padding-top: 2rem; font-size:0.9rem; color:#8aa9c4;"><i class="fas fa-sync-alt"></i> auto-guardado</div>
</div>
<div class="main-content">
    <div class="header-bar">
        <h1><i class="fas fa-clipboard-list"></i> <span id="current-institucion">Instituci√≥n por defecto</span></h1>
        <div class="modo-toggle" id="toggleModo"><i class="fas fa-moon"></i> Modo oscuro</div>
    </div>
    <!-- PANELES -->
    <div id="tab1" class="tab-panel active"> <div class="card"><h3>‚öôÔ∏è Configuraci√≥n General</h3><div class="grid-2"><div><label>Instituci√≥n actual</label><input id="institucionNombre" placeholder="Nombre"></div><div><label>Logo (URL)</label><input id="institucionLogo" placeholder="https://..."></div></div><button class="btn btn-primary" id="guardarInstitucion"><i class="fas fa-save"></i> Guardar instituci√≥n</button><hr style="margin:2rem 0"><h4>Periodos y porcentajes</h4><div id="periodosContainer"></div><button class="btn btn-sm" id="agregarPeriodo"><i class="fas fa-plus"></i> Nuevo periodo</button><button class="btn btn-primary" id="guardarPorcentajes" style="margin-left:1rem"><i class="fas fa-check"></i> Validar y guardar</button><div class="alert-warning" style="margin-top:2rem" id="totalPorcentajesDisplay">Total suma: 0% (debe ser 100%)</div></div></div>
    <div id="tab2" class="tab-panel"> <div class="card"><h3>üìö Grupos y Estudiantes</h3><div class="barra-acciones"><button class="btn" id="btnNuevoGrupo"><i class="fas fa-layer-group"></i> Nuevo grupo</button><button class="btn" id="btnImportarCSV"><i class="fas fa-file-import"></i> Importar CSV</button><button class="btn" id="btnExportarCSVEst"><i class="fas fa-download"></i> Exportar CSV</button></div><div id="gruposList"></div></div></div>
    <div id="tab3" class="tab-panel"> <div class="card"><h3>üìù Registro de Componentes</h3><select id="evalGrupoSelect"><option>-- Seleccionar grupo --</option></select><select id="evalEstudianteSelect"><option>-- Estudiante --</option></select><div id="notasForm"></div><button class="btn btn-primary" id="guardarNotas"><i class="fas fa-calculator"></i> Calcular y guardar</button></div></div>
    <div id="tab4" class="tab-panel"> <div class="card"><h3>üìã Instrumentos (r√∫bricas, listas...)</h3><div class="barra-acciones"><button class="btn" id="nuevoInstrumento"><i class="fas fa-plus"></i> Nuevo</button><button class="btn" id="duplicarInstrumento"><i class="fas fa-copy"></i> Duplicar</button></div><div id="instrumentosList"></div></div></div>
    <div id="tab5" class="tab-panel"> <div class="card"><h3>üìÖ Asistencia</h3><select id="asistGrupo"><option>-- Grupo --</option></select><div id="calendarioAsistencia"></div><button class="btn" id="generarAlertaWA"><i class="fab fa-whatsapp"></i> Alerta WhatsApp</button></div></div>
    <div id="tab6" class="tab-panel"> <div class="card"><h3>üìì Bit√°cora Docente</h3><button class="btn" id="nuevaEntradaBitacora"><i class="fas fa-pen"></i> Nueva entrada</button><input placeholder="Buscar por palabra" id="buscarBitacora"><div id="bitacoraEntries"></div></div></div>
    <div id="tab7" class="tab-panel"> <div class="card"><h3>üìä Reportes por Periodo</h3><select id="reportePeriodo"><option>I Periodo</option><option>II Periodo</option><option>III Periodo</option></select><button class="btn" id="generarReporteIndiv"><i class="fas fa-file-pdf"></i> Informe individual</button><button class="btn" id="exportarReporteWord">Word</button><button class="btn" id="exportarReporteCSV">CSV</button></div></div>
    <div id="tab8" class="tab-panel"> <div class="card"><h3>üìú Acta Final</h3><button class="btn btn-primary" id="consolidarActa">Consolidar acta final</button><pre id="actaResultado"></pre></div></div>
    <div id="tab9" class="tab-panel"> <div class="card"><h3>üíæ Respaldo Global</h3><button class="btn" id="exportarJSON"><i class="fas fa-file-export"></i> Exportar JSON</button><button class="btn" id="importarJSONInput"><i class="fas fa-file-import"></i> Importar JSON</button><input type="file" id="importJSONFile" accept=".json" style="display:none"><button class="btn" id="exportarTodoCSV">Exportar masivo CSV</button><p>√öltima copia: <span id="fechaUltimoRespaldo">nunca</span></p></div></div>
    <div class="toast" id="toastMsg">Guardado</div>
</div>
<script>
    (function() {
        // ----- ESTADO GLOBAL -----
        let state = {
            institucion: { nombre: 'Liceo MEP Central', logo: '' },
            periodos: [{ nombre: 'I Periodo', tc: 30, tareas: 20, proyecto: 20, prueba: 30, activo: true }],
            grupos: [],            // id, nombre, nivel, estudiantes[]
            instrumentos: [],      // id, nombre, tipo, contenido
            bitacora: [],
            asistencia: [],        // { fecha, grupoId, estudianteId, estado }
            configPorcentajes: { tc:30, tareas:20, proyecto:20, prueba:30 }
        };

        // ----- LOCALSTORAGE -----
        function loadState() { try { let s = localStorage.getItem('mepRegistro'); if(s) state = JSON.parse(s); } catch(e){} }
        function saveState(mostrar=true) { localStorage.setItem('mepRegistro', JSON.stringify(state)); if(mostrar) toast('‚úÖ Guardado autom√°tico'); actualizarInterfaz(); }
        loadState();

        // ----- TOAST y confirmaciones -----
        function toast(msg) { let t = document.getElementById('toastMsg'); t.style.display = 'block'; t.innerText = msg; setTimeout(()=>t.style.display='none',2000); }
        function confirmar(msg) { return window.confirm(msg); }

        // ----- ACTUALIZAR VISTAS SEG√öN PESTA√ëA ACTIVA -----
        function actualizarInterfaz() {
            document.getElementById('institucionNombre').value = state.institucion.nombre;
            document.getElementById('institucionLogo').value = state.institucion.logo || '';
            document.getElementById('current-institucion').innerText = state.institucion.nombre;
            renderPeriodos();
            renderGrupos();
            renderInstrumentos();
            renderBitacora();
            llenarSelectores();
            totalPorcentajesDisplay();
        }

        // ----- PESTA√ëAS -----
        document.querySelectorAll('#menuNav button').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('#menuNav button').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
                document.getElementById(btn.dataset.tab).classList.add('active');
            });
        });

        // MODO OSCURO
        document.getElementById('toggleModo').addEventListener('click', ()=>{
            document.body.classList.toggle('dark');
        });

        // ---- CONFIGURACI√ìN: Periodos y porcentajes ----
        function renderPeriodos() {
            let container = document.getElementById('periodosContainer');
            let html = '';
            state.periodos.forEach((p, idx) => {
                html += `<div style="border:1px solid var(--border); padding:1rem; margin-bottom:1rem; border-radius:20px">
                    <input type="text" value="${p.nombre}" placeholder="Nombre periodo" data-idx="${idx}" class="periodoNombre">
                    <div style="display:flex; gap:10px; flex-wrap:wrap">
                        <label>T.Cotidiano <input type="number" class="periodoTc" data-idx="${idx}" value="${p.tc}" min="0" max="100"></label>
                        <label>Tareas <input type="number" class="periodoTareas" data-idx="${idx}" value="${p.tareas}" min="0" max="100"></label>
                        <label>Proyecto <input type="number" class="periodoProyecto" data-idx="${idx}" value="${p.proyecto}" min="0" max="100"></label>
                        <label>Prueba <input type="number" class="periodoPrueba" data-idx="${idx}" value="${p.prueba}" min="0" max="100"></label>
                    </div>
                    <button class="btn btn-sm btn-danger eliminarPeriodo" data-idx="${idx}"><i class="fas fa-trash"></i></button>
                </div>`;
            });
            container.innerHTML = html;
            document.querySelectorAll('.eliminarPeriodo').forEach(b => b.addEventListener('click', (e) => {
                if(confirmar('Eliminar periodo?')) {
                    let idx = e.target.closest('button').dataset.idx;
                    state.periodos.splice(idx,1);
                    saveState();
                }
            }));
        }
        document.getElementById('agregarPeriodo').addEventListener('click', ()=>{
            state.periodos.push({ nombre:'Nuevo periodo', tc:25, tareas:25, proyecto:25, prueba:25, activo:true });
            saveState();
        });
        document.getElementById('guardarPorcentajes').addEventListener('click', ()=>{
            let suma = 0;
            document.querySelectorAll('.periodoTc').forEach(inp => { let idx=inp.dataset.idx; state.periodos[idx].tc = parseInt(inp.value)||0; });
            document.querySelectorAll('.periodoTareas').forEach(inp => { let idx=inp.dataset.idx; state.periodos[idx].tareas = parseInt(inp.value)||0; });
            document.querySelectorAll('.periodoProyecto').forEach(inp => { let idx=inp.dataset.idx; state.periodos[idx].proyecto = parseInt(inp.value)||0; });
            document.querySelectorAll('.periodoPrueba').forEach(inp => { let idx=inp.dataset.idx; state.periodos[idx].prueba = parseInt(inp.value)||0; });
            document.querySelectorAll('.periodoNombre').forEach(inp => { let idx=inp.dataset.idx; state.periodos[idx].nombre = inp.value; });
            state.periodos.forEach(p => { suma += (p.tc+p.tareas+p.proyecto+p.prueba); });
            if(suma !== 100) { alert('‚ùå La suma de porcentajes debe ser 100% actual: '+suma+'%'); return; }
            saveState(); toast('Porcentajes validados');
        });
        function totalPorcentajesDisplay() { if(state.periodos[0]) { let s = state.periodos[0].tc+state.periodos[0].tareas+state.periodos[0].proyecto+state.periodos[0].prueba; document.getElementById('totalPorcentajesDisplay').innerText = `Total suma: ${s}%`; } }
        document.getElementById('guardarInstitucion').addEventListener('click', ()=>{
            state.institucion.nombre = document.getElementById('institucionNombre').value;
            state.institucion.logo = document.getElementById('institucionLogo').value;
            saveState();
        });

        // ----- GRUPOS Y ESTUDIANTES -----
        function renderGrupos() {
            let div = document.getElementById('gruposList');
            let html = '';
            state.grupos.forEach((g, idxg) => {
                html += `<div style="background:var(--accent-light); padding:1rem; border-radius:28px; margin-bottom:1rem;">
                    <div><strong>${g.nombre} (${g.nivel})</strong> <button class="btn-sm" onclick="editarGrupo(${idxg})"><i class="fas fa-edit"></i></button> <button class="btn-sm btn-danger" onclick="eliminarGrupo(${idxg})"><i class="fas fa-trash"></i></button></div>
                    <table class="table"><tr><th>Estudiante</th><th>Contacto</th><th>ACS</th><th>Acciones</th></tr>`;
                (g.estudiantes||[]).forEach((e, idxe) => {
                    html += `<tr><td>${e.nombre}</td><td>${e.telefono || ''}</td><td>${e.acs ? 'ACS' : 'No'}</td>
                        <td><i class="fas fa-edit" onclick="editarEstudiante(${idxg},${idxe})"></i> <i class="fas fa-trash" onclick="eliminarEstudiante(${idxg},${idxe})"></i></td></tr>`;
                });
                html += `</table><button class="btn btn-sm" onclick="agregarEstudiante(${idxg})"><i class="fas fa-user-plus"></i> A√±adir estudiante</button>`;
                html += `</div>`;
            });
            div.innerHTML = html;
        }
        window.eliminarGrupo = (idx) => { if(confirmar('Eliminar grupo?')){ state.grupos.splice(idx,1); saveState(); }};
        window.editarGrupo = (idx) => { let n = prompt('Nombre grupo', state.grupos[idx].nombre); if(n) state.grupos[idx].nombre = n; saveState(); };
        window.agregarEstudiante = (idxg) => { let nom = prompt('Nombre completo'); if(nom) { if(!state.grupos[idxg].estudiantes) state.grupos[idxg].estudiantes = []; state.grupos[idxg].estudiantes.push({ id: Date.now()+Math.random(), nombre: nom, telefono:'', correo:'', acs: false, observaciones:'' }); saveState(); } };
        window.eliminarEstudiante = (idxg, idxe) => { if(confirmar('Eliminar estudiante?')){ state.grupos[idxg].estudiantes.splice(idxe,1); saveState(); }};
        window.editarEstudiante = (idxg, idxe) => { let e = state.grupos[idxg].estudiantes[idxe]; let nn = prompt('Nombre', e.nombre); if(nn) e.nombre = nn; e.acs = confirm('¬øAdecuaci√≥n curricular (ACS)?'); saveState(); };
        document.getElementById('btnNuevoGrupo').addEventListener('click', ()=>{
            let nom = prompt('Nombre del grupo (ej: 7-1)'); if(nom) { state.grupos.push({ id: Date.now(), nombre: nom, nivel: 'secundaria', estudiantes: [] }); saveState(); }
        });
        // CSV simple (simulado)
        document.getElementById('btnExportarCSVEst').addEventListener('click', ()=>{
            let csv = "Grupo,Nombre,Telefono,Correo,ACS\n";
            state.grupos.forEach(g => g.estudiantes?.forEach(e => csv+=`${g.nombre},${e.nombre},${e.telefono||''},${e.correo||''},${e.acs?1:0}\n`));
            let blob = new Blob([csv],{type:'text/csv'}); const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='estudiantes.csv'; a.click();
        });

        // ----- EVALUACI√ìN (notas) -----
        function llenarSelectores() {
            let selGrupo = document.getElementById('evalGrupoSelect');
            if(selGrupo) { selGrupo.innerHTML = '<option>-- Grupo --</option>' + state.grupos.map((g,i)=>`<option value="${i}">${g.nombre}</option>`).join(''); }
        }
        document.getElementById('evalGrupoSelect')?.addEventListener('change', (e) => {
            let idx = e.target.value; if(idx==='') return;
            let estSelect = document.getElementById('evalEstudianteSelect');
            let estudiantes = state.grupos[idx]?.estudiantes || [];
            estSelect.innerHTML = '<option>-- Estudiante --</option>' + estudiantes.map((es,i)=>`<option value="${i}">${es.nombre}</option>`).join('');
        });
        document.getElementById('guardarNotas').addEventListener('click', ()=>{
            let gIdx = document.getElementById('evalGrupoSelect').value;
            let eIdx = document.getElementById('evalEstudianteSelect').value;
            if(gIdx==='' || eIdx==='') return alert('Seleccione grupo y estudiante');
            let estudiante = state.grupos[gIdx].estudiantes[eIdx];
            if(!estudiante.notas) estudiante.notas = {};
            let p = state.periodos[0]; // periodo base
            let tc = parseFloat(prompt('Trabajo Cotidiano (0-100)', estudiante.notas.tc || '0')) || 0;
            let tareas = parseFloat(prompt('Tareas', estudiante.notas.tareas || '0')) || 0;
            let proyecto = parseFloat(prompt('Proyecto', estudiante.notas.proyecto || '0')) || 0;
            let prueba = parseFloat(prompt('Prueba', estudiante.notas.prueba || '0')) || 0;
            if(tc>100||tareas>100||proyecto>100||prueba>100) return alert('M√°x 100');
            estudiante.notas = { tc, tareas, proyecto, prueba };
            // c√°lculo ponderado
            let ponderado = (tc * p.tc/100) + (tareas * p.tareas/100) + (proyecto * p.proyecto/100) + (prueba * p.prueba/100);
            estudiante.promedioPeriodo = ponderado.toFixed(2);
            saveState(); alert('Notas guardadas. Promedio: '+estudiante.promedioPeriodo);
        });

        // ----- INSTRUMENTOS (simplificado) -----
        function renderInstrumentos() {
            let cont = document.getElementById('instrumentosList');
            let html = state.instrumentos.map((ins,i)=>`<div style="padding:0.5rem">${ins.nombre} (${ins.tipo}) <i class="fas fa-copy" onclick="duplicarInst(${i})"></i> <i class="fas fa-trash" onclick="eliminarInst(${i})"></i></div>`).join('');
            cont.innerHTML = html || '<p>Sin instrumentos</p>';
        }
        window.eliminarInst = (i) => { if(confirmar('Eliminar?')){ state.instrumentos.splice(i,1); saveState(); } };
        window.duplicarInst = (i) => { let copia = {...state.instrumentos[i], id:Date.now()}; state.instrumentos.push(copia); saveState(); };
        document.getElementById('nuevoInstrumento').addEventListener('click', ()=>{
            let nombre = prompt('Nombre del instrumento'); if(!nombre) return;
            let tipo = prompt('Tipo: rubrica, lista, escala', 'rubrica');
            state.instrumentos.push({ id:Date.now(), nombre, tipo, contenido:{} });
            saveState();
        });

        // ----- BIT√ÅCORA -----
        function renderBitacora() {
            let div = document.getElementById('bitacoraEntries');
            let filtro = document.getElementById('buscarBitacora')?.value?.toLowerCase() || '';
            let items = state.bitacora.filter(b => !filtro || b.tema?.toLowerCase().includes(filtro)).map(b => `<div style="border-bottom:1px solid var(--border); padding:0.8rem"><strong>${b.fecha}</strong> ${b.tema} - ${b.actividad}</div>`).join('');
            if(div) div.innerHTML = items || '<p>No hay entradas</p>';
        }
        document.getElementById('nuevaEntradaBitacora')?.addEventListener('click', ()=>{
            let fecha = prompt('Fecha (YYYY-MM-DD)', new Date().toISOString().slice(0,10));
            let tema = prompt('Tema');
            let actividad = prompt('Actividad');
            if(tema) { state.bitacora.push({ fecha, tema, actividad, observaciones:'' }); saveState(); }
        });
        document.getElementById('buscarBitacora')?.addEventListener('input', renderBitacora);

        // ----- ASISTENCIA (esqueleto) -----
        document.getElementById('generarAlertaWA')?.addEventListener('click', ()=>{
            let msg = 'Alerta de ausentismo: su hijo ha faltado a clases. Por favor contactar.';
            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`);
        });

        // ----- ACTA FINAL -----
        document.getElementById('consolidarActa')?.addEventListener('click', ()=>{
            let acta = 'ACTA FINAL MEP\n';
            state.grupos.forEach(g => { acta += `\nGrupo: ${g.nombre}\n`; g.estudiantes?.forEach(e => { let prom = e.promedioPeriodo || '--'; let cond = prom>=65? 'Aprobado' : (prom>0?'Convocatoria':'Reprobado'); acta += `${e.nombre}: ${prom} - ${cond}\n`; }); });
            document.getElementById('actaResultado').innerText = acta;
        });

        // ----- RESPALDO JSON -----
        document.getElementById('exportarJSON').addEventListener('click', ()=>{
            let dataStr = JSON.stringify(state, null, 2);
            let blob = new Blob([dataStr],{type:'application/json'}); const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='respaldo_mep.json'; a.click();
            document.getElementById('fechaUltimoRespaldo').innerText = new Date().toLocaleString();
        });
        document.getElementById('importarJSONInput').addEventListener('click', ()=> document.getElementById('importJSONFile').click());
        document.getElementById('importJSONFile').addEventListener('change', (e)=>{
            let file = e.target.files[0]; if(!file) return;
            let reader = new FileReader();
            reader.onload = (ev) => { try { state = JSON.parse(ev.target.result); saveState(false); toast('Importado'); } catch(ex){ alert('Archivo inv√°lido'); } };
            reader.readAsText(file);
        });

        // Guardado autom√°tico peri√≥dico
        setInterval(() => saveState(false), 30000);
        window.addEventListener('beforeunload', ()=> saveState(false));

        actualizarInterfaz();
    })();
</script>
</body>
</html>
