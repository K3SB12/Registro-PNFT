<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIGD-MEP 2026 - Sistema Profesional Docente</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- jsPDF y autotable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <!-- SheetJS para Excel/CSV -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <!-- FileSaver.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background: #f0f2f5;
            overflow: hidden;
        }

        /* MODO CLARO - ALTA VISIBILIDAD */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 280px;
            height: 100vh;
            background: #ffffff;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
            border-right: 1px solid #e2e8f0;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .sidebar.open {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0 !important;
            }
            .menu-btn {
                display: flex !important;
            }
        }

        @media (min-width: 769px) {
            .sidebar {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 280px;
            }
            .menu-btn {
                display: none !important;
            }
        }

        .main-content {
            transition: margin-left 0.3s ease;
            height: 100vh;
            overflow-y: auto;
            background: #f0f2f5;
        }

        .menu-btn {
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 1100;
            background: #2563eb;
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 8px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        .overlay.active {
            display: block;
        }

        .tab-pane {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-pane.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
            margin-bottom: 1.5rem;
        }

        .dark .card {
            background: #1f2937;
            border-color: #374151;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-secondary {
            background: white;
            color: #1e293b;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: 1px solid #cbd5e1;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-secondary:hover {
            background: #f8fafc;
        }

        .btn-danger {
            background: #dc2626;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: #1e293b;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            transition: all 0.2s;
            font-size: 1rem;
            background: white;
            color: #0f172a;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
        }

        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            background: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f8fafc;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.875rem;
            border-bottom: 2px solid #e2e8f0;
            color: #0f172a;
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
            color: #1e293b;
        }

        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge-success {
            background: #dcfce7;
            color: #166534;
        }

        .badge-warning {
            background: #fef9c3;
            color: #854d0e;
        }

        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-primary {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-purple {
            background: #f3e8ff;
            color: #6b21a8;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .dark .modal-content {
            background: #1f2937;
        }

        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: #0f172a;
            color: white;
            padding: 1rem 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(200%);
            transition: transform 0.3s;
            z-index: 2100;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .toast.show {
            transform: translateY(0);
        }

        .component-chip {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            background: #f1f5f9;
            border-radius: 9999px;
            font-size: 0.875rem;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            border: 1px solid #cbd5e1;
            color: #0f172a;
            font-weight: 500;
        }

        .component-chip.active {
            background: #dbeafe;
            border-color: #2563eb;
            color: #1e40af;
        }

        /* ===== INSTRUMENTOS MEP ===== */
        .instrumento-mep-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.2s;
            cursor: pointer;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .instrumento-mep-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            transform: translateY(-2px);
            border-color: #2563eb;
        }

        .dark .instrumento-mep-card {
            background: #1f2937;
            border-color: #374151;
        }

        .instrumento-tipo-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .tipo-rubrica { background: #f3e8ff; color: #6b21a8; }
        .tipo-cotejo { background: #dbeafe; color: #1e40af; }
        .tipo-escala { background: #fef3c7; color: #92400e; }
        .tipo-desempeno { background: #dcfce7; color: #166534; }
        .tipo-anecdotico { background: #ffe4e6; color: #9f1239; }

        .dark .tipo-rubrica { background: #581c87; color: #e9d5ff; }
        .dark .tipo-cotejo { background: #1e3a8a; color: #bfdbfe; }
        .dark .tipo-escala { background: #854d0e; color: #fef08a; }
        .dark .tipo-desempeno { background: #166534; color: #bbf7d0; }
        .dark .tipo-anecdotico { background: #9f1239; color: #fecaca; }

        .rubrica-analitica-grid {
            display: grid;
            grid-template-columns: 2fr repeat(4, 1fr);
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .rubrica-holistica-item {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .dark .rubrica-holistica-item {
            border-color: #374151;
        }

        .escala-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .dark .escala-item {
            background: #374151;
        }

        .cotejo-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.5rem;
            border-bottom: 1px dashed #e2e8f0;
        }

        .dark .cotejo-item {
            border-bottom-color: #374151;
        }

        .anecdotico-form {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1.5rem;
            background: #f9fafb;
        }

        .dark .anecdotico-form {
            background: #374151;
            border-color: #4b5563;
        }

        .nivel-desempeno {
            display: inline-block;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            text-align: center;
            line-height: 24px;
            font-weight: bold;
            margin-right: 0.5rem;
        }

        .nivel-1 { background: #fee2e2; color: #991b1b; }
        .nivel-2 { background: #fed7aa; color: #92400e; }
        .nivel-3 { background: #fef9c3; color: #854d0e; }
        .nivel-4 { background: #d9f99d; color: #3f6212; }
        .nivel-5 { background: #bbf7d0; color: #14532d; }

        .dark .nivel-1 { background: #7f1d1d; color: #fecaca; }
        .dark .nivel-2 { background: #7f1d1d; color: #fed7aa; }
        .dark .nivel-3 { background: #713f12; color: #fef08a; }
        .dark .nivel-4 { background: #14532d; color: #d9f99d; }
        .dark .nivel-5 { background: #14532d; color: #bbf7d0; }

        .tabla-indicadores-preview {
            font-size: 0.875rem;
            border-collapse: collapse;
            width: 100%;
        }

        .tabla-indicadores-preview th {
            background: #f1f5f9;
            padding: 0.5rem;
            text-align: left;
            font-weight: 600;
            border: 1px solid #cbd5e1;
        }

        .dark .tabla-indicadores-preview th {
            background: #374151;
            border-color: #4b5563;
        }

        .tabla-indicadores-preview td {
            padding: 0.5rem;
            border: 1px solid #cbd5e1;
        }

        .dark .tabla-indicadores-preview td {
            border-color: #4b5563;
        }

        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Modo oscuro general */
        .dark body {
            background: #1a1a1a;
            color: #e5e5e5;
        }

        .dark .main-content {
            background: #1a1a1a;
        }

        .dark .sidebar {
            background: #1f2937;
            border-right-color: #374151;
        }

        .dark .card {
            background: #2d2d2d;
            border-color: #404040;
        }

        .dark .form-input, .dark .form-select {
            background: #3d3d3d;
            border-color: #4a4a4a;
            color: #e5e5e5;
        }

        .dark .table-container {
            background: #2d2d2d;
            border-color: #404040;
        }

        .dark th {
            background: #333333;
            color: #ffffff;
            border-bottom-color: #4b5563;
        }

        .dark td {
            border-bottom-color: #404040;
            color: #e5e5e5;
        }

        .dark .btn-secondary {
            background: #3d3d3d;
            border-color: #4a4a4a;
            color: #e5e5e5;
        }

        .dark .btn-secondary:hover {
            background: #4a4a4a;
        }

        .dark .component-chip {
            background: #333333;
            border-color: #4a4a4a;
            color: #e5e5e5;
        }

        .dark .component-chip.active {
            background: #1e3a5f;
            border-color: #3b82f6;
            color: white;
        }

        .dark .badge-success {
            background: #14532d;
            color: #bbf7d0;
        }

        .dark .badge-warning {
            background: #713f12;
            color: #fef08a;
        }

        .dark .badge-danger {
            background: #7f1d1d;
            color: #fecaca;
        }

        .dark .badge-primary {
            background: #1e3a8a;
            color: #bfdbfe;
        }
    </style>
</head>
<body class="bg-gray-50">

    <!-- Bot贸n men煤 hamburguesa -->
    <button class="menu-btn" onclick="toggleMenu()" id="menuBtn">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Overlay -->
    <div class="overlay" id="overlay" onclick="closeMenu()"></div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <!-- Logo -->
        <div class="p-6 bg-gradient-to-r from-blue-700 to-blue-600 text-white">
            <h1 class="text-2xl font-bold">SIGD-MEP 2026</h1>
            <p class="text-sm opacity-90">Sistema Profesional Docente</p>
        </div>

        <!-- Navegaci贸n -->
        <nav class="p-4">
            <button onclick="showTab('instituciones')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-blue-50 dark:hover:bg-gray-700 mb-1 flex items-center gap-3 text-gray-700 dark:text-gray-300">
                <i class="fas fa-school w-6 text-blue-600"></i>
                <span> Instituciones</span>
            </button>
            <button onclick="showTab('grupos')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-blue-50 dark:hover:bg-gray-700 mb-1 flex items-center gap-3 text-gray-700 dark:text-gray-300">
                <i class="fas fa-users w-6 text-green-600"></i>
                <span> Grupos</span>
            </button>
            <button onclick="showTab('estudiantes')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-blue-50 dark:hover:bg-gray-700 mb-1 flex items-center gap-3 text-gray-700 dark:text-gray-300">
                <i class="fas fa-user-graduate w-6 text-purple-600"></i>
                <span> Estudiantes</span>
            </button>
            <button onclick="showTab('configuracionEvaluacion')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-blue-50 dark:hover:bg-gray-700 mb-1 flex items-center gap-3 text-gray-700 dark:text-gray-300">
                <i class="fas fa-sliders-h w-6 text-orange-600"></i>
                <span>锔 Config. Evaluaci贸n</span>
            </button>
            <button onclick="showTab('evaluacion')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-blue-50 dark:hover:bg-gray-700 mb-1 flex items-center gap-3 text-gray-700 dark:text-gray-300">
                <i class="fas fa-calculator w-6 text-indigo-600"></i>
                <span> Evaluaci贸n</span>
            </button>
            <button onclick="showTab('instrumentos')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-blue-50 dark:hover:bg-gray-700 mb-1 flex items-center gap-3 text-gray-700 dark:text-gray-300">
                <i class="fas fa-clipboard-list w-6 text-red-600"></i>
                <span> Instrumentos</span>
            </button>
            <button onclick="showTab('asistencia')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-blue-50 dark:hover:bg-gray-700 mb-1 flex items-center gap-3 text-gray-700 dark:text-gray-300">
                <i class="fas fa-calendar-check w-6 text-teal-600"></i>
                <span> Asistencia</span>
            </button>
            <button onclick="showTab('bitacora')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-blue-50 dark:hover:bg-gray-700 mb-1 flex items-center gap-3 text-gray-700 dark:text-gray-300">
                <i class="fas fa-book w-6 text-pink-600"></i>
                <span> Bit谩cora</span>
            </button>
            <button onclick="showTab('reportes')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-blue-50 dark:hover:bg-gray-700 mb-1 flex items-center gap-3 text-gray-700 dark:text-gray-300">
                <i class="fas fa-chart-bar w-6 text-amber-600"></i>
                <span> Reportes</span>
            </button>
            <button onclick="showTab('acta')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-blue-50 dark:hover:bg-gray-700 mb-1 flex items-center gap-3 text-gray-700 dark:text-gray-300">
                <i class="fas fa-file-signature w-6 text-rose-600"></i>
                <span> Acta Final</span>
            </button>
            <button onclick="showTab('respaldo')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-blue-50 dark:hover:bg-gray-700 mb-1 flex items-center gap-3 text-gray-700 dark:text-gray-300">
                <i class="fas fa-database w-6 text-gray-600"></i>
                <span> Respaldo</span>
            </button>
        </nav>

        <!-- Footer -->
        <div class="absolute bottom-0 w-full p-4 border-t bg-white dark:bg-gray-800">
            <button onclick="toggleDarkMode()" class="w-full flex items-center px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg text-gray-700 dark:text-gray-300">
                <i class="fas fa-moon w-6 text-gray-600 dark:text-gray-400" id="darkModeIcon"></i>
                <span id="darkModeText">Modo Oscuro</span>
            </button>
            <button onclick="ejecutarPruebas()" class="w-full flex items-center px-4 py-2 text-sm text-blue-600 hover:bg-blue-50 dark:hover:bg-gray-700 rounded-lg mt-2">
                <i class="fas fa-vial w-6"></i>
                <span>Pruebas del Sistema</span>
            </button>
        </div>
    </aside>

    <!-- Contenido Principal -->
    <main class="main-content" id="mainContent">
        <!-- Header -->
        <header class="bg-white shadow-sm px-6 py-4 flex items-center justify-between sticky top-0 z-40 border-b dark:bg-gray-800 dark:border-gray-700">
            <h2 id="pageTitle" class="text-xl font-bold text-gray-800 dark:text-white">Instituciones</h2>
            <div class="flex items-center gap-4">
                <button onclick="mostrarAlertas()" class="relative p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full">
                    <i class="fas fa-bell text-xl text-gray-600 dark:text-gray-400"></i>
                    <span id="alertBadge" class="absolute top-0 right-0 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
                </button>
                <span id="currentDate" class="text-sm text-gray-600 dark:text-gray-400"></span>
            </div>
        </header>

        <!-- Contenido -->
        <div class="p-6">
            <!-- INSTITUCIONES -->
            <div id="instituciones" class="tab-pane active">
                <div class="card">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-bold text-gray-800 dark:text-white">Mis Instituciones Educativas</h3>
                        <button onclick="abrirModalInstitucion()" class="btn-primary">
                            <i class="fas fa-plus"></i> Nueva Instituci贸n
                        </button>
                    </div>
                    
                    <div id="institucionesLista" class="space-y-4"></div>
                </div>
            </div>

            <!-- GRUPOS -->
            <div id="grupos" class="tab-pane">
                <div class="card">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-bold text-gray-800 dark:text-white">Grupos por Instituci贸n</h3>
                        <button onclick="abrirModalGrupo()" class="btn-primary">
                            <i class="fas fa-plus"></i> Nuevo Grupo
                        </button>
                    </div>
                    
                    <div class="mb-4">
                        <label class="form-label dark:text-gray-300">Seleccione Instituci贸n</label>
                        <select id="filtroInstitucionGrupos" class="form-select" onchange="cargarGruposPorInstitucion()">
                            <option value="">Todas las instituciones</option>
                        </select>
                    </div>
                    
                    <div id="gruposLista" class="space-y-4"></div>
                </div>
            </div>

            <!-- ESTUDIANTES -->
            <div id="estudiantes" class="tab-pane">
                <div class="card">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-bold text-gray-800 dark:text-white">Estudiantes</h3>
                        <button onclick="abrirModalEstudiante()" class="btn-primary">
                            <i class="fas fa-plus"></i> Nuevo Estudiante
                        </button>
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label class="form-label dark:text-gray-300">Instituci贸n</label>
                            <select id="filtroInstitucionEstudiantes" class="form-select" onchange="cargarGruposParaEstudiantes()">
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label dark:text-gray-300">Grupo</label>
                            <select id="filtroGrupoEstudiantes" class="form-select" onchange="cargarEstudiantesPorGrupo()">
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th class="dark:text-white">#</th>
                                    <th class="dark:text-white">Nombre</th>
                                    <th class="dark:text-white">Tel茅fono</th>
                                    <th class="dark:text-white">Condici贸n</th>
                                    <th class="dark:text-white">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="estudiantesTabla"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- CONFIGURACIN DE EVALUACIN -->
            <div id="configuracionEvaluacion" class="tab-pane">
                <div class="card">
                    <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-6">Configuraci贸n de Evaluaci贸n por Asignatura</h3>
                    
                    <div class="grid md:grid-cols-3 gap-4 mb-6">
                        <div>
                            <label class="form-label dark:text-gray-300">Instituci贸n</label>
                            <select id="configEvalInstitucion" class="form-select" onchange="cargarGruposConfigEvaluacion()">
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label dark:text-gray-300">Grupo</label>
                            <select id="configEvalGrupo" class="form-select" onchange="cargarAsignaturasConfigEvaluacion()">
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label dark:text-gray-300">Asignatura</label>
                            <select id="configEvalAsignatura" class="form-select" onchange="cargarConfiguracionExistente()">
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                    </div>

                    <div id="configEvalPanel" class="hidden border-t pt-6 dark:border-gray-700">
                        <h4 class="font-semibold mb-4 dark:text-white">Componentes de Evaluaci贸n</h4>
                        
                        <div id="componentesConfigLista" class="space-y-3 mb-6"></div>
                        
                        <div class="flex justify-between items-center p-4 bg-blue-50 dark:bg-blue-900 rounded-lg mb-4">
                            <span class="font-medium dark:text-white">Total porcentajes:</span>
                            <span id="totalPorcentaje" class="text-2xl font-bold text-gray-800 dark:text-white">0%</span>
                        </div>

                        <div class="flex gap-3">
                            <button onclick="guardarConfiguracionEvaluacion()" class="btn-primary">
                                <i class="fas fa-save"></i> Guardar Configuraci贸n
                            </button>
                            <button onclick="cargarPlantillaPorAsignatura()" class="btn-secondary">
                                <i class="fas fa-magic"></i> Cargar Plantilla MEP
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- EVALUACIN -->
            <div id="evaluacion" class="tab-pane">
                <div class="card">
                    <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-6">Registro de Evaluaci贸n</h3>
                    
                    <div class="grid md:grid-cols-3 gap-4 mb-6">
                        <div>
                            <label class="form-label dark:text-gray-300">Instituci贸n</label>
                            <select id="evalInstitucion" class="form-select" onchange="cargarGruposEvaluacion()">
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label dark:text-gray-300">Grupo</label>
                            <select id="evalGrupo" class="form-select" onchange="cargarAsignaturasEvaluacion()">
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label dark:text-gray-300">Asignatura</label>
                            <select id="evalAsignatura" class="form-select" onchange="cargarConfiguracionParaEvaluacion()">
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label dark:text-gray-300">Periodo</label>
                            <select id="evalPeriodo" class="form-select">
                                <option value="I">Periodo I</option>
                                <option value="II">Periodo II</option>
                                <option value="III">Periodo III</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button onclick="cargarTablaEvaluacion()" class="btn-primary w-full">
                                <i class="fas fa-search"></i> Cargar
                            </button>
                        </div>
                    </div>

                    <div id="componentesContainer" class="mb-6 p-4 bg-blue-50 dark:bg-blue-900 rounded-lg border border-blue-200 dark:border-blue-800">
                        <p class="font-semibold text-blue-800 dark:text-blue-200 mb-2"> Componentes configurados:</p>
                        <div id="componentesLista" class="flex flex-wrap"></div>
                    </div>

                    <div id="evaluacionTableContainer" class="hidden">
                        <div class="table-container">
                            <table>
                                <thead id="evalTableHeader">
                                    <tr>
                                        <th class="dark:text-white">Estudiante</th>
                                        <th class="dark:text-white">Condici贸n</th>
                                    </tr>
                                </thead>
                                <tbody id="evaluacionTableBody"></tbody>
                            </table>
                        </div>
                        
                        <div class="mt-4 flex justify-between items-center p-4 bg-blue-50 dark:bg-blue-900 rounded-lg">
                            <div>
                                <p class="text-sm font-medium text-gray-800 dark:text-white">Promedio del Grupo: <span id="promedioGrupo" class="text-2xl font-bold">0.00</span></p>
                            </div>
                            <button onclick="guardarNotas()" class="btn-primary">
                                <i class="fas fa-save"></i> Guardar Notas
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- INSTRUMENTOS - VERSIN MEP -->
            <div id="instrumentos" class="tab-pane">
                <div class="card">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-bold text-gray-800 dark:text-white">Instrumentos de Evaluaci贸n - MEP</h3>
                        <button onclick="abrirModalInstrumentoMEP()" class="btn-primary">
                            <i class="fas fa-plus"></i> Nuevo Instrumento
                        </button>
                    </div>

                    <!-- Filtros -->
                    <div class="grid md:grid-cols-3 gap-4 mb-6">
                        <div>
                            <label class="form-label dark:text-gray-300">Tipo</label>
                            <select id="filtroInstrumentoTipo" class="form-select" onchange="filtrarInstrumentos()">
                                <option value="">Todos</option>
                                <option value="rubrica_holistica">R煤brica Hol铆stica</option>
                                <option value="rubrica_analitica">R煤brica Anal铆tica</option>
                                <option value="escala_numerica">Escala Num茅rica</option>
                                <option value="escala_descriptiva">Escala Descriptiva</option>
                                <option value="escala_desempeno">Escala de Desempe帽o</option>
                                <option value="lista_cotejo">Lista de Cotejo</option>
                                <option value="registro_desempeno">Registro de Desempe帽o</option>
                                <option value="registro_anecdotico">Registro Anecd贸tico</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label dark:text-gray-300">Asignatura</label>
                            <select id="filtroInstrumentoAsignatura" class="form-select" onchange="filtrarInstrumentos()">
                                <option value="">Todas</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label dark:text-gray-300">Buscar</label>
                            <input type="text" id="filtroInstrumentoBuscar" class="form-input" placeholder="Nombre..." onkeyup="filtrarInstrumentos()">
                        </div>
                    </div>

                    <!-- Lista de instrumentos -->
                    <div id="instrumentosLista" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                </div>
            </div>

            <!-- ASISTENCIA -->
            <div id="asistencia" class="tab-pane">
                <div class="card">
                    <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-6">Control de Asistencia</h3>
                    
                    <div class="grid md:grid-cols-3 gap-4 mb-6">
                        <div>
                            <label class="form-label dark:text-gray-300">Instituci贸n</label>
                            <select id="asistInstitucion" class="form-select" onchange="cargarGruposAsistencia()">
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label dark:text-gray-300">Grupo</label>
                            <select id="asistGrupo" class="form-select"></select>
                        </div>
                        <div>
                            <label class="form-label dark:text-gray-300">Mes</label>
                            <input type="month" id="asistMes" class="form-input" value="2026-03">
                        </div>
                        <div class="flex items-end">
                            <button onclick="cargarAsistencia()" class="btn-primary w-full">
                                <i class="fas fa-calendar-check"></i> Cargar
                            </button>
                        </div>
                    </div>

                    <div id="asistenciaContainer" class="hidden">
                        <div class="table-container">
                            <table class="border-collapse">
                                <thead id="asistenciaHeader"></thead>
                                <tbody id="asistenciaBody"></tbody>
                            </table>
                        </div>
                        <div class="mt-4 flex gap-3 text-sm">
                            <span class="badge-success px-3 py-1 rounded">P = Presente</span>
                            <span class="badge-danger px-3 py-1 rounded">A = Ausente</span>
                            <span class="badge-warning px-3 py-1 rounded">T = Tard铆a</span>
                            <span class="badge-primary px-3 py-1 rounded">J = Justificada</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- BITCORA -->
            <div id="bitacora" class="tab-pane">
                <div class="card">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-bold text-gray-800 dark:text-white">Bit谩cora Docente</h3>
                        <div class="flex gap-2">
                            <button onclick="exportarBitacoraWord()" class="btn-secondary">
                                <i class="fas fa-file-word"></i> Word
                            </button>
                            <button onclick="exportarBitacoraPDF()" class="btn-secondary">
                                <i class="fas fa-file-pdf"></i> PDF
                            </button>
                        </div>
                    </div>

                    <div class="grid md:grid-cols-2 gap-4 mb-6">
                        <input type="date" id="bitacoraFecha" class="form-input">
                        <input type="text" id="bitacoraTema" class="form-input" placeholder="Tema">
                        <input type="text" id="bitacoraActividad" class="form-input" placeholder="Actividad">
                        <input type="text" id="bitacoraAjustes" class="form-input" placeholder="Ajustes DUA">
                        <button onclick="agregarEntradaBitacora()" class="btn-primary md:col-span-2">
                            <i class="fas fa-plus"></i> Agregar Entrada
                        </button>
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th class="dark:text-white">Fecha</th>
                                    <th class="dark:text-white">Tema</th>
                                    <th class="dark:text-white">Actividad</th>
                                    <th class="dark:text-white">Ajustes DUA</th>
                                    <th class="dark:text-white">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="bitacoraTabla"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- REPORTES -->
            <div id="reportes" class="tab-pane">
                <div class="card">
                    <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-6">Reportes por Periodo</h3>
                    
                    <div class="grid md:grid-cols-3 gap-4 mb-6">
                        <div>
                            <label class="form-label dark:text-gray-300">Instituci贸n</label>
                            <select id="reportInstitucion" class="form-select" onchange="cargarGruposReportes()">
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label dark:text-gray-300">Grupo</label>
                            <select id="reportGrupo" class="form-select"></select>
                        </div>
                        <div>
                            <label class="form-label dark:text-gray-300">Periodo</label>
                            <select id="reportPeriodo" class="form-select">
                                <option value="I">Periodo I</option>
                                <option value="II">Periodo II</option>
                                <option value="III">Periodo III</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label dark:text-gray-300">Asignatura</label>
                            <select id="reportAsignatura" class="form-select">
                                <option value="">Todas</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button onclick="generarReporte()" class="btn-primary w-full">
                                <i class="fas fa-chart-bar"></i> Generar
                            </button>
                        </div>
                    </div>

                    <div id="reporteContainer" class="hidden space-y-6">
                        <div class="grid md:grid-cols-3 gap-4">
                            <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 dark:from-yellow-900 dark:to-yellow-800 p-4 rounded-lg border border-yellow-200 dark:border-yellow-700">
                                <h4 class="font-bold text-yellow-800 dark:text-yellow-200 mb-2"> Primer Lugar</h4>
                                <p id="top1" class="text-lg font-semibold text-gray-800 dark:text-white">-</p>
                                <p id="top1Nota" class="text-2xl font-bold text-yellow-700 dark:text-yellow-300">-</p>
                            </div>
                            <div class="bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-800 dark:to-gray-700 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
                                <h4 class="font-bold text-gray-800 dark:text-gray-200 mb-2"> Segundo Lugar</h4>
                                <p id="top2" class="text-lg font-semibold text-gray-800 dark:text-white">-</p>
                                <p id="top2Nota" class="text-2xl font-bold text-gray-700 dark:text-gray-300">-</p>
                            </div>
                            <div class="bg-gradient-to-br from-orange-50 to-orange-100 dark:from-orange-900 dark:to-orange-800 p-4 rounded-lg border border-orange-200 dark:border-orange-700">
                                <h4 class="font-bold text-orange-800 dark:text-orange-200 mb-2"> Tercer Lugar</h4>
                                <p id="top3" class="text-lg font-semibold text-gray-800 dark:text-white">-</p>
                                <p id="top3Nota" class="text-2xl font-bold text-orange-700 dark:text-orange-300">-</p>
                            </div>
                        </div>

                        <div class="table-container">
                            <table>
                                <thead id="reporteHeader"></thead>
                                <tbody id="reporteTabla"></tbody>
                            </table>
                        </div>

                        <div class="flex gap-3">
                            <button onclick="exportarReportePDF()" class="btn-primary">
                                <i class="fas fa-file-pdf"></i> PDF
                            </button>
                            <button onclick="exportarReporteWord()" class="btn-secondary">
                                <i class="fas fa-file-word"></i> Word
                            </button>
                            <button onclick="exportarReporteCSV()" class="btn-secondary">
                                <i class="fas fa-file-csv"></i> CSV
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ACTA FINAL -->
            <div id="acta" class="tab-pane">
                <div class="card">
                    <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-6">Acta Final de Curso Lectivo</h3>
                    
                    <div class="grid md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label class="form-label dark:text-gray-300">Instituci贸n</label>
                            <select id="actaInstitucion" class="form-select" onchange="cargarGruposActa()">
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label dark:text-gray-300">Grupo</label>
                            <select id="actaGrupo" class="form-select"></select>
                        </div>
                        <div>
                            <label class="form-label dark:text-gray-300">A帽o Lectivo</label>
                            <input type="text" id="actaAnio" class="form-input" value="2026">
                        </div>
                        <div class="flex items-end">
                            <button onclick="generarActaFinal()" class="btn-primary w-full">
                                <i class="fas fa-file-signature"></i> Generar Acta
                            </button>
                        </div>
                    </div>

                    <div id="actaContainer" class="hidden">
                        <div class="mb-4 p-4 bg-yellow-50 dark:bg-yellow-900 border border-yellow-200 dark:border-yellow-700 rounded-lg">
                            <p class="text-sm text-yellow-800 dark:text-yellow-200">
                                <i class="fas fa-info-circle mr-2"></i>
                                Seg煤n lineamientos MEP 2026: Nota final = 50% Promedio Anual + 50% PNE
                            </p>
                        </div>

                        <div class="table-container mb-6">
                            <table>
                                <thead>
                                    <tr>
                                        <th class="dark:text-white">Estudiante</th>
                                        <th class="text-center dark:text-white">I Per</th>
                                        <th class="text-center dark:text-white">II Per</th>
                                        <th class="text-center dark:text-white">III Per</th>
                                        <th class="text-center dark:text-white">Prom. Anual</th>
                                        <th class="text-center dark:text-white">PNE</th>
                                        <th class="text-center dark:text-white">Nota Final</th>
                                        <th class="text-center dark:text-white">Condici贸n</th>
                                    </tr>
                                </thead>
                                <tbody id="actaTabla"></tbody>
                            </table>
                        </div>

                        <div class="flex gap-3">
                            <button onclick="exportarActaPDF()" class="btn-primary">
                                <i class="fas fa-file-pdf"></i> PDF
                            </button>
                            <button onclick="exportarActaWord()" class="btn-secondary">
                                <i class="fas fa-file-word"></i> Word
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RESPALDO -->
            <div id="respaldo" class="tab-pane">
                <div class="max-w-4xl mx-auto space-y-6">
                    <div class="card">
                        <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-4">Respaldo y Exportaci贸n</h3>
                        
                        <div class="grid md:grid-cols-2 gap-4 mb-6">
                            <button onclick="exportarRespaldoJSON()" class="p-6 border-2 border-blue-200 dark:border-blue-800 rounded-lg hover:bg-blue-50 dark:hover:bg-blue-900 text-left">
                                <i class="fas fa-file-code text-3xl text-blue-600 dark:text-blue-400 mb-2"></i>
                                <h4 class="font-semibold text-gray-800 dark:text-white">Respaldo Completo (JSON)</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Exporta todos los datos del sistema</p>
                            </button>
                            
                            <button onclick="exportarTodoCSV()" class="p-6 border-2 border-green-200 dark:border-green-800 rounded-lg hover:bg-green-50 dark:hover:bg-green-900 text-left">
                                <i class="fas fa-file-csv text-3xl text-green-600 dark:text-green-400 mb-2"></i>
                                <h4 class="font-semibold text-gray-800 dark:text-white">Exportaci贸n Masiva (CSV)</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Exporta estudiantes y notas en CSV</p>
                            </button>
                        </div>

                        <div class="border-t dark:border-gray-700 pt-6">
                            <h4 class="font-semibold mb-4 dark:text-white">Importar Respaldo</h4>
                            <div class="flex gap-4">
                                <input type="file" id="backupInput" accept=".json" class="form-input flex-1">
                                <button onclick="importarRespaldo()" class="btn-primary">
                                    <i class="fas fa-upload"></i> Restaurar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- MODALES -->

    <!-- Modal Instituci贸n -->
    <div id="institucionModal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-4 dark:text-white">Nueva Instituci贸n</h3>
            <div class="space-y-4">
                <div>
                    <label class="form-label dark:text-gray-300">Nombre de la instituci贸n *</label>
                    <input type="text" id="instNombre" class="form-input" placeholder="Ej: Liceo de San Jos茅">
                </div>
                <div>
                    <label class="form-label dark:text-gray-300">C贸digo MEP</label>
                    <input type="text" id="instCodigo" class="form-input" placeholder="Opcional">
                </div>
                <div>
                    <label class="form-label dark:text-gray-300">Modalidad *</label>
                    <select id="instModalidad" class="form-select">
                        <option value="primaria">Primaria (1掳 a 6掳)</option>
                        <option value="secundaria">Secundaria Acad茅mica (7掳 a 12掳)</option>
                        <option value="tecnica">Colegio T茅cnico Profesional</option>
                        <option value="cindea">CINDEA / IPEC</option>
                    </select>
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button onclick="cerrarModal('institucionModal')" class="btn-secondary">Cancelar</button>
                <button onclick="guardarInstitucion()" class="btn-primary">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal Grupo -->
    <div id="grupoModal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-4 dark:text-white">Nuevo Grupo</h3>
            <div class="space-y-4">
                <div>
                    <label class="form-label dark:text-gray-300">Instituci贸n *</label>
                    <select id="grupoInstitucion" class="form-select" required>
                        <option value="">Seleccione...</option>
                    </select>
                </div>
                <div>
                    <label class="form-label dark:text-gray-300">Nombre del grupo *</label>
                    <input type="text" id="grupoNombre" class="form-input" placeholder="Ej: 7-1, 10-3, 2掳B">
                </div>
                <div>
                    <label class="form-label dark:text-gray-300">Nivel *</label>
                    <select id="grupoNivel" class="form-select" required>
                        <option value="">Seleccione...</option>
                        <option value="1">1掳 Primaria</option>
                        <option value="2">2掳 Primaria</option>
                        <option value="3">3掳 Primaria</option>
                        <option value="4">4掳 Primaria</option>
                        <option value="5">5掳 Primaria</option>
                        <option value="6">6掳 Primaria</option>
                        <option value="7">7掳 Secundaria</option>
                        <option value="8">8掳 Secundaria</option>
                        <option value="9">9掳 Secundaria</option>
                        <option value="10">10掳 Secundaria</option>
                        <option value="11">11掳 Secundaria</option>
                        <option value="12">12掳 Secundaria</option>
                    </select>
                </div>
                <div>
                    <label class="form-label dark:text-gray-300">Asignaturas (separadas por coma)</label>
                    <input type="text" id="grupoAsignaturas" class="form-input" placeholder="Ej: Matem谩tica, Espa帽ol, Ciencias">
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button onclick="cerrarModal('grupoModal')" class="btn-secondary">Cancelar</button>
                <button onclick="guardarGrupo()" class="btn-primary">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal Estudiante -->
    <div id="estudianteModal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-4 dark:text-white" id="estudianteModalTitulo">Agregar Estudiante</h3>
            <input type="hidden" id="estudianteEditId">
            <div class="space-y-4">
                <div>
                    <label class="form-label dark:text-gray-300">Instituci贸n *</label>
                    <select id="estInstitucion" class="form-select" onchange="cargarGruposParaModalEstudiante()" required>
                        <option value="">Seleccione...</option>
                    </select>
                </div>
                <div>
                    <label class="form-label dark:text-gray-300">Grupo *</label>
                    <select id="estGrupo" class="form-select" required>
                        <option value="">Seleccione...</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="form-label dark:text-gray-300">N煤mero de lista</label>
                        <input type="number" id="estNumero" class="form-input" placeholder="Opcional">
                    </div>
                    <div>
                        <label class="form-label dark:text-gray-300">Nombre completo *</label>
                        <input type="text" id="estNombre" class="form-input" placeholder="Ej: Mar铆a P茅rez">
                    </div>
                </div>
                <div>
                    <label class="form-label dark:text-gray-300">Tel茅fono encargado</label>
                    <input type="tel" id="estTelefono" class="form-input" placeholder="8888-7777">
                </div>
                <div>
                    <label class="form-label dark:text-gray-300">Correo</label>
                    <input type="email" id="estCorreo" class="form-input" placeholder="correo@ejemplo.com">
                </div>
                <div>
                    <label class="form-label dark:text-gray-300">Condici贸n</label>
                    <select id="estCondicion" class="form-select">
                        <option value="regular">Regular</option>
                        <option value="acs">ACS - Adecuaci贸n Significativa</option>
                        <option value="ns">Adecuaci贸n No Significativa</option>
                        <option value="acceso">Adecuaci贸n de Acceso</option>
                    </select>
                </div>
                <div>
                    <label class="form-label dark:text-gray-300">Observaciones</label>
                    <textarea id="estObservaciones" class="form-input" rows="2" placeholder="Notas adicionales"></textarea>
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button onclick="cerrarModal('estudianteModal')" class="btn-secondary">Cancelar</button>
                <button onclick="guardarEstudiante()" class="btn-primary">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal Instrumento (VERSIN MEP) -->
    <div id="instrumentoModal" class="modal">
        <div class="modal-content max-w-6xl">
            <h3 class="text-lg font-bold mb-4 dark:text-white" id="instrumentoModalTitulo">Crear Instrumento de Evaluaci贸n - MEP</h3>
            <input type="hidden" id="instrumentoEditId">
            
            <!-- Pesta帽as internas -->
            <div class="border-b dark:border-gray-700 mb-6">
                <div class="flex gap-4">
                    <button onclick="cambiarPestanaInstrumento('basicos')" id="pestanaBasicosBtn" class="px-4 py-2 font-medium border-b-2 border-blue-600 text-blue-600">Datos B谩sicos</button>
                    <button onclick="cambiarPestanaInstrumento('contenido')" id="pestanaContenidoBtn" class="px-4 py-2 font-medium text-gray-600 dark:text-gray-400 hover:text-blue-600">Contenido del Instrumento</button>
                    <button onclick="cambiarPestanaInstrumento('vista')" id="pestanaVistaBtn" class="px-4 py-2 font-medium text-gray-600 dark:text-gray-400 hover:text-blue-600">Vista Previa MEP</button>
                </div>
            </div>
            
            <!-- Pesta帽a: Datos B谩sicos -->
            <div id="pestanaBasicos" class="pestana-instrumento">
                <div class="grid md:grid-cols-2 gap-6">
                    <!-- Columna izquierda -->
                    <div class="space-y-4">
                        <div>
                            <label class="form-label dark:text-gray-300">Tipo de instrumento (MEP) *</label>
                            <select id="instTipo" class="form-select" onchange="cambiarTipoInstrumentoMEP()">
                                <option value="rubrica_holistica">R煤brica Hol铆stica</option>
                                <option value="rubrica_analitica">R煤brica Anal铆tica</option>
                                <option value="escala_numerica">Escala Num茅rica</option>
                                <option value="escala_descriptiva">Escala Descriptiva</option>
                                <option value="escala_desempeno">Escala de Desempe帽o</option>
                                <option value="lista_cotejo">Lista de Cotejo</option>
                                <option value="registro_desempeno">Registro de Desempe帽o</option>
                                <option value="registro_anecdotico">Registro Anecd贸tico</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="form-label dark:text-gray-300">Nombre del instrumento *</label>
                            <input type="text" id="instNombre" class="form-input" placeholder="Ej: R煤brica para evaluar exposici贸n oral">
                        </div>
                        
                        <div>
                            <label class="form-label dark:text-gray-300">Aprendizaje a evaluar</label>
                            <textarea id="instAprendizaje" class="form-input" rows="3" placeholder="Describa el aprendizaje esperado..."></textarea>
                        </div>
                        
                        <div>
                            <label class="form-label dark:text-gray-300">Asignatura</label>
                            <input type="text" id="instAsignatura" class="form-input" placeholder="Ej: Espa帽ol">
                        </div>
                    </div>
                    
                    <!-- Columna derecha -->
                    <div class="space-y-4">
                        <div>
                            <label class="form-label dark:text-gray-300">Nivel</label>
                            <select id="instNivel" class="form-select">
                                <option value="">Todos los niveles</option>
                                <option value="primaria">Primaria</option>
                                <option value="secundaria">Secundaria</option>
                                <option value="diversificada">Diversificada</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="form-label dark:text-gray-300">Puntuaci贸n total</label>
                            <input type="number" id="instPuntuacionTotal" class="form-input" value="100" min="1" max="1000">
                        </div>
                        
                        <div>
                            <label class="form-label dark:text-gray-300">Escala de calificaci贸n</label>
                            <select id="instEscala" class="form-select">
                                <option value="1-3">1-3 (Inicial - Intermedio - Avanzado)</option>
                                <option value="1-4">1-4 (Deficiente - Regular - Bueno - Excelente)</option>
                                <option value="1-5">1-5 (Muy deficiente - Deficiente - Regular - Bueno - Excelente)</option>
                                <option value="si-no">S铆 / No</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="form-label dark:text-gray-300">Aplicar a grupo</label>
                            <select id="instGrupo" class="form-select">
                                <option value="">Sin asignar (plantilla general)</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Pesta帽a: Contenido del Instrumento -->
            <div id="pestanaContenido" class="pestana-instrumento hidden">
                <div class="mb-4 p-4 bg-blue-50 dark:bg-blue-900 rounded-lg">
                    <p class="text-sm text-blue-800 dark:text-blue-200">
                        <i class="fas fa-info-circle mr-2"></i>
                        Complete los indicadores y criterios seg煤n el tipo de instrumento seleccionado.
                    </p>
                </div>
                
                <div id="contenedorIndicadores" class="space-y-4">
                    <!-- Se llena din谩micamente seg煤n el tipo -->
                </div>
                
                <div class="mt-4 flex justify-between">
                    <button type="button" onclick="agregarFilaInstrumento()" class="btn-secondary" id="btnAgregarFila">
                        <i class="fas fa-plus"></i> Agregar
                    </button>
                    
                    <div class="text-sm text-gray-600 dark:text-gray-400" id="infoIndicadores">
                        Total indicadores: <span id="totalIndicadores">0</span>
                    </div>
                </div>
            </div>
            
            <!-- Pesta帽a: Vista Previa MEP -->
            <div id="pestanaVista" class="pestana-instrumento hidden">
                <div class="border rounded-lg p-6 bg-gray-50 dark:bg-gray-800 dark:border-gray-700">
                    <!-- Parte Administrativa -->
                    <div class="mb-6">
                        <h4 class="font-bold text-gray-700 dark:text-gray-300 mb-2">PARTE ADMINISTRATIVA</h4>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <p class="dark:text-gray-300"><span class="font-medium">Centro Educativo:</span> <span id="previewCentro">_________________</span></p>
                                <p class="dark:text-gray-300"><span class="font-medium">Asignatura:</span> <span id="previewAsignatura">_________________</span></p>
                                <p class="dark:text-gray-300"><span class="font-medium">Docente:</span> <span id="previewDocente">_________________</span></p>
                            </div>
                            <div>
                                <p class="dark:text-gray-300"><span class="font-medium">Periodo:</span> <span id="previewPeriodo">_________________</span></p>
                                <p class="dark:text-gray-300"><span class="font-medium">Nivel:</span> <span id="previewNivel">_________________</span></p>
                                <p class="dark:text-gray-300"><span class="font-medium">Fecha:</span> <span id="previewFecha">_________________</span></p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Parte T茅cnica -->
                    <div>
                        <h4 class="font-bold text-gray-700 dark:text-gray-300 mb-2">PARTE TCNICA</h4>
                        <p class="text-sm mb-4 dark:text-gray-300"><span class="font-medium">Aprendizaje:</span> <span id="previewAprendizaje">_________________</span></p>
                        
                        <div id="previewInstrumento" class="mt-4">
                            <!-- Se llena din谩micamente -->
                        </div>
                    </div>
                </div>
                
                <!-- Instrucciones seg煤n MEP -->
                <div class="mt-4 p-4 bg-yellow-50 dark:bg-yellow-900 rounded-lg">
                    <h5 class="font-semibold mb-2 dark:text-yellow-200">Instrucciones generales (MEP):</h5>
                    <ul class="list-disc pl-5 text-sm space-y-1 dark:text-yellow-200">
                        <li>Lea detenidamente cada indicador antes de comenzar.</li>
                        <li>Trabaje de manera ordenada y en silencio.</li>
                        <li>Utilice los recursos y materiales autorizados por el docente.</li>
                        <li>La resoluci贸n es de manera individual.</li>
                        <li>Consulte al docente si tiene dudas sobre los criterios de evaluaci贸n.</li>
                    </ul>
                </div>
            </div>

            <!-- Botones de acci贸n -->
            <div class="mt-6 flex justify-end gap-3 border-t dark:border-gray-700 pt-4">
                <button onclick="cerrarModal('instrumentoModal')" class="btn-secondary">Cancelar</button>
                <button onclick="guardarInstrumentoMEP()" class="btn-primary">
                    <i class="fas fa-save"></i> Guardar Instrumento
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Ver Instrumento -->
    <div id="verInstrumentoModal" class="modal">
        <div class="modal-content max-w-6xl">
            <h3 class="text-lg font-bold mb-4 dark:text-white" id="verInstrumentoTitulo">Instrumento de Evaluaci贸n - MEP</h3>
            
            <div id="verInstrumentoContenido" class="space-y-6">
                <!-- Se llena din谩micamente -->
            </div>
            
            <div class="mt-6 flex justify-end gap-3 border-t dark:border-gray-700 pt-4">
                <button onclick="cerrarModal('verInstrumentoModal')" class="btn-secondary">Cerrar</button>
                <button onclick="editarInstrumentoDesdeVer()" class="btn-primary">Editar</button>
                <button onclick="exportarInstrumentoPDF()" class="btn-secondary">Exportar PDF</button>
                <button onclick="duplicarInstrumento(actualInstrumentoId)" class="btn-secondary">Duplicar</button>
            </div>
        </div>
    </div>

    <!-- Modal Alertas -->
    <div id="alertasModal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-4 flex items-center dark:text-white">
                <i class="fas fa-bell mr-2 text-yellow-500"></i>
                Alertas Tempranas
            </h3>
            <div id="alertasLista" class="space-y-3 max-h-96 overflow-y-auto"></div>
            <div class="mt-6 flex justify-end">
                <button onclick="cerrarModal('alertasModal')" class="btn-primary">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast">
        <i id="toastIcon" class="fas fa-check-circle text-green-400"></i>
        <span id="toastMessage">Operaci贸n exitosa</span>
    </div>

    <script>
        // ==================== INICIALIZACIN ====================
        const DB = {
            get: (key) => {
                try {
                    const data = localStorage.getItem(`mep_${key}`);
                    return data ? JSON.parse(data) : [];
                } catch {
                    return [];
                }
            },
            set: (key, value) => {
                localStorage.setItem(`mep_${key}`, JSON.stringify(value));
            }
        };

        // Datos globales
        let instituciones = DB.get('instituciones') || [];
        let grupos = DB.get('grupos') || [];
        let estudiantes = DB.get('estudiantes') || [];
        let notas = DB.get('notas') || {};
        let asistencia = DB.get('asistencia') || {};
        let bitacora = DB.get('bitacora') || [];
        let instrumentos = DB.get('instrumentos') || [];
        let configuracionesEvaluacion = DB.get('configuracionesEvaluacion') || {};

        // Variables para edici贸n
        let institucionEnEdicion = null;
        let grupoEnEdicion = null;
        let estudianteEnEdicion = null;
        let instrumentoEnEdicion = null;
        let actualInstrumentoId = null;
        let pestanaActiva = 'basicos';

        // ==================== PLANTILLAS MEP ====================
        const plantillasMEP = {
            primaria_academica: [
                { nombre: 'Trabajo Cotidiano', porcentaje: 50, activo: true, minimo: null },
                { nombre: 'Tareas', porcentaje: 10, activo: true, minimo: null },
                { nombre: 'Pruebas', porcentaje: 35, activo: true, minimo: 2 },
                { nombre: 'Asistencia', porcentaje: 5, activo: true, minimo: null }
            ],
            primaria_complementaria: [
                { nombre: 'Trabajo Cotidiano', porcentaje: 60, activo: true, minimo: null },
                { nombre: 'Tareas', porcentaje: 10, activo: true, minimo: null },
                { nombre: 'Pruebas', porcentaje: 25, activo: true, minimo: 1 },
                { nombre: 'Asistencia', porcentaje: 5, activo: true, minimo: null }
            ],
            primaria_artes: [
                { nombre: 'Trabajo Cotidiano', porcentaje: 60, activo: true, minimo: null },
                { nombre: 'Tareas', porcentaje: 10, activo: true, minimo: null },
                { nombre: 'Proyecto', porcentaje: 25, activo: true, minimo: 1 },
                { nombre: 'Asistencia', porcentaje: 5, activo: true, minimo: null }
            ],
            primaria_religion: [
                { nombre: 'Trabajo Cotidiano', porcentaje: 70, activo: true, minimo: null },
                { nombre: 'Tareas', porcentaje: 25, activo: true, minimo: null },
                { nombre: 'Asistencia', porcentaje: 5, activo: true, minimo: null }
            ],
            secundaria_academica: [
                { nombre: 'Trabajo Cotidiano', porcentaje: 45, activo: true, minimo: null },
                { nombre: 'Tareas', porcentaje: 10, activo: true, minimo: null },
                { nombre: 'Pruebas', porcentaje: 40, activo: true, minimo: 2 },
                { nombre: 'Asistencia', porcentaje: 5, activo: true, minimo: null }
            ],
            secundaria_complementaria: [
                { nombre: 'Trabajo Cotidiano', porcentaje: 45, activo: true, minimo: null },
                { nombre: 'Tareas', porcentaje: 10, activo: true, minimo: null },
                { nombre: 'Proyecto', porcentaje: 40, activo: true, minimo: 1 },
                { nombre: 'Asistencia', porcentaje: 5, activo: true, minimo: null }
            ],
            diversificada_academica: [
                { nombre: 'Trabajo Cotidiano', porcentaje: 35, activo: true, minimo: null },
                { nombre: 'Tareas', porcentaje: 10, activo: true, minimo: null },
                { nombre: 'Pruebas', porcentaje: 50, activo: true, minimo: 2 },
                { nombre: 'Asistencia', porcentaje: 5, activo: true, minimo: null }
            ]
        };

        // ==================== UTILIDADES ====================
        const Utils = {
            generarId: () => Date.now().toString(36) + Math.random().toString(36).substring(2),
            mostrarToast: (mensaje, tipo = 'success') => {
                const toast = document.getElementById('toast');
                const icon = document.getElementById('toastIcon');
                const msg = document.getElementById('toastMessage');
                
                msg.textContent = mensaje;
                icon.className = tipo === 'success' ? 'fas fa-check-circle text-green-400' : 
                                 tipo === 'error' ? 'fas fa-exclamation-circle text-red-400' : 
                                 'fas fa-exclamation-triangle text-yellow-400';
                
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 3000);
            },
            confirmar: (mensaje) => confirm(mensaje),
            formatearFecha: (fecha) => {
                const d = new Date(fecha);
                return d.toLocaleDateString('es-CR');
            }
        };

        // ==================== MEN ====================
        function toggleMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
        }

        function closeMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            sidebar.classList.remove('open');
            overlay.classList.remove('active');
        }

        // ==================== MODO OSCURO CORREGIDO ====================
        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            
            const icon = document.getElementById('darkModeIcon');
            const text = document.getElementById('darkModeText');
            
            if (document.documentElement.classList.contains('dark')) {
                icon.className = 'fas fa-sun w-6 text-gray-600 dark:text-gray-400';
                text.textContent = 'Modo Claro';
                localStorage.setItem('mep_darkMode', 'true');
            } else {
                icon.className = 'fas fa-moon w-6 text-gray-600 dark:text-gray-400';
                text.textContent = 'Modo Oscuro';
                localStorage.setItem('mep_darkMode', 'false');
            }
        }

        // ==================== PESTAAS ====================
        function showTab(tabId) {
            document.querySelectorAll('.tab-pane').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            
            const titles = {
                'instituciones': 'Instituciones',
                'grupos': 'Grupos',
                'estudiantes': 'Estudiantes',
                'configuracionEvaluacion': 'Configuraci贸n de Evaluaci贸n',
                'evaluacion': 'Evaluaci贸n',
                'instrumentos': 'Instrumentos',
                'asistencia': 'Asistencia',
                'bitacora': 'Bit谩cora',
                'reportes': 'Reportes',
                'acta': 'Acta Final',
                'respaldo': 'Respaldo'
            };
            document.getElementById('pageTitle').textContent = titles[tabId];
            
            if (window.innerWidth <= 768) closeMenu();
            
            // Cargar datos seg煤n pesta帽a
            if (tabId === 'instituciones') {
                renderizarInstituciones();
            } else if (tabId === 'grupos') {
                cargarInstitucionesSelect('filtroInstitucionGrupos');
                renderizarGrupos();
            } else if (tabId === 'estudiantes') {
                cargarInstitucionesSelect('filtroInstitucionEstudiantes');
            } else if (tabId === 'configuracionEvaluacion') {
                cargarInstitucionesSelect('configEvalInstitucion');
            } else if (tabId === 'evaluacion') {
                cargarInstitucionesSelect('evalInstitucion');
            } else if (tabId === 'asistencia') {
                cargarInstitucionesSelect('asistInstitucion');
            } else if (tabId === 'reportes') {
                cargarInstitucionesSelect('reportInstitucion');
            } else if (tabId === 'acta') {
                cargarInstitucionesSelect('actaInstitucion');
            } else if (tabId === 'instrumentos') {
                cargarFiltrosInstrumentos();
                renderizarInstrumentosMEP();
            } else if (tabId === 'bitacora') {
                renderizarBitacora();
            }
        }

        // ==================== MODALES ====================
        function abrirModalInstitucion() {
            document.getElementById('instNombre').value = '';
            document.getElementById('instCodigo').value = '';
            document.getElementById('instModalidad').value = 'primaria';
            
            institucionEnEdicion = null;
            document.querySelector('#institucionModal h3').textContent = 'Nueva Instituci贸n';
            
            document.getElementById('institucionModal').classList.add('active');
        }

        function abrirModalGrupo() {
            cargarInstitucionesSelect('grupoInstitucion');
            document.getElementById('grupoNombre').value = '';
            document.getElementById('grupoNivel').value = '';
            document.getElementById('grupoAsignaturas').value = '';
            
            grupoEnEdicion = null;
            document.querySelector('#grupoModal h3').textContent = 'Nuevo Grupo';
            
            document.getElementById('grupoModal').classList.add('active');
        }

        function abrirModalEstudiante(estudianteId = null) {
            cargarInstitucionesSelect('estInstitucion');
            
            if (estudianteId) {
                const estudiante = estudiantes.find(e => e.id === estudianteId);
                if (estudiante) {
                    estudianteEnEdicion = estudianteId;
                    document.getElementById('estudianteModalTitulo').textContent = 'Editar Estudiante';
                    
                    const grupo = grupos.find(g => g.id === estudiante.grupo);
                    if (grupo) {
                        document.getElementById('estInstitucion').value = grupo.institucion;
                        cargarGruposParaModalEstudiante();
                        setTimeout(() => {
                            document.getElementById('estGrupo').value = estudiante.grupo;
                        }, 100);
                    }
                    
                    document.getElementById('estNumero').value = estudiante.numero || '';
                    document.getElementById('estNombre').value = estudiante.nombre || '';
                    document.getElementById('estTelefono').value = estudiante.telefono || '';
                    document.getElementById('estCorreo').value = estudiante.correo || '';
                    document.getElementById('estCondicion').value = estudiante.condicion || 'regular';
                    document.getElementById('estObservaciones').value = estudiante.observaciones || '';
                }
            } else {
                estudianteEnEdicion = null;
                document.getElementById('estudianteModalTitulo').textContent = 'Agregar Estudiante';
                document.getElementById('estNumero').value = '';
                document.getElementById('estNombre').value = '';
                document.getElementById('estTelefono').value = '';
                document.getElementById('estCorreo').value = '';
                document.getElementById('estCondicion').value = 'regular';
                document.getElementById('estObservaciones').value = '';
            }
            
            document.getElementById('estudianteModal').classList.add('active');
        }

        function cerrarModal(id) {
            document.getElementById(id).classList.remove('active');
            
            if (id === 'institucionModal') {
                institucionEnEdicion = null;
                document.querySelector('#institucionModal h3').textContent = 'Nueva Instituci贸n';
            }
            if (id === 'grupoModal') {
                grupoEnEdicion = null;
                document.querySelector('#grupoModal h3').textContent = 'Nuevo Grupo';
            }
            if (id === 'estudianteModal') {
                estudianteEnEdicion = null;
                document.querySelector('#estudianteModal h3').textContent = 'Agregar Estudiante';
            }
            if (id === 'instrumentoModal') {
                instrumentoEnEdicion = null;
                document.querySelector('#instrumentoModal h3').textContent = 'Crear Instrumento de Evaluaci贸n - MEP';
            }
        }

        // ==================== INSTITUCIONES ====================
        function renderizarInstituciones() {
            const container = document.getElementById('institucionesLista');
            
            if (!instituciones.length) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8">No hay instituciones registradas. 隆Crea tu primera instituci贸n!</p>';
                return;
            }
            
            container.innerHTML = instituciones.map(inst => {
                const gruposCount = grupos.filter(g => g.institucion === inst.id).length;
                const estudiantesCount = estudiantes.filter(e => {
                    const grupo = grupos.find(g => g.id === e.grupo);
                    return grupo && grupo.institucion === inst.id;
                }).length;
                
                return `
                    <div class="p-4 border rounded-lg bg-white dark:bg-gray-800 hover:shadow-md transition">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-bold text-lg dark:text-white">${inst.nombre}</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-400">${inst.codigo ? `C贸digo: ${inst.codigo} | ` : ''}Modalidad: ${inst.modalidad}</p>
                                <div class="flex gap-4 mt-2 text-sm">
                                    <span class="dark:text-gray-300"><i class="fas fa-users text-blue-600 mr-1"></i> ${gruposCount} grupos</span>
                                    <span class="dark:text-gray-300"><i class="fas fa-user-graduate text-green-600 mr-1"></i> ${estudiantesCount} estudiantes</span>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="editarInstitucion('${inst.id}')" class="text-blue-600 hover:text-blue-800">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="eliminarInstitucion('${inst.id}')" class="text-red-600 hover:text-red-800">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            actualizarSelectsInstituciones();
        }

        function editarInstitucion(id) {
            const institucion = instituciones.find(i => i.id === id);
            if (!institucion) return;
            
            document.getElementById('instNombre').value = institucion.nombre;
            document.getElementById('instCodigo').value = institucion.codigo || '';
            document.getElementById('instModalidad').value = institucion.modalidad;
            
            institucionEnEdicion = id;
            document.querySelector('#institucionModal h3').textContent = 'Editar Instituci贸n';
            
            document.getElementById('institucionModal').classList.add('active');
        }

        function guardarInstitucion() {
            const nombre = document.getElementById('instNombre').value.trim();
            const codigo = document.getElementById('instCodigo').value.trim();
            const modalidad = document.getElementById('instModalidad').value;
            
            if (!nombre) {
                Utils.mostrarToast('El nombre de la instituci贸n es obligatorio', 'error');
                return;
            }
            
            if (institucionEnEdicion) {
                const index = instituciones.findIndex(i => i.id === institucionEnEdicion);
                if (index !== -1) {
                    instituciones[index] = {
                        ...instituciones[index],
                        nombre,
                        codigo,
                        modalidad
                    };
                    Utils.mostrarToast('Instituci贸n actualizada');
                }
                institucionEnEdicion = null;
            } else {
                instituciones.push({
                    id: Utils.generarId(),
                    nombre,
                    codigo,
                    modalidad
                });
                Utils.mostrarToast('Instituci贸n guardada');
            }
            
            DB.set('instituciones', instituciones);
            
            cerrarModal('institucionModal');
            renderizarInstituciones();
        }

        function eliminarInstitucion(id) {
            if (!Utils.confirmar('驴Eliminar esta instituci贸n? Tambi茅n se eliminar谩n todos sus grupos y estudiantes.')) return;
            
            const gruposEliminar = grupos.filter(g => g.institucion === id).map(g => g.id);
            
            estudiantes = estudiantes.filter(e => !gruposEliminar.includes(e.grupo));
            grupos = grupos.filter(g => g.institucion !== id);
            instituciones = instituciones.filter(i => i.id !== id);
            
            DB.set('instituciones', instituciones);
            DB.set('grupos', grupos);
            DB.set('estudiantes', estudiantes);
            
            renderizarInstituciones();
            Utils.mostrarToast('Instituci贸n eliminada');
        }

        function actualizarSelectsInstituciones() {
            const selects = [
                'filtroInstitucionGrupos', 'filtroInstitucionEstudiantes', 
                'evalInstitucion', 'asistInstitucion', 'reportInstitucion', 
                'actaInstitucion', 'grupoInstitucion', 'estInstitucion',
                'configEvalInstitucion'
            ];
            
            const options = instituciones.map(i => `<option value="${i.id}">${i.nombre}</option>`).join('');
            
            selects.forEach(id => {
                const sel = document.getElementById(id);
                if (sel) {
                    const valorActual = sel.value;
                    sel.innerHTML = '<option value="">Seleccione...</option>' + options;
                    if (valorActual && instituciones.some(i => i.id === valorActual)) {
                        sel.value = valorActual;
                    }
                }
            });
        }

        function cargarInstitucionesSelect(selectId) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            select.innerHTML = '<option value="">Seleccione...</option>' + 
                instituciones.map(i => `<option value="${i.id}">${i.nombre}</option>`).join('');
        }

        // ==================== GRUPOS ====================
        function renderizarGrupos() {
            const filtro = document.getElementById('filtroInstitucionGrupos').value;
            const container = document.getElementById('gruposLista');
            
            let gruposFiltrados = grupos;
            if (filtro) {
                gruposFiltrados = grupos.filter(g => g.institucion === filtro);
            }
            
            if (!gruposFiltrados.length) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-4">No hay grupos para mostrar</p>';
                return;
            }
            
            container.innerHTML = gruposFiltrados.map(grupo => {
                const institucion = instituciones.find(i => i.id === grupo.institucion);
                const estudiantesCount = estudiantes.filter(e => e.grupo === grupo.id).length;
                const tipoNivel = parseInt(grupo.nivel) <= 6 ? 'Primaria' : 'Secundaria';
                
                return `
                    <div class="p-4 border rounded-lg bg-gray-50 dark:bg-gray-800">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-bold dark:text-white">${grupo.nombre}</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-400">${institucion ? institucion.nombre : 'Instituci贸n no encontrada'}  ${tipoNivel}  Nivel ${grupo.nivel}</p>
                                ${grupo.asignaturas ? `<p class="text-xs text-gray-500 dark:text-gray-500 mt-1">Asignaturas: ${grupo.asignaturas}</p>` : ''}
                                <p class="text-sm mt-2 dark:text-gray-300"><i class="fas fa-user-graduate mr-1"></i> ${estudiantesCount} estudiantes</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="editarGrupo('${grupo.id}')" class="text-blue-600 hover:text-blue-800">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="eliminarGrupo('${grupo.id}')" class="text-red-600 hover:text-red-800">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function editarGrupo(id) {
            const grupo = grupos.find(g => g.id === id);
            if (!grupo) return;
            
            cargarInstitucionesSelect('grupoInstitucion');
            
            setTimeout(() => {
                document.getElementById('grupoInstitucion').value = grupo.institucion;
                document.getElementById('grupoNombre').value = grupo.nombre;
                document.getElementById('grupoNivel').value = grupo.nivel;
                document.getElementById('grupoAsignaturas').value = grupo.asignaturas || '';
            }, 100);
            
            grupoEnEdicion = id;
            document.querySelector('#grupoModal h3').textContent = 'Editar Grupo';
            
            document.getElementById('grupoModal').classList.add('active');
        }

        function guardarGrupo() {
            const institucion = document.getElementById('grupoInstitucion').value;
            const nombre = document.getElementById('grupoNombre').value.trim();
            const nivel = document.getElementById('grupoNivel').value;
            const asignaturas = document.getElementById('grupoAsignaturas').value.trim();
            
            if (!institucion || !nombre || !nivel) {
                Utils.mostrarToast('Complete todos los campos obligatorios', 'error');
                return;
            }
            
            if (grupoEnEdicion) {
                const index = grupos.findIndex(g => g.id === grupoEnEdicion);
                if (index !== -1) {
                    grupos[index] = {
                        ...grupos[index],
                        institucion,
                        nombre,
                        nivel,
                        asignaturas
                    };
                    Utils.mostrarToast('Grupo actualizado');
                }
                grupoEnEdicion = null;
            } else {
                grupos.push({
                    id: Utils.generarId(),
                    institucion,
                    nombre,
                    nivel,
                    asignaturas
                });
                Utils.mostrarToast('Grupo creado');
            }
            
            DB.set('grupos', grupos);
            
            cerrarModal('grupoModal');
            
            if (document.getElementById('grupos').classList.contains('active')) {
                renderizarGrupos();
            }
        }

        function eliminarGrupo(id) {
            if (!Utils.confirmar('驴Eliminar este grupo? Tambi茅n se eliminar谩n sus estudiantes.')) return;
            
            grupos = grupos.filter(g => g.id !== id);
            estudiantes = estudiantes.filter(e => e.grupo !== id);
            
            DB.set('grupos', grupos);
            DB.set('estudiantes', estudiantes);
            
            renderizarGrupos();
            Utils.mostrarToast('Grupo eliminado');
        }

        function cargarGruposPorInstitucion() {
            renderizarGrupos();
        }

        // ==================== ESTUDIANTES ====================
        function cargarGruposParaEstudiantes() {
            const institucionId = document.getElementById('filtroInstitucionEstudiantes').value;
            const selectGrupo = document.getElementById('filtroGrupoEstudiantes');
            
            if (!institucionId) {
                selectGrupo.innerHTML = '<option value="">Seleccione...</option>';
                return;
            }
            
            const gruposFiltrados = grupos.filter(g => g.institucion === institucionId);
            selectGrupo.innerHTML = '<option value="">Seleccione...</option>' + 
                gruposFiltrados.map(g => `<option value="${g.id}">${g.nombre}</option>`).join('');
        }

        function cargarEstudiantesPorGrupo() {
            const grupoId = document.getElementById('filtroGrupoEstudiantes').value;
            
            if (!grupoId) {
                document.getElementById('estudiantesTabla').innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500 dark:text-gray-400">Seleccione un grupo</td></tr>';
                return;
            }
            
            const estudiantesFiltrados = estudiantes.filter(e => e.grupo === grupoId);
            estudiantesFiltrados.sort((a, b) => (a.numero || 0) - (b.numero || 0));
            
            const tbody = document.getElementById('estudiantesTabla');
            
            if (!estudiantesFiltrados.length) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500 dark:text-gray-400">No hay estudiantes en este grupo</td></tr>';
                return;
            }
            
            tbody.innerHTML = estudiantesFiltrados.map((e, i) => {
                let badgeClass = 'bg-gray-100 dark:bg-gray-700 dark:text-gray-300';
                let badgeText = 'Regular';
                
                if (e.condicion === 'acs') {
                    badgeClass = 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200';
                    badgeText = 'ACS';
                } else if (e.condicion === 'ns') {
                    badgeClass = 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200';
                    badgeText = 'No Signif.';
                } else if (e.condicion === 'acceso') {
                    badgeClass = 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200';
                    badgeText = 'Acceso';
                }
                
                return `
                    <tr>
                        <td class="dark:text-gray-300">${e.numero || i+1}</td>
                        <td class="dark:text-gray-300">${e.nombre}</td>
                        <td class="dark:text-gray-300">${e.telefono || '-'}</td>
                        <td>
                            <span class="badge ${badgeClass}">${badgeText}</span>
                        </td>
                        <td>
                            <button onclick="abrirModalEstudiante('${e.id}')" class="text-blue-600 hover:text-blue-800 mr-2">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="eliminarEstudiante('${e.id}')" class="text-red-600 hover:text-red-800">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function cargarGruposParaModalEstudiante() {
            const institucionId = document.getElementById('estInstitucion').value;
            const selectGrupo = document.getElementById('estGrupo');
            
            if (!institucionId) {
                selectGrupo.innerHTML = '<option value="">Seleccione...</option>';
                return;
            }
            
            const gruposFiltrados = grupos.filter(g => g.institucion === institucionId);
            selectGrupo.innerHTML = '<option value="">Seleccione...</option>' + 
                gruposFiltrados.map(g => `<option value="${g.id}">${g.nombre}</option>`).join('');
        }

        function guardarEstudiante() {
            const grupo = document.getElementById('estGrupo').value;
            const nombre = document.getElementById('estNombre').value.trim();
            
            if (!grupo || !nombre) {
                Utils.mostrarToast('Complete grupo y nombre', 'error');
                return;
            }
            
            const datosEstudiante = {
                grupo,
                numero: document.getElementById('estNumero').value ? parseInt(document.getElementById('estNumero').value) : null,
                nombre,
                telefono: document.getElementById('estTelefono').value,
                correo: document.getElementById('estCorreo').value,
                condicion: document.getElementById('estCondicion').value,
                observaciones: document.getElementById('estObservaciones').value
            };
            
            if (estudianteEnEdicion) {
                const index = estudiantes.findIndex(e => e.id === estudianteEnEdicion);
                if (index !== -1) {
                    estudiantes[index] = {
                        ...estudiantes[index],
                        ...datosEstudiante
                    };
                    Utils.mostrarToast('Estudiante actualizado');
                }
                estudianteEnEdicion = null;
            } else {
                estudiantes.push({
                    id: Utils.generarId(),
                    ...datosEstudiante
                });
                Utils.mostrarToast('Estudiante agregado');
            }
            
            DB.set('estudiantes', estudiantes);
            
            cerrarModal('estudianteModal');
            
            if (document.getElementById('estudiantes').classList.contains('active')) {
                cargarEstudiantesPorGrupo();
            }
        }

        function eliminarEstudiante(id) {
            if (!Utils.confirmar('驴Eliminar este estudiante?')) return;
            
            estudiantes = estudiantes.filter(e => e.id !== id);
            DB.set('estudiantes', estudiantes);
            
            cargarEstudiantesPorGrupo();
            Utils.mostrarToast('Estudiante eliminado');
        }

        // ==================== CONFIGURACIN DE EVALUACIN ====================
        function cargarGruposConfigEvaluacion() {
            const institucionId = document.getElementById('configEvalInstitucion').value;
            const selectGrupo = document.getElementById('configEvalGrupo');
            
            if (!institucionId) {
                selectGrupo.innerHTML = '<option value="">Seleccione...</option>';
                return;
            }
            
            const gruposFiltrados = grupos.filter(g => g.institucion === institucionId);
            selectGrupo.innerHTML = '<option value="">Seleccione...</option>' + 
                gruposFiltrados.map(g => `<option value="${g.id}">${g.nombre}</option>`).join('');
        }

        function cargarAsignaturasConfigEvaluacion() {
            const grupoId = document.getElementById('configEvalGrupo').value;
            const selectAsig = document.getElementById('configEvalAsignatura');
            
            if (!grupoId) {
                selectAsig.innerHTML = '<option value="">Seleccione...</option>';
                return;
            }
            
            const grupo = grupos.find(g => g.id === grupoId);
            if (!grupo || !grupo.asignaturas) {
                selectAsig.innerHTML = '<option value="">El grupo no tiene asignaturas definidas</option>';
                return;
            }
            
            const asignaturas = grupo.asignaturas.split(',').map(a => a.trim());
            selectAsig.innerHTML = '<option value="">Seleccione...</option>' + 
                asignaturas.map(a => `<option value="${a}">${a}</option>`).join('');
        }

        function cargarConfiguracionExistente() {
            const grupoId = document.getElementById('configEvalGrupo').value;
            const asignatura = document.getElementById('configEvalAsignatura').value;
            
            if (!grupoId || !asignatura) {
                document.getElementById('configEvalPanel').classList.add('hidden');
                return;
            }
            
            const configKey = `${grupoId}_${asignatura}`;
            const config = configuracionesEvaluacion[configKey] || sugerirPlantillaPorGrupoYAsignatura(grupoId, asignatura);
            
            mostrarConfiguracionComponentes(config);
            document.getElementById('configEvalPanel').classList.remove('hidden');
        }

        function sugerirPlantillaPorGrupoYAsignatura(grupoId, asignatura) {
            const grupo = grupos.find(g => g.id === grupoId);
            if (!grupo) return [];
            
            const nivel = parseInt(grupo.nivel);
            const esPrimaria = nivel <= 6;
            const esSecundaria = nivel >= 7 && nivel <= 9;
            const esDiversificada = nivel >= 10;
            
            const academicas = /Matem谩tica|Espa帽ol|Ciencias|Estudios Sociales|Lengua Extranjera|Biolog铆a|F铆sica|Qu铆mica|Filosof铆a|Psicolog铆a/i;
            const complementarias = /Educaci贸n F铆sica|Educaci贸n Musical|Educaci贸n para el Hogar|Artes Industriales/i;
            const arte = /Artes Pl谩sticas|Arte/i;
            const religion = /Religiosa|Religi贸n/i;
            
            if (esPrimaria) {
                if (academicas.test(asignatura)) return [...plantillasMEP.primaria_academica];
                if (complementarias.test(asignatura)) return [...plantillasMEP.primaria_complementaria];
                if (arte.test(asignatura)) return [...plantillasMEP.primaria_artes];
                if (religion.test(asignatura)) return [...plantillasMEP.primaria_religion];
                return [...plantillasMEP.primaria_academica];
            }
            
            if (esSecundaria) {
                if (academicas.test(asignatura)) return [...plantillasMEP.secundaria_academica];
                return [...plantillasMEP.secundaria_complementaria];
            }
            
            if (esDiversificada) {
                if (academicas.test(asignatura)) return [...plantillasMEP.diversificada_academica];
                return [...plantillasMEP.diversificada_academica];
            }
            
            return [];
        }

        function mostrarConfiguracionComponentes(componentes) {
            const container = document.getElementById('componentesConfigLista');
            let html = '';
            
            const todosComponentes = [
                'Trabajo Cotidiano',
                'Tareas',
                'Pruebas',
                'Proyecto',
                'Asistencia',
                'Portafolio',
                'Demostraci贸n'
            ];
            
            todosComponentes.forEach(nombre => {
                const compExistente = componentes.find(c => c.nombre === nombre);
                const activo = compExistente ? compExistente.activo : false;
                const porcentaje = compExistente ? compExistente.porcentaje : 0;
                const minimo = compExistente ? compExistente.minimo : null;
                
                html += `
                    <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                        <div class="flex items-center gap-4">
                            <input type="checkbox" id="comp_${nombre}" 
                                ${activo ? 'checked' : ''} 
                                onchange="toggleComponente('${nombre}')"
                                class="w-5 h-5">
                            <label for="comp_${nombre}" class="font-medium dark:text-gray-300">${nombre}</label>
                            ${minimo ? `<span class="text-xs text-gray-500 dark:text-gray-400">(m铆nimo ${minimo})</span>` : ''}
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="number" id="pct_${nombre}" 
                                value="${porcentaje}" 
                                onchange="actualizarPorcentaje('${nombre}')"
                                class="w-20 px-2 py-1 border rounded text-center dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                                ${!activo ? 'disabled' : ''}>
                            <span class="text-sm dark:text-gray-300">%</span>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            actualizarTotalPorcentaje();
        }

        function toggleComponente(nombre) {
            const checkbox = document.getElementById(`comp_${nombre}`);
            const input = document.getElementById(`pct_${nombre}`);
            
            input.disabled = !checkbox.checked;
            if (!checkbox.checked) {
                input.value = 0;
            }
            
            actualizarTotalPorcentaje();
        }

        function actualizarPorcentaje(nombre) {
            actualizarTotalPorcentaje();
        }

        function actualizarTotalPorcentaje() {
            const inputs = document.querySelectorAll('#componentesConfigLista input[type="number"]');
            let total = 0;
            
            inputs.forEach(input => {
                total += parseInt(input.value) || 0;
            });
            
            document.getElementById('totalPorcentaje').textContent = total + '%';
            
            if (total !== 100) {
                document.getElementById('totalPorcentaje').classList.add('text-red-600');
            } else {
                document.getElementById('totalPorcentaje').classList.remove('text-red-600');
            }
        }

        function cargarPlantillaPorAsignatura() {
            const grupoId = document.getElementById('configEvalGrupo').value;
            const asignatura = document.getElementById('configEvalAsignatura').value;
            
            if (!grupoId || !asignatura) {
                Utils.mostrarToast('Seleccione grupo y asignatura', 'error');
                return;
            }
            
            const plantilla = sugerirPlantillaPorGrupoYAsignatura(grupoId, asignatura);
            mostrarConfiguracionComponentes(plantilla);
        }

        function guardarConfiguracionEvaluacion() {
            const grupoId = document.getElementById('configEvalGrupo').value;
            const asignatura = document.getElementById('configEvalAsignatura').value;
            
            if (!grupoId || !asignatura) {
                Utils.mostrarToast('Seleccione grupo y asignatura', 'error');
                return;
            }
            
            const componentes = [];
            const todosComponentes = [
                'Trabajo Cotidiano',
                'Tareas',
                'Pruebas',
                'Proyecto',
                'Asistencia',
                'Portafolio',
                'Demostraci贸n'
            ];
            
            todosComponentes.forEach(nombre => {
                const checkbox = document.getElementById(`comp_${nombre}`);
                if (checkbox) {
                    const activo = checkbox.checked;
                    const porcentaje = activo ? (parseInt(document.getElementById(`pct_${nombre}`).value) || 0) : 0;
                    
                    if (activo && porcentaje > 0) {
                        componentes.push({
                            nombre,
                            porcentaje,
                            activo: true
                        });
                    }
                }
            });
            
            const total = componentes.reduce((sum, c) => sum + c.porcentaje, 0);
            
            if (total !== 100) {
                Utils.mostrarToast('Los porcentajes deben sumar 100%', 'error');
                return;
            }
            
            const configKey = `${grupoId}_${asignatura}`;
            configuracionesEvaluacion[configKey] = componentes;
            
            DB.set('configuracionesEvaluacion', configuracionesEvaluacion);
            
            Utils.mostrarToast('Configuraci贸n guardada correctamente');
        }

        // ==================== EVALUACIN ====================
        function cargarGruposEvaluacion() {
            const institucionId = document.getElementById('evalInstitucion').value;
            const selectGrupo = document.getElementById('evalGrupo');
            
            if (!institucionId) {
                selectGrupo.innerHTML = '<option value="">Seleccione...</option>';
                return;
            }
            
            const gruposFiltrados = grupos.filter(g => g.institucion === institucionId);
            selectGrupo.innerHTML = '<option value="">Seleccione...</option>' + 
                gruposFiltrados.map(g => `<option value="${g.id}">${g.nombre}</option>`).join('');
        }

        function cargarAsignaturasEvaluacion() {
            const grupoId = document.getElementById('evalGrupo').value;
            const selectAsig = document.getElementById('evalAsignatura');
            
            if (!grupoId) {
                selectAsig.innerHTML = '<option value="">Seleccione...</option>';
                return;
            }
            
            const grupo = grupos.find(g => g.id === grupoId);
            if (!grupo || !grupo.asignaturas) {
                selectAsig.innerHTML = '<option value="">El grupo no tiene asignaturas definidas</option>';
                return;
            }
            
            const asignaturas = grupo.asignaturas.split(',').map(a => a.trim());
            selectAsig.innerHTML = '<option value="">Seleccione...</option>' + 
                asignaturas.map(a => `<option value="${a}">${a}</option>`).join('');
        }

        function cargarConfiguracionParaEvaluacion() {
            const grupoId = document.getElementById('evalGrupo').value;
            const asignatura = document.getElementById('evalAsignatura').value;
            const container = document.getElementById('componentesLista');
            
            if (!grupoId || !asignatura) {
                container.innerHTML = '<span class="text-sm text-gray-500 dark:text-gray-400">Seleccione grupo y asignatura</span>';
                return;
            }
            
            const configKey = `${grupoId}_${asignatura}`;
            const componentes = configuracionesEvaluacion[configKey] || sugerirPlantillaPorGrupoYAsignatura(grupoId, asignatura);
            
            let html = '';
            componentes.forEach(comp => {
                html += `<span class="component-chip active">${comp.nombre} (${comp.porcentaje}%)</span>`;
            });
            
            container.innerHTML = html || '<span class="text-sm text-gray-500 dark:text-gray-400">No hay configuraci贸n para esta asignatura</span>';
            
            return componentes;
        }

        function cargarTablaEvaluacion() {
            const grupoId = document.getElementById('evalGrupo').value;
            const asignatura = document.getElementById('evalAsignatura').value;
            const periodo = document.getElementById('evalPeriodo').value;
            
            if (!grupoId || !asignatura) {
                Utils.mostrarToast('Seleccione grupo y asignatura', 'error');
                return;
            }
            
            const componentes = cargarConfiguracionParaEvaluacion();
            if (!componentes || componentes.length === 0) {
                Utils.mostrarToast('No hay configuraci贸n para esta asignatura', 'error');
                return;
            }
            
            const estudiantesGrupo = estudiantes.filter(e => e.grupo === grupoId);
            if (!estudiantesGrupo.length) {
                Utils.mostrarToast('No hay estudiantes en este grupo', 'warning');
                return;
            }
            
            const notasKey = `${grupoId}_${periodo}_${asignatura}`;
            const notasGrupo = notas[notasKey] || {};
            
            let headerHtml = '<tr><th class="dark:text-white">Estudiante</th><th class="dark:text-white">Condici贸n</th>';
            componentes.forEach(comp => {
                headerHtml += `<th class="text-center dark:text-white">${comp.nombre} (${comp.porcentaje}%)</th>`;
            });
            headerHtml += '<th class="text-center font-bold dark:text-white">Prom.</th></tr>';
            document.getElementById('evalTableHeader').innerHTML = headerHtml;
            
            let tbody = '', sumaPromedios = 0;
            
            estudiantesGrupo.sort((a, b) => (a.numero || 0) - (b.numero || 0)).forEach(est => {
                const notaEst = notasGrupo[est.id] || {};
                let row = `<tr><td class="font-medium dark:text-gray-300">${est.nombre}</td>`;
                
                let badgeClass = 'bg-gray-100 dark:bg-gray-700 dark:text-gray-300';
                let badgeText = 'Regular';
                if (est.condicion === 'acs') {
                    badgeClass = 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200';
                    badgeText = 'ACS';
                } else if (est.condicion === 'ns') {
                    badgeClass = 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200';
                    badgeText = 'No Signif.';
                } else if (est.condicion === 'acceso') {
                    badgeClass = 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200';
                    badgeText = 'Acceso';
                }
                
                row += `<td><span class="badge ${badgeClass} text-xs">${badgeText}</span></td>`;
                
                let sumaPonderada = 0;
                
                componentes.forEach(comp => {
                    const valor = notaEst[comp.nombre] || '';
                    row += `<td><input type="number" class="w-16 px-2 py-1 border rounded text-center dark:bg-gray-700 dark:border-gray-600 dark:text-white" value="${valor}" data-est="${est.id}" data-campo="${comp.nombre}" data-porcentaje="${comp.porcentaje}" onchange="actualizarNota(this)"></td>`;
                    
                    if (valor) {
                        sumaPonderada += parseFloat(valor) * (comp.porcentaje / 100);
                    }
                });
                
                sumaPromedios += sumaPonderada;
                
                row += `<td class="font-bold text-center dark:text-white" id="prom_${est.id}">${sumaPonderada ? sumaPonderada.toFixed(2) : '-'}</td></tr>`;
                tbody += row;
            });
            
            document.getElementById('evaluacionTableBody').innerHTML = tbody;
            document.getElementById('evaluacionTableContainer').classList.remove('hidden');
            
            const promedioGrupo = estudiantesGrupo.length ? (sumaPromedios / estudiantesGrupo.length).toFixed(2) : '0.00';
            document.getElementById('promedioGrupo').textContent = promedioGrupo;
        }

        function actualizarNota(input) {
            const estId = input.dataset.est;
            const row = input.closest('tr');
            const inputs = row.querySelectorAll('input[data-est]');
            
            let sumaPonderada = 0;
            
            inputs.forEach(inp => {
                const valor = parseFloat(inp.value) || 0;
                const porcentaje = parseFloat(inp.dataset.porcentaje) || 0;
                sumaPonderada += valor * (porcentaje / 100);
            });
            
            document.getElementById(`prom_${estId}`).textContent = sumaPonderada.toFixed(2);
            
            let suma = 0, count = 0;
            document.querySelectorAll('#evaluacionTableBody td[id^="prom_"]').forEach(td => {
                const val = parseFloat(td.textContent);
                if (!isNaN(val)) { suma += val; count++; }
            });
            document.getElementById('promedioGrupo').textContent = count ? (suma / count).toFixed(2) : '0.00';
        }

        function guardarNotas() {
            const grupoId = document.getElementById('evalGrupo').value;
            const periodo = document.getElementById('evalPeriodo').value;
            const asignatura = document.getElementById('evalAsignatura').value.trim();
            
            if (!grupoId || !asignatura) return;
            
            const key = `${grupoId}_${periodo}_${asignatura}`;
            notas[key] = {};
            
            document.querySelectorAll('#evaluacionTableBody tr').forEach(row => {
                const estId = row.querySelector('input[data-est]')?.dataset.est;
                if (!estId) return;
                
                const notaEst = {};
                row.querySelectorAll('input[data-est]').forEach(inp => {
                    notaEst[inp.dataset.campo] = inp.value ? parseFloat(inp.value) : null;
                });
                notas[key][estId] = notaEst;
            });
            
            DB.set('notas', notas);
            Utils.mostrarToast('Notas guardadas correctamente');
        }

        // ==================== INSTRUMENTOS - VERSIN MEP ====================
        function cargarFiltrosInstrumentos() {
            const selectAsig = document.getElementById('filtroInstrumentoAsignatura');
            const asignaturas = new Set();
            
            grupos.forEach(g => {
                if (g.asignaturas) {
                    g.asignaturas.split(',').map(a => a.trim()).forEach(asig => asignaturas.add(asig));
                }
            });
            
            instrumentos.forEach(i => {
                if (i.asignatura) asignaturas.add(i.asignatura);
            });
            
            const sortedAsignaturas = Array.from(asignaturas).sort();
            selectAsig.innerHTML = '<option value="">Todas</option>' + 
                sortedAsignaturas.map(a => `<option value="${a}">${a}</option>`).join('');
        }

        function cambiarPestanaInstrumento(pestana) {
            pestanaActiva = pestana;
            
            document.querySelectorAll('.pestana-instrumento').forEach(p => p.classList.add('hidden'));
            document.getElementById(`pestana${pestana.charAt(0).toUpperCase() + pestana.slice(1)}`).classList.remove('hidden');
            
            ['Basicos', 'Contenido', 'Vista'].forEach(p => {
                const btn = document.getElementById(`pestana${p}Btn`);
                if (btn) {
                    if (p.toLowerCase() === pestana) {
                        btn.className = 'px-4 py-2 font-medium border-b-2 border-blue-600 text-blue-600 dark:text-blue-400';
                    } else {
                        btn.className = 'px-4 py-2 font-medium text-gray-600 dark:text-gray-400 hover:text-blue-600';
                    }
                }
            });
            
            if (pestana === 'vista') {
                actualizarVistaPreviaMEP();
            }
        }

        function cambiarTipoInstrumentoMEP() {
            const tipo = document.getElementById('instTipo').value;
            const container = document.getElementById('contenedorIndicadores');
            const btnAgregar = document.getElementById('btnAgregarFila');
            
            let html = '';
            
            switch(tipo) {
                case 'rubrica_holistica':
                    html = `
                        <div class="space-y-4">
                            <div class="rubrica-holistica-item dark:border-gray-700">
                                <h5 class="font-semibold mb-2 dark:text-white">Niveles de desempe帽o</h5>
                                <div class="space-y-3">
                                    <div>
                                        <label class="form-label dark:text-gray-300">Avanzado (91-100)</label>
                                        <textarea class="form-input criterio-input dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Descripci贸n del desempe帽o avanzado..."></textarea>
                                    </div>
                                    <div>
                                        <label class="form-label dark:text-gray-300">Intermedio (71-90)</label>
                                        <textarea class="form-input criterio-input dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Descripci贸n del desempe帽o intermedio..."></textarea>
                                    </div>
                                    <div>
                                        <label class="form-label dark:text-gray-300">Inicial (50-70)</label>
                                        <textarea class="form-input criterio-input dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Descripci贸n del desempe帽o inicial..."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    btnAgregar.style.display = 'none';
                    break;
                    
                case 'rubrica_analitica':
                    html = `
                        <div class="overflow-x-auto">
                            <div class="rubrica-analitica-grid font-semibold bg-gray-100 dark:bg-gray-800 p-2 rounded">
                                <div class="dark:text-white">Indicador</div>
                                <div class="text-center dark:text-white">Avanzado (4)</div>
                                <div class="text-center dark:text-white">Intermedio (3)</div>
                                <div class="text-center dark:text-white">Inicial (2)</div>
                                <div class="text-center dark:text-white">Insuficiente (1)</div>
                            </div>
                            <div id="rubrica-analitica-items" class="space-y-2">
                                <!-- Se agregar谩n din谩micamente -->
                            </div>
                        </div>
                    `;
                    btnAgregar.style.display = 'block';
                    btnAgregar.innerHTML = '<i class="fas fa-plus"></i> Agregar Indicador';
                    setTimeout(() => agregarFilaRubricaAnalitica(), 100);
                    break;
                    
                case 'escala_numerica':
                    html = `
                        <div class="space-y-4">
                            <p class="text-sm text-gray-600 dark:text-gray-400">Defina los indicadores y asigne valores num茅ricos</p>
                            <div id="escala-numerica-items" class="space-y-2">
                                <!-- Se agregar谩n din谩micamente -->
                            </div>
                        </div>
                    `;
                    btnAgregar.style.display = 'block';
                    btnAgregar.innerHTML = '<i class="fas fa-plus"></i> Agregar Indicador';
                    setTimeout(() => agregarFilaEscalaNumerica(), 100);
                    break;
                    
                case 'escala_descriptiva':
                    html = `
                        <div class="space-y-4">
                            <p class="text-sm text-gray-600 dark:text-gray-400">Defina los niveles descriptivos</p>
                            <div id="escala-descriptiva-items" class="space-y-2">
                                <!-- Se agregar谩n din谩micamente -->
                            </div>
                        </div>
                    `;
                    btnAgregar.style.display = 'block';
                    btnAgregar.innerHTML = '<i class="fas fa-plus"></i> Agregar Indicador';
                    setTimeout(() => agregarFilaEscalaDescriptiva(), 100);
                    break;
                    
                case 'escala_desempeno':
                    html = `
                        <div class="space-y-4">
                            <p class="text-sm text-gray-600 dark:text-gray-400">Escala de desempe帽o con niveles graduados</p>
                            <div id="escala-desempeno-items" class="space-y-2">
                                <!-- Se agregar谩n din谩micamente -->
                            </div>
                        </div>
                    `;
                    btnAgregar.style.display = 'block';
                    btnAgregar.innerHTML = '<i class="fas fa-plus"></i> Agregar Indicador';
                    setTimeout(() => agregarFilaEscalaDesempeno(), 100);
                    break;
                    
                case 'lista_cotejo':
                    html = `
                        <div class="space-y-4">
                            <p class="text-sm text-gray-600 dark:text-gray-400">Lista de cotejo (S铆/No)</p>
                            <div id="cotejo-items" class="space-y-2">
                                <!-- Se agregar谩n din谩micamente -->
                            </div>
                        </div>
                    `;
                    btnAgregar.style.display = 'block';
                    btnAgregar.innerHTML = '<i class="fas fa-plus"></i> Agregar Criterio';
                    setTimeout(() => agregarFilaCotejo(), 100);
                    break;
                    
                case 'registro_desempeno':
                    html = `
                        <div class="space-y-4">
                            <p class="text-sm text-gray-600 dark:text-gray-400">Registro de desempe帽o con observaciones</p>
                            <div id="registro-desempeno-items" class="space-y-2">
                                <!-- Se agregar谩n din谩micamente -->
                            </div>
                        </div>
                    `;
                    btnAgregar.style.display = 'block';
                    btnAgregar.innerHTML = '<i class="fas fa-plus"></i> Agregar Indicador';
                    setTimeout(() => agregarFilaRegistroDesempeno(), 100);
                    break;
                    
                case 'registro_anecdotico':
                    html = `
                        <div class="anecdotico-form dark:bg-gray-800 dark:border-gray-700">
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="form-label dark:text-gray-300">Estudiante</label>
                                    <input type="text" class="form-input dark:bg-gray-700 dark:border-gray-600 dark:text-white" id="anecdoticoEstudiante" placeholder="Nombre del estudiante">
                                </div>
                                <div>
                                    <label class="form-label dark:text-gray-300">Fecha</label>
                                    <input type="date" class="form-input dark:bg-gray-700 dark:border-gray-600 dark:text-white" id="anecdoticoFecha">
                                </div>
                            </div>
                            <div>
                                <label class="form-label dark:text-gray-300">Hora</label>
                                <input type="time" class="form-input dark:bg-gray-700 dark:border-gray-600 dark:text-white" id="anecdoticoHora">
                            </div>
                            <div>
                                <label class="form-label dark:text-gray-300">Actividad de evaluaci贸n</label>
                                <input type="text" class="form-input dark:bg-gray-700 dark:border-gray-600 dark:text-white" id="anecdoticoActividad" placeholder="Actividad en desarrollo">
                            </div>
                            <div>
                                <label class="form-label dark:text-gray-300">Descripci贸n de lo observado</label>
                                <textarea class="form-input dark:bg-gray-700 dark:border-gray-600 dark:text-white" id="anecdoticoDescripcion" rows="4" placeholder="Describa el hecho, suceso o situaci贸n concreta..."></textarea>
                            </div>
                            <div>
                                <label class="form-label dark:text-gray-300">Interpretaci贸n / Observaciones</label>
                                <textarea class="form-input dark:bg-gray-700 dark:border-gray-600 dark:text-white" id="anecdoticoInterpretacion" rows="3" placeholder="An谩lisis o notas adicionales..."></textarea>
                            </div>
                        </div>
                    `;
                    btnAgregar.style.display = 'none';
                    break;
            }
            
            container.innerHTML = html;
        }

        function agregarFilaRubricaAnalitica() {
            const container = document.getElementById('rubrica-analitica-items');
            const num = container.children.length + 1;
            const div = document.createElement('div');
            div.className = 'rubrica-analitica-grid';
            div.innerHTML = `
                <input type="text" class="indicador-input form-input dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Indicador ${num}">
                <input type="text" class="form-input dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Criterio avanzado">
                <input type="text" class="form-input dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Criterio intermedio">
                <input type="text" class="form-input dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Criterio inicial">
                <input type="text" class="form-input dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Criterio insuficiente">
                <button onclick="this.parentElement.remove()" class="btn-secondary text-sm px-2 ml-2">-</button>
            `;
            container.appendChild(div);
            actualizarTotalIndicadores();
        }

        function agregarFilaEscalaNumerica() {
            const container = document.getElementById('escala-numerica-items');
            const num = container.children.length + 1;
            const div = document.createElement('div');
            div.className = 'escala-item';
            div.innerHTML = `
                <input type="text" class="indicador-input form-input flex-1 dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Indicador ${num}">
                <select class="form-select w-24 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                </select>
                <span class="text-sm dark:text-gray-300">puntos</span>
                <button onclick="this.parentElement.remove()" class="btn-secondary text-sm px-2">-</button>
            `;
            container.appendChild(div);
            actualizarTotalIndicadores();
        }

        function agregarFilaEscalaDescriptiva() {
            const container = document.getElementById('escala-descriptiva-items');
            const num = container.children.length + 1;
            const div = document.createElement('div');
            div.className = 'space-y-2 p-3 bg-gray-50 dark:bg-gray-800 rounded';
            div.innerHTML = `
                <input type="text" class="indicador-input form-input dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Indicador ${num}">
                <div class="grid grid-cols-3 gap-2 mt-2">
                    <textarea class="form-input text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white" rows="2" placeholder="Nivel 1 (Inicial)"></textarea>
                    <textarea class="form-input text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white" rows="2" placeholder="Nivel 2 (Intermedio)"></textarea>
                    <textarea class="form-input text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white" rows="2" placeholder="Nivel 3 (Avanzado)"></textarea>
                </div>
                <button onclick="this.parentElement.remove()" class="btn-secondary text-sm px-2 mt-2">-</button>
            `;
            container.appendChild(div);
            actualizarTotalIndicadores();
        }

        function agregarFilaEscalaDesempeno() {
            const container = document.getElementById('escala-desempeno-items');
            const num = container.children.length + 1;
            const div = document.createElement('div');
            div.className = 'space-y-2 p-3 bg-gray-50 dark:bg-gray-800 rounded';
            div.innerHTML = `
                <input type="text" class="indicador-input form-input dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Indicador ${num}">
                <div class="flex gap-4 mt-2">
                    <div><span class="nivel-desempeno nivel-1">1</span> <input type="text" class="form-input text-sm w-32 dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Criterio"></div>
                    <div><span class="nivel-desempeno nivel-2">2</span> <input type="text" class="form-input text-sm w-32 dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Criterio"></div>
                    <div><span class="nivel-desempeno nivel-3">3</span> <input type="text" class="form-input text-sm w-32 dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Criterio"></div>
                    <div><span class="nivel-desempeno nivel-4">4</span> <input type="text" class="form-input text-sm w-32 dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Criterio"></div>
                </div>
                <button onclick="this.parentElement.remove()" class="btn-secondary text-sm px-2 mt-2">-</button>
            `;
            container.appendChild(div);
            actualizarTotalIndicadores();
        }

        function agregarFilaCotejo() {
            const container = document.getElementById('cotejo-items');
            const num = container.children.length + 1;
            const div = document.createElement('div');
            div.className = 'cotejo-item';
            div.innerHTML = `
                <input type="text" class="indicador-input form-input flex-1 dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Criterio ${num}">
                <label class="flex items-center gap-1 dark:text-gray-300">
                    <input type="checkbox" class="w-4 h-4" checked> Cumple
                </label>
                <button onclick="this.parentElement.remove()" class="btn-secondary text-sm px-2">-</button>
            `;
            container.appendChild(div);
            actualizarTotalIndicadores();
        }

        function agregarFilaRegistroDesempeno() {
            const container = document.getElementById('registro-desempeno-items');
            const num = container.children.length + 1;
            const div = document.createElement('div');
            div.className = 'flex gap-2 items-center p-2 bg-gray-50 dark:bg-gray-800 rounded';
            div.innerHTML = `
                <input type="text" class="indicador-input form-input flex-1 dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Indicador ${num}">
                <select class="form-select w-20 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    <option value="si">S铆</option>
                    <option value="no">No</option>
                    <option value="en-proceso">En proceso</option>
                </select>
                <input type="text" class="form-input flex-1 dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Observaciones">
                <button onclick="this.parentElement.remove()" class="btn-secondary text-sm px-2">-</button>
            `;
            container.appendChild(div);
            actualizarTotalIndicadores();
        }

        function agregarFilaInstrumento() {
            const tipo = document.getElementById('instTipo').value;
            
            switch(tipo) {
                case 'rubrica_analitica':
                    agregarFilaRubricaAnalitica();
                    break;
                case 'escala_numerica':
                    agregarFilaEscalaNumerica();
                    break;
                case 'escala_descriptiva':
                    agregarFilaEscalaDescriptiva();
                    break;
                case 'escala_desempeno':
                    agregarFilaEscalaDesempeno();
                    break;
                case 'lista_cotejo':
                    agregarFilaCotejo();
                    break;
                case 'registro_desempeno':
                    agregarFilaRegistroDesempeno();
                    break;
            }
        }

        function actualizarTotalIndicadores() {
            const inputs = document.querySelectorAll('.indicador-input');
            document.getElementById('totalIndicadores').textContent = inputs.length;
        }

        function actualizarVistaPreviaMEP() {
            const tipo = document.getElementById('instTipo').value;
            const nombre = document.getElementById('instNombre').value || 'Instrumento sin nombre';
            const aprendizaje = document.getElementById('instAprendizaje').value || 'No especificado';
            const asignatura = document.getElementById('instAsignatura').value || '______________';
            const nivel = document.getElementById('instNivel').value || '______________';
            
            document.getElementById('previewAprendizaje').textContent = aprendizaje;
            document.getElementById('previewAsignatura').textContent = asignatura;
            document.getElementById('previewNivel').textContent = nivel;
            document.getElementById('previewFecha').textContent = new Date().toLocaleDateString('es-CR');
            
            const container = document.getElementById('previewInstrumento');
            let html = '';
            
            switch(tipo) {
                case 'rubrica_holistica':
                    const criterios = document.querySelectorAll('.criterio-input');
                    html = `
                        <table class="tabla-indicadores-preview">
                            <thead>
                                <tr>
                                    <th class="dark:bg-gray-800 dark:text-white">Nivel</th>
                                    <th class="dark:bg-gray-800 dark:text-white">Descripci贸n</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="dark:text-gray-300">Avanzado</td>
                                    <td class="dark:text-gray-300">${criterios[0]?.value || '...'}</td>
                                </tr>
                                <tr>
                                    <td class="dark:text-gray-300">Intermedio</td>
                                    <td class="dark:text-gray-300">${criterios[1]?.value || '...'}</td>
                                </tr>
                                <tr>
                                    <td class="dark:text-gray-300">Inicial</td>
                                    <td class="dark:text-gray-300">${criterios[2]?.value || '...'}</td>
                                </tr>
                            </tbody>
                        </table>
                    `;
                    break;
                    
                case 'rubrica_analitica':
                    html = `
                        <table class="tabla-indicadores-preview">
                            <thead>
                                <tr>
                                    <th class="dark:bg-gray-800 dark:text-white">Indicador</th>
                                    <th class="dark:bg-gray-800 dark:text-white">Avanzado (4)</th>
                                    <th class="dark:bg-gray-800 dark:text-white">Intermedio (3)</th>
                                    <th class="dark:bg-gray-800 dark:text-white">Inicial (2)</th>
                                    <th class="dark:bg-gray-800 dark:text-white">Insuficiente (1)</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    document.querySelectorAll('#rubrica-analitica-items .rubrica-analitica-grid').forEach(fila => {
                        const inputs = fila.querySelectorAll('input');
                        if (inputs.length >= 5) {
                            html += `
                                <tr>
                                    <td class="dark:text-gray-300">${inputs[0]?.value || '...'}</td>
                                    <td class="dark:text-gray-300">${inputs[1]?.value || '...'}</td>
                                    <td class="dark:text-gray-300">${inputs[2]?.value || '...'}</td>
                                    <td class="dark:text-gray-300">${inputs[3]?.value || '...'}</td>
                                    <td class="dark:text-gray-300">${inputs[4]?.value || '...'}</td>
                                </tr>
                            `;
                        }
                    });
                    html += `</tbody></table>`;
                    break;
                    
                case 'lista_cotejo':
                    html = `
                        <table class="tabla-indicadores-preview">
                            <thead>
                                <tr>
                                    <th class="dark:bg-gray-800 dark:text-white">Criterio</th>
                                    <th class="text-center dark:bg-gray-800 dark:text-white">Cumple</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    document.querySelectorAll('#cotejo-items .cotejo-item').forEach(item => {
                        const input = item.querySelector('.indicador-input');
                        const checkbox = item.querySelector('input[type="checkbox"]');
                        html += `
                            <tr>
                                <td class="dark:text-gray-300">${input?.value || '...'}</td>
                                <td class="text-center dark:text-gray-300">${checkbox?.checked ? ' S铆' : '猬 No'}</td>
                            </tr>
                        `;
                    });
                    html += `</tbody></table>`;
                    break;
                    
                case 'escala_desempeno':
                    html = `
                        <table class="tabla-indicadores-preview">
                            <thead>
                                <tr>
                                    <th class="dark:bg-gray-800 dark:text-white">Indicador</th>
                                    <th class="text-center dark:bg-gray-800 dark:text-white">Nivel 1</th>
                                    <th class="text-center dark:bg-gray-800 dark:text-white">Nivel 2</th>
                                    <th class="text-center dark:bg-gray-800 dark:text-white">Nivel 3</th>
                                    <th class="text-center dark:bg-gray-800 dark:text-white">Nivel 4</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    document.querySelectorAll('#escala-desempeno-items .p-3').forEach(item => {
                        const input = item.querySelector('.indicador-input');
                        const inputs = item.querySelectorAll('input[type="text"]:not(.indicador-input)');
                        html += `
                            <tr>
                                <td class="dark:text-gray-300">${input?.value || '...'}</td>
                                <td class="text-center dark:text-gray-300">${inputs[0]?.value || '-'}</td>
                                <td class="text-center dark:text-gray-300">${inputs[1]?.value || '-'}</td>
                                <td class="text-center dark:text-gray-300">${inputs[2]?.value || '-'}</td>
                                <td class="text-center dark:text-gray-300">${inputs[3]?.value || '-'}</td>
                            </tr>
                        `;
                    });
                    html += `</tbody></table>`;
                    break;
                    
                case 'registro_anecdotico':
                    html = `
                        <div class="space-y-3">
                            <p class="dark:text-gray-300"><span class="font-medium">Estudiante:</span> ${document.getElementById('anecdoticoEstudiante')?.value || '______________'}</p>
                            <p class="dark:text-gray-300"><span class="font-medium">Fecha:</span> ${document.getElementById('anecdoticoFecha')?.value || '______________'}</p>
                            <p class="dark:text-gray-300"><span class="font-medium">Hora:</span> ${document.getElementById('anecdoticoHora')?.value || '______________'}</p>
                            <p class="dark:text-gray-300"><span class="font-medium">Actividad:</span> ${document.getElementById('anecdoticoActividad')?.value || '______________'}</p>
                            <div class="border-t dark:border-gray-700 pt-2">
                                <p class="font-medium dark:text-white">Descripci贸n:</p>
                                <p class="text-sm mt-1 dark:text-gray-300">${document.getElementById('anecdoticoDescripcion')?.value || '______________'}</p>
                            </div>
                            <div class="border-t dark:border-gray-700 pt-2">
                                <p class="font-medium dark:text-white">Interpretaci贸n:</p>
                                <p class="text-sm mt-1 dark:text-gray-300">${document.getElementById('anecdoticoInterpretacion')?.value || '______________'}</p>
                            </div>
                        </div>
                    `;
                    break;
            }
            
            container.innerHTML = html || '<p class="text-gray-500 dark:text-gray-400">Complete el instrumento para ver la vista previa</p>';
        }

        function guardarInstrumentoMEP() {
            const nombre = document.getElementById('instNombre').value.trim();
            if (!nombre) {
                Utils.mostrarToast('Ingrese el nombre del instrumento', 'error');
                return;
            }
            
            const tipo = document.getElementById('instTipo').value;
            const aprendizaje = document.getElementById('instAprendizaje').value;
            const asignatura = document.getElementById('instAsignatura').value.trim();
            const nivel = document.getElementById('instNivel').value;
            const puntuacionTotal = parseInt(document.getElementById('instPuntuacionTotal').value) || 100;
            const escala = document.getElementById('instEscala').value;
            
            const indicadores = [];
            
            switch(tipo) {
                case 'rubrica_holistica':
                    const criterios = document.querySelectorAll('.criterio-input');
                    indicadores.push({
                        avanzado: criterios[0]?.value || '',
                        intermedio: criterios[1]?.value || '',
                        inicial: criterios[2]?.value || ''
                    });
                    break;
                    
                case 'rubrica_analitica':
                    document.querySelectorAll('#rubrica-analitica-items .rubrica-analitica-grid').forEach(fila => {
                        const inputs = fila.querySelectorAll('input');
                        if (inputs.length >= 5 && inputs[0].value.trim()) {
                            indicadores.push({
                                indicador: inputs[0].value.trim(),
                                avanzado: inputs[1].value.trim(),
                                intermedio: inputs[2].value.trim(),
                                inicial: inputs[3].value.trim(),
                                insuficiente: inputs[4].value.trim()
                            });
                        }
                    });
                    break;
                    
                case 'lista_cotejo':
                    document.querySelectorAll('#cotejo-items .cotejo-item').forEach(item => {
                        const input = item.querySelector('.indicador-input');
                        const checkbox = item.querySelector('input[type="checkbox"]');
                        if (input && input.value.trim()) {
                            indicadores.push({
                                criterio: input.value.trim(),
                                cumple: checkbox.checked
                            });
                        }
                    });
                    break;
                    
                case 'registro_anecdotico':
                    indicadores.push({
                        estudiante: document.getElementById('anecdoticoEstudiante')?.value || '',
                        fecha: document.getElementById('anecdoticoFecha')?.value || '',
                        hora: document.getElementById('anecdoticoHora')?.value || '',
                        actividad: document.getElementById('anecdoticoActividad')?.value || '',
                        descripcion: document.getElementById('anecdoticoDescripcion')?.value || '',
                        interpretacion: document.getElementById('anecdoticoInterpretacion')?.value || ''
                    });
                    break;
            }
            
            if (indicadores.length === 0 && tipo !== 'registro_anecdotico') {
                Utils.mostrarToast('Debe agregar al menos un indicador', 'error');
                return;
            }
            
            const instrumento = {
                id: instrumentoEnEdicion || Utils.generarId(),
                tipo,
                nombre,
                aprendizaje,
                asignatura,
                nivel,
                puntuacionTotal,
                escala,
                indicadores,
                fecha: new Date().toISOString()
            };
            
            if (instrumentoEnEdicion) {
                const index = instrumentos.findIndex(i => i.id === instrumentoEnEdicion);
                if (index !== -1) {
                    instrumentos[index] = instrumento;
                    Utils.mostrarToast('Instrumento actualizado');
                }
            } else {
                instrumentos.push(instrumento);
                Utils.mostrarToast('Instrumento guardado');
            }
            
            DB.set('instrumentos', instrumentos);
            
            cerrarModal('instrumentoModal');
            renderizarInstrumentosMEP();
        }

        function renderizarInstrumentosMEP() {
            const container = document.getElementById('instrumentosLista');
            
            if (!instrumentos.length) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 col-span-full text-center py-8">No hay instrumentos creados. 隆Cree su primer instrumento siguiendo los formatos MEP!</p>';
                return;
            }
            
            container.innerHTML = instrumentos.map(i => {
                let tipoTexto = '';
                let tipoClase = '';
                
                switch(i.tipo) {
                    case 'rubrica_holistica': tipoTexto = 'R煤brica Hol铆stica'; tipoClase = 'tipo-rubrica'; break;
                    case 'rubrica_analitica': tipoTexto = 'R煤brica Anal铆tica'; tipoClase = 'tipo-rubrica'; break;
                    case 'escala_numerica': tipoTexto = 'Escala Num茅rica'; tipoClase = 'tipo-escala'; break;
                    case 'escala_descriptiva': tipoTexto = 'Escala Descriptiva'; tipoClase = 'tipo-escala'; break;
                    case 'escala_desempeno': tipoTexto = 'Escala de Desempe帽o'; tipoClase = 'tipo-desempeno'; break;
                    case 'lista_cotejo': tipoTexto = 'Lista de Cotejo'; tipoClase = 'tipo-cotejo'; break;
                    case 'registro_desempeno': tipoTexto = 'Registro de Desempe帽o'; tipoClase = 'tipo-desempeno'; break;
                    case 'registro_anecdotico': tipoTexto = 'Registro Anecd贸tico'; tipoClase = 'tipo-anecdotico'; break;
                }
                
                return `
                    <div class="instrumento-mep-card dark:bg-gray-800 dark:border-gray-700" onclick="verInstrumentoMEP('${i.id}')">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-bold text-lg dark:text-white">${i.nombre}</h4>
                            <span class="instrumento-tipo-badge ${tipoClase}">${tipoTexto}</span>
                        </div>
                        ${i.asignatura ? `<p class="text-sm text-gray-600 dark:text-gray-400 mb-1"> ${i.asignatura}</p>` : ''}
                        ${i.aprendizaje ? `<p class="text-xs text-gray-500 dark:text-gray-500 mb-3 line-clamp-2">${i.aprendizaje.substring(0, 100)}${i.aprendizaje.length > 100 ? '...' : ''}</p>` : ''}
                        <div class="mt-auto pt-3 flex justify-between items-center text-xs text-gray-400 dark:text-gray-500">
                            <span> ${i.indicadores?.length || 0} indicadores</span>
                            <span> ${new Date(i.fecha).toLocaleDateString()}</span>
                        </div>
                        <div class="mt-3 flex gap-2" onclick="event.stopPropagation()">
                            <button onclick="abrirModalInstrumentoMEP('${i.id}')" class="text-xs px-2 py-1 bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300 rounded hover:bg-blue-200 dark:hover:bg-blue-800">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            <button onclick="duplicarInstrumento('${i.id}')" class="text-xs px-2 py-1 bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300 rounded hover:bg-green-200 dark:hover:bg-green-800">
                                <i class="fas fa-copy"></i> Duplicar
                            </button>
                            <button onclick="eliminarInstrumento('${i.id}')" class="text-xs px-2 py-1 bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300 rounded hover:bg-red-200 dark:hover:bg-red-800">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filtrarInstrumentos() {
            renderizarInstrumentosMEP();
        }

        function verInstrumentoMEP(id) {
            const instrumento = instrumentos.find(i => i.id === id);
            if (!instrumento) return;
            
            actualInstrumentoId = id;
            const container = document.getElementById('verInstrumentoContenido');
            document.getElementById('verInstrumentoTitulo').textContent = instrumento.nombre;
            
            let tipoTexto = '';
            switch(instrumento.tipo) {
                case 'rubrica_holistica': tipoTexto = 'R煤brica Hol铆stica'; break;
                case 'rubrica_analitica': tipoTexto = 'R煤brica Anal铆tica'; break;
                case 'escala_numerica': tipoTexto = 'Escala Num茅rica'; break;
                case 'escala_descriptiva': tipoTexto = 'Escala Descriptiva'; break;
                case 'escala_desempeno': tipoTexto = 'Escala de Desempe帽o'; break;
                case 'lista_cotejo': tipoTexto = 'Lista de Cotejo'; break;
                case 'registro_desempeno': tipoTexto = 'Registro de Desempe帽o'; break;
                case 'registro_anecdotico': tipoTexto = 'Registro Anecd贸tico'; break;
            }
            
            let html = `
                <div class="border-b dark:border-gray-700 pb-4">
                    <div class="flex justify-between items-center">
                        <span class="instrumento-tipo-badge ${instrumento.tipo.includes('rubrica') ? 'tipo-rubrica' : instrumento.tipo.includes('escala') ? 'tipo-escala' : instrumento.tipo.includes('cotejo') ? 'tipo-cotejo' : 'tipo-desempeno'}">${tipoTexto}</span>
                    </div>
                    ${instrumento.asignatura ? `<p class="text-sm text-gray-600 dark:text-gray-400 mt-2"> Asignatura: ${instrumento.asignatura}</p>` : ''}
                    ${instrumento.aprendizaje ? `<p class="text-sm mt-2 dark:text-gray-300"><span class="font-medium">Aprendizaje:</span> ${instrumento.aprendizaje}</p>` : ''}
                </div>
            `;
            
            if (instrumento.tipo === 'rubrica_analitica' && instrumento.indicadores) {
                html += `
                    <table class="tabla-indicadores-preview">
                        <thead>
                            <tr>
                                <th class="dark:bg-gray-800 dark:text-white">Indicador</th>
                                <th class="dark:bg-gray-800 dark:text-white">Avanzado (4)</th>
                                <th class="dark:bg-gray-800 dark:text-white">Intermedio (3)</th>
                                <th class="dark:bg-gray-800 dark:text-white">Inicial (2)</th>
                                <th class="dark:bg-gray-800 dark:text-white">Insuficiente (1)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${instrumento.indicadores.map(ind => `
                                <tr>
                                    <td class="dark:text-gray-300">${ind.indicador || ''}</td>
                                    <td class="dark:text-gray-300">${ind.avanzado || ''}</td>
                                    <td class="dark:text-gray-300">${ind.intermedio || ''}</td>
                                    <td class="dark:text-gray-300">${ind.inicial || ''}</td>
                                    <td class="dark:text-gray-300">${ind.insuficiente || ''}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else if (instrumento.tipo === 'lista_cotejo') {
                html += `
                    <table class="tabla-indicadores-preview">
                        <thead>
                            <tr>
                                <th class="dark:bg-gray-800 dark:text-white">Criterio</th>
                                <th class="text-center dark:bg-gray-800 dark:text-white">Cumple</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${instrumento.indicadores.map(ind => `
                                <tr>
                                    <td class="dark:text-gray-300">${ind.criterio || ''}</td>
                                    <td class="text-center dark:text-gray-300">${ind.cumple ? ' S铆' : '猬 No'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else if (instrumento.tipo === 'registro_anecdotico') {
                const datos = instrumento.indicadores[0] || {};
                html += `
                    <div class="space-y-3">
                        <p class="dark:text-gray-300"><span class="font-medium">Estudiante:</span> ${datos.estudiante || '______________'}</p>
                        <p class="dark:text-gray-300"><span class="font-medium">Fecha:</span> ${datos.fecha || '______________'}</p>
                        <p class="dark:text-gray-300"><span class="font-medium">Hora:</span> ${datos.hora || '______________'}</p>
                        <p class="dark:text-gray-300"><span class="font-medium">Actividad:</span> ${datos.actividad || '______________'}</p>
                        <div class="border-t dark:border-gray-700 pt-2">
                            <p class="font-medium dark:text-white">Descripci贸n:</p>
                            <p class="text-sm mt-1 dark:text-gray-300">${datos.descripcion || '______________'}</p>
                        </div>
                        <div class="border-t dark:border-gray-700 pt-2">
                            <p class="font-medium dark:text-white">Interpretaci贸n:</p>
                            <p class="text-sm mt-1 dark:text-gray-300">${datos.interpretacion || '______________'}</p>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            document.getElementById('verInstrumentoModal').classList.add('active');
        }

        function abrirModalInstrumentoMEP(id = null) {
            cargarGruposSelect('instGrupo');
            
            if (id) {
                const instrumento = instrumentos.find(i => i.id === id);
                if (instrumento) {
                    instrumentoEnEdicion = id;
                    document.getElementById('instrumentoModalTitulo').textContent = 'Editar Instrumento - MEP';
                    
                    document.getElementById('instTipo').value = instrumento.tipo;
                    document.getElementById('instNombre').value = instrumento.nombre;
                    document.getElementById('instAprendizaje').value = instrumento.aprendizaje || '';
                    document.getElementById('instAsignatura').value = instrumento.asignatura || '';
                    document.getElementById('instNivel').value = instrumento.nivel || '';
                    document.getElementById('instPuntuacionTotal').value = instrumento.puntuacionTotal || 100;
                    document.getElementById('instEscala').value = instrumento.escala || '1-3';
                    
                    cambiarTipoInstrumentoMEP();
                    
                    setTimeout(() => {
                        // Aqu铆 se cargar铆an los indicadores guardados seg煤n el tipo
                    }, 200);
                }
            } else {
                instrumentoEnEdicion = null;
                document.getElementById('instrumentoModalTitulo').textContent = 'Crear Instrumento de Evaluaci贸n - MEP';
                document.getElementById('instTipo').value = 'rubrica_analitica';
                document.getElementById('instNombre').value = '';
                document.getElementById('instAprendizaje').value = '';
                document.getElementById('instAsignatura').value = '';
                document.getElementById('instNivel').value = '';
                document.getElementById('instPuntuacionTotal').value = '100';
                document.getElementById('instEscala').value = '1-3';
                
                cambiarTipoInstrumentoMEP();
            }
            
            cambiarPestanaInstrumento('basicos');
            document.getElementById('instrumentoModal').classList.add('active');
        }

        function editarInstrumentoDesdeVer() {
            cerrarModal('verInstrumentoModal');
            if (actualInstrumentoId) {
                abrirModalInstrumentoMEP(actualInstrumentoId);
            }
        }

        function duplicarInstrumento(id) {
            const original = instrumentos.find(i => i.id === id);
            if (!original) return;
            
            const copia = { ...original, id: Utils.generarId(), nombre: `${original.nombre} (copia)` };
            instrumentos.push(copia);
            DB.set('instrumentos', instrumentos);
            renderizarInstrumentosMEP();
            Utils.mostrarToast('Instrumento duplicado');
        }

        function eliminarInstrumento(id) {
            if (!Utils.confirmar('驴Eliminar este instrumento?')) return;
            
            instrumentos = instrumentos.filter(i => i.id !== id);
            DB.set('instrumentos', instrumentos);
            renderizarInstrumentosMEP();
            Utils.mostrarToast('Instrumento eliminado');
        }

        function exportarInstrumentoPDF() {
            const id = document.getElementById('verInstrumentoTitulo').textContent;
            const instrumento = instrumentos.find(i => i.nombre === id);
            if (!instrumento) return;
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.text(instrumento.nombre, 14, 15);
            doc.setFontSize(10);
            doc.text(`Tipo: ${instrumento.tipo}`, 14, 25);
            if (instrumento.asignatura) doc.text(`Asignatura: ${instrumento.asignatura}`, 14, 32);
            
            if (instrumento.tipo === 'rubrica_analitica') {
                const data = instrumento.indicadores.map(ind => [
                    ind.indicador || '',
                    ind.avanzado || '',
                    ind.intermedio || '',
                    ind.inicial || '',
                    ind.insuficiente || ''
                ]);
                
                doc.autoTable({
                    head: [['Indicador', 'Avanzado (4)', 'Intermedio (3)', 'Inicial (2)', 'Insuficiente (1)']],
                    body: data,
                    startY: 40,
                    styles: { fontSize: 8 }
                });
            } else if (instrumento.tipo === 'lista_cotejo') {
                const data = instrumento.indicadores.map(ind => [ind.criterio || '', ind.cumple ? 'S铆' : 'No']);
                doc.autoTable({
                    head: [['Criterio', 'Cumple']],
                    body: data,
                    startY: 40
                });
            }
            
            doc.save(`${instrumento.nombre}.pdf`);
            Utils.mostrarToast('Instrumento exportado a PDF');
        }

        // ==================== ASISTENCIA ====================
        function cargarGruposAsistencia() {
            const institucionId = document.getElementById('asistInstitucion').value;
            const selectGrupo = document.getElementById('asistGrupo');
            
            if (!institucionId) {
                selectGrupo.innerHTML = '<option value="">Seleccione...</option>';
                return;
            }
            
            const gruposFiltrados = grupos.filter(g => g.institucion === institucionId);
            selectGrupo.innerHTML = '<option value="">Seleccione...</option>' + 
                gruposFiltrados.map(g => `<option value="${g.id}">${g.nombre}</option>`).join('');
        }

        function cargarAsistencia() {
            const grupoId = document.getElementById('asistGrupo').value;
            const mes = document.getElementById('asistMes').value;
            
            if (!grupoId || !mes) {
                Utils.mostrarToast('Seleccione grupo y mes', 'error');
                return;
            }
            
            const estudiantesGrupo = estudiantes.filter(e => e.grupo === grupoId);
            if (!estudiantesGrupo.length) {
                Utils.mostrarToast('No hay estudiantes en este grupo', 'warning');
                return;
            }
            
            const [year, month] = mes.split('-').map(Number);
            const daysInMonth = new Date(year, month, 0).getDate();
            
            let header = '<tr><th class="px-2 py-2 border sticky left-0 bg-gray-50 dark:bg-gray-800 dark:text-white">Estudiante</th><th class="px-2 py-2 border text-center dark:bg-gray-800 dark:text-white">% Asist.</th>';
            for (let d = 1; d <= daysInMonth; d++) {
                header += `<th class="px-2 py-2 border text-center w-8 dark:bg-gray-800 dark:text-white">${d}</th>`;
            }
            header += '</tr>';
            document.getElementById('asistenciaHeader').innerHTML = header;
            
            const key = `${grupoId}_${mes}`;
            const data = asistencia[key] || {};
            
            let tbody = '';
            estudiantesGrupo.sort((a, b) => (a.numero || 0) - (b.numero || 0)).forEach(est => {
                let presentes = 0, total = 0, diasRow = '';
                for (let d = 1; d <= daysInMonth; d++) {
                    const diaKey = `${year}-${String(month).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    const valor = (data[est.id] && data[est.id][diaKey]) || 'P';
                    if (valor === 'P' || valor === 'J') presentes++;
                    total++;
                    diasRow += `<td class="px-2 py-2 border text-center">
                        <select class="asist-select w-10 text-xs p-1 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" data-est="${est.id}" data-dia="${diaKey}" onchange="actualizarAsistencia(this)">
                            <option value="P" ${valor === 'P' ? 'selected' : ''}>P</option>
                            <option value="A" ${valor === 'A' ? 'selected' : ''}>A</option>
                            <option value="J" ${valor === 'J' ? 'selected' : ''}>J</option>
                            <option value="T" ${valor === 'T' ? 'selected' : ''}>T</option>
                        </select>
                    </td>`;
                }
                const porcentaje = total ? ((presentes / total) * 100).toFixed(1) : 0;
                tbody += `<tr><td class="px-2 py-2 border sticky left-0 bg-white dark:bg-gray-800 font-medium dark:text-white">${est.nombre}</td>
                          <td class="px-2 py-2 border text-center font-bold dark:text-white">${porcentaje}%</td>${diasRow}</tr>`;
            });
            
            document.getElementById('asistenciaBody').innerHTML = tbody;
            document.getElementById('asistenciaContainer').classList.remove('hidden');
        }

        function actualizarAsistencia(select) {
            const estId = select.dataset.est;
            const dia = select.dataset.dia;
            const valor = select.value;
            const grupoId = document.getElementById('asistGrupo').value;
            const mes = document.getElementById('asistMes').value;
            
            const key = `${grupoId}_${mes}`;
            if (!asistencia[key]) asistencia[key] = {};
            if (!asistencia[key][estId]) asistencia[key][estId] = {};
            asistencia[key][estId][dia] = valor;
            DB.set('asistencia', asistencia);
            
            const row = select.closest('tr');
            const selects = row.querySelectorAll('.asist-select');
            let presentes = 0;
            selects.forEach(s => { if (s.value === 'P' || s.value === 'J') presentes++; });
            row.cells[1].textContent = ((presentes / selects.length) * 100).toFixed(1) + '%';
        }

        // ==================== BITCORA ====================
        function renderizarBitacora() {
            const tbody = document.getElementById('bitacoraTabla');
            
            if (!bitacora.length) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500 dark:text-gray-400">No hay registros</td></tr>';
                return;
            }
            
            bitacora.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            tbody.innerHTML = bitacora.map(e => `
                <tr>
                    <td class="dark:text-gray-300">${Utils.formatearFecha(e.fecha)}</td>
                    <td class="dark:text-gray-300">${e.tema}</td>
                    <td class="dark:text-gray-300">${e.actividad}</td>
                    <td class="dark:text-gray-300">${e.ajustes || '-'}</td>
                    <td>
                        <button onclick="eliminarEntradaBitacora('${e.id}')" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function agregarEntradaBitacora() {
            const fecha = document.getElementById('bitacoraFecha').value;
            const tema = document.getElementById('bitacoraTema').value.trim();
            const actividad = document.getElementById('bitacoraActividad').value.trim();
            
            if (!fecha || !tema || !actividad) {
                Utils.mostrarToast('Complete fecha, tema y actividad', 'error');
                return;
            }
            
            bitacora.push({
                id: Utils.generarId(),
                fecha,
                tema,
                actividad,
                ajustes: document.getElementById('bitacoraAjustes').value.trim()
            });
            
            DB.set('bitacora', bitacora);
            renderizarBitacora();
            Utils.mostrarToast('Entrada agregada');
            
            document.getElementById('bitacoraFecha').value = '';
            document.getElementById('bitacoraTema').value = '';
            document.getElementById('bitacoraActividad').value = '';
            document.getElementById('bitacoraAjustes').value = '';
        }

        function eliminarEntradaBitacora(id) {
            if (!Utils.confirmar('驴Eliminar esta entrada?')) return;
            
            bitacora = bitacora.filter(e => e.id !== id);
            DB.set('bitacora', bitacora);
            renderizarBitacora();
            Utils.mostrarToast('Entrada eliminada');
        }

        function exportarBitacoraWord() {
            let html = '<html><body><h1>Bit谩cora Docente</h1><table border="1"><tr><th>Fecha</th><th>Tema</th><th>Actividad</th><th>Ajustes DUA</th></tr>';
            bitacora.forEach(e => {
                html += `<tr><td>${e.fecha}</td><td>${e.tema}</td><td>${e.actividad}</td><td>${e.ajustes || ''}</td></tr>`;
            });
            html += '</table></body></html>';
            
            const blob = new Blob([html], { type: 'application/msword' });
            saveAs(blob, 'bitacora.doc');
            Utils.mostrarToast('Bit谩cora exportada a Word');
        }

        function exportarBitacoraPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text('Bit谩cora Docente', 14, 15);
            
            doc.autoTable({
                head: [['Fecha', 'Tema', 'Actividad', 'Ajustes']],
                body: bitacora.map(e => [e.fecha, e.tema, e.actividad, e.ajustes || ''])
            });
            doc.save('bitacora.pdf');
            Utils.mostrarToast('Bit谩cora exportada a PDF');
        }

        // ==================== REPORTES ====================
        function cargarGruposReportes() {
            const institucionId = document.getElementById('reportInstitucion').value;
            const selectGrupo = document.getElementById('reportGrupo');
            
            if (!institucionId) {
                selectGrupo.innerHTML = '<option value="">Seleccione...</option>';
                return;
            }
            
            const gruposFiltrados = grupos.filter(g => g.institucion === institucionId);
            selectGrupo.innerHTML = '<option value="">Seleccione...</option>' + 
                gruposFiltrados.map(g => `<option value="${g.id}">${g.nombre}</option>`).join('');
        }

        function generarReporte() {
            const grupoId = document.getElementById('reportGrupo').value;
            const periodo = document.getElementById('reportPeriodo').value;
            
            if (!grupoId || !periodo) {
                Utils.mostrarToast('Seleccione grupo y periodo', 'error');
                return;
            }
            
            const grupo = grupos.find(g => g.id === grupoId);
            if (!grupo) return;
            
            const estudiantesGrupo = estudiantes.filter(e => e.grupo === grupoId);
            if (!estudiantesGrupo.length) {
                Utils.mostrarToast('No hay estudiantes en este grupo', 'warning');
                return;
            }
            
            const asignaturas = grupo.asignaturas ? grupo.asignaturas.split(',').map(a => a.trim()) : ['Matem谩tica'];
            const selectAsig = document.getElementById('reportAsignatura');
            selectAsig.innerHTML = '<option value="">Todas</option>' + asignaturas.map(a => `<option value="${a}">${a}</option>`).join('');
            
            let reportData = [];
            
            estudiantesGrupo.forEach(est => {
                let suma = 0, count = 0;
                let tcTotal = 0, tareasTotal = 0, pruebasTotal = 0, proyectoTotal = 0;
                
                asignaturas.forEach(asig => {
                    const key = `${grupoId}_${periodo}_${asig}`;
                    if (notas[key] && notas[key][est.id]) {
                        const n = notas[key][est.id];
                        if (n['Trabajo Cotidiano']) { tcTotal += n['Trabajo Cotidiano']; suma += n['Trabajo Cotidiano']; count++; }
                        if (n['Tareas']) { tareasTotal += n['Tareas']; suma += n['Tareas']; count++; }
                        if (n['Pruebas']) { pruebasTotal += n['Pruebas']; suma += n['Pruebas']; count++; }
                        if (n['Proyecto']) { proyectoTotal += n['Proyecto']; suma += n['Proyecto']; count++; }
                    }
                });
                
                const promedio = count ? (suma / count).toFixed(2) : 0;
                let condicion = promedio >= 65 ? 'Aprobado' : promedio >= 50 ? 'En riesgo' : 'Reprobado';
                
                reportData.push({
                    nombre: est.nombre,
                    numero: est.numero || '-',
                    tc: tcTotal,
                    tareas: tareasTotal,
                    pruebas: pruebasTotal,
                    proyecto: proyectoTotal,
                    promedio: +promedio,
                    condicion
                });
            });
            
            reportData.sort((a, b) => b.promedio - a.promedio);
            
            document.getElementById('top1').textContent = reportData[0]?.nombre || '-';
            document.getElementById('top1Nota').textContent = reportData[0]?.promedio || '-';
            document.getElementById('top2').textContent = reportData[1]?.nombre || '-';
            document.getElementById('top2Nota').textContent = reportData[1]?.promedio || '-';
            document.getElementById('top3').textContent = reportData[2]?.nombre || '-';
            document.getElementById('top3Nota').textContent = reportData[2]?.promedio || '-';
            
            document.getElementById('reporteHeader').innerHTML = `
                <tr>
                    <th class="dark:text-white">#</th>
                    <th class="dark:text-white">Estudiante</th>
                    <th class="text-center dark:text-white">TC</th>
                    <th class="text-center dark:text-white">Tareas</th>
                    <th class="text-center dark:text-white">Pruebas</th>
                    <th class="text-center dark:text-white">Proyecto</th>
                    <th class="text-center dark:text-white">Prom.</th>
                    <th class="text-center dark:text-white">Condici贸n</th>
                </tr>
            `;
            
            document.getElementById('reporteTabla').innerHTML = reportData.map((item, idx) => {
                let badgeClass = 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300';
                if (item.condicion === 'En riesgo') badgeClass = 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300';
                else if (item.condicion === 'Reprobado') badgeClass = 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300';
                
                return `
                    <tr>
                        <td class="dark:text-gray-300">${idx+1}</td>
                        <td class="dark:text-gray-300">${item.nombre}</td>
                        <td class="text-center dark:text-gray-300">${item.tc}</td>
                        <td class="text-center dark:text-gray-300">${item.tareas}</td>
                        <td class="text-center dark:text-gray-300">${item.pruebas}</td>
                        <td class="text-center dark:text-gray-300">${item.proyecto}</td>
                        <td class="text-center font-bold dark:text-white">${item.promedio}</td>
                        <td class="text-center">
                            <span class="badge ${badgeClass}">${item.condicion}</span>
                        </td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('reporteContainer').classList.remove('hidden');
        }

        function exportarReportePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text('Reporte por Periodo', 14, 15);
            
            const data = [];
            document.querySelectorAll('#reporteTabla tr').forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length) {
                    data.push([cells[0].textContent, cells[1].textContent, cells[2].textContent, cells[3].textContent, cells[4].textContent, cells[5].textContent, cells[6].textContent, cells[7].textContent]);
                }
            });
            
            doc.autoTable({
                head: [['#', 'Estudiante', 'TC', 'Tareas', 'Pruebas', 'Proy', 'Prom', 'Condici贸n']],
                body: data
            });
            doc.save('reporte.pdf');
            Utils.mostrarToast('Reporte exportado a PDF');
        }

        function exportarReporteWord() {
            const tabla = document.querySelector('#reporteTabla').parentElement.outerHTML;
            const top = document.querySelector('.grid.md\\:grid-cols-3.gap-4').outerHTML;
            const html = `<html><body><h1>Reporte por Periodo</h1>${top}${tabla}</body></html>`;
            saveAs(new Blob([html], { type: 'application/msword' }), 'reporte.doc');
            Utils.mostrarToast('Reporte exportado a Word');
        }

        function exportarReporteCSV() {
            let csv = '#,Estudiante,TC,Tareas,Pruebas,Proyecto,Promedio,Condici贸n\n';
            document.querySelectorAll('#reporteTabla tr').forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length) {
                    csv += `${cells[0].textContent},"${cells[1].textContent}",${cells[2].textContent},${cells[3].textContent},${cells[4].textContent},${cells[5].textContent},${cells[6].textContent},"${cells[7].textContent}"\n`;
                }
            });
            saveAs(new Blob([csv], { type: 'text/csv' }), 'reporte.csv');
            Utils.mostrarToast('Reporte exportado a CSV');
        }

        // ==================== ACTA FINAL ====================
        function cargarGruposActa() {
            const institucionId = document.getElementById('actaInstitucion').value;
            const selectGrupo = document.getElementById('actaGrupo');
            
            if (!institucionId) {
                selectGrupo.innerHTML = '<option value="">Seleccione...</option>';
                return;
            }
            
            const gruposFiltrados = grupos.filter(g => g.institucion === institucionId);
            selectGrupo.innerHTML = '<option value="">Seleccione...</option>' + 
                gruposFiltrados.map(g => `<option value="${g.id}">${g.nombre}</option>`).join('');
        }

        function generarActaFinal() {
            const grupoId = document.getElementById('actaGrupo').value;
            
            if (!grupoId) {
                Utils.mostrarToast('Seleccione un grupo', 'error');
                return;
            }
            
            const estudiantesGrupo = estudiantes.filter(e => e.grupo === grupoId);
            if (!estudiantesGrupo.length) {
                Utils.mostrarToast('No hay estudiantes en este grupo', 'warning');
                return;
            }
            
            const grupo = grupos.find(g => g.id === grupoId);
            const asignaturas = grupo?.asignaturas ? grupo.asignaturas.split(',').map(a => a.trim()) : ['Matem谩tica'];
            
            let tbody = '';
            
            estudiantesGrupo.sort((a, b) => (a.numero || 0) - (b.numero || 0)).forEach(est => {
                let sumaPeriodos = 0, periodosCompletos = 0;
                let notasPeriodos = { I: '-', II: '-', III: '-' };
                
                ['I', 'II', 'III'].forEach(per => {
                    let sumaAsignaturas = 0, count = 0;
                    asignaturas.forEach(asig => {
                        const key = `${grupoId}_${per}_${asig}`;
                        if (notas[key] && notas[key][est.id]) {
                            const n = notas[key][est.id];
                            let tieneNota = false;
                            let sumaNotas = 0;
                            let componentesCount = 0;
                            
                            Object.entries(n).forEach(([campo, valor]) => {
                                if (valor && (campo.includes('Trabajo') || campo.includes('Tareas') || campo.includes('Pruebas') || campo.includes('Proyecto'))) {
                                    sumaNotas += valor;
                                    componentesCount++;
                                    tieneNota = true;
                                }
                            });
                            
                            if (tieneNota && componentesCount > 0) {
                                const promedio = sumaNotas / componentesCount;
                                sumaAsignaturas += promedio;
                                count++;
                            }
                        }
                    });
                    
                    if (count > 0) {
                        const promedioPeriodo = (sumaAsignaturas / count).toFixed(2);
                        notasPeriodos[per] = promedioPeriodo;
                        sumaPeriodos += parseFloat(promedioPeriodo);
                        periodosCompletos++;
                    }
                });
                
                const promedioAnual = periodosCompletos ? (sumaPeriodos / periodosCompletos).toFixed(2) : 0;
                const pne = 65;
                const notaFinal = ((parseFloat(promedioAnual) * 0.5) + (pne * 0.5)).toFixed(2);
                const condicion = notaFinal >= 65 ? 'Aprobado' : notaFinal >= 50 ? 'Convocatoria' : 'Reprobado';
                
                let badgeClass = 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300';
                if (condicion === 'Convocatoria') badgeClass = 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300';
                else if (condicion === 'Reprobado') badgeClass = 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300';
                
                tbody += `
                    <tr>
                        <td class="dark:text-gray-300">${est.nombre}</td>
                        <td class="text-center dark:text-gray-300">${notasPeriodos.I}</td>
                        <td class="text-center dark:text-gray-300">${notasPeriodos.II}</td>
                        <td class="text-center dark:text-gray-300">${notasPeriodos.III}</td>
                        <td class="text-center font-bold dark:text-white">${promedioAnual}</td>
                        <td class="text-center dark:text-gray-300">${pne}</td>
                        <td class="text-center font-bold dark:text-white">${notaFinal}</td>
                        <td class="text-center">
                            <span class="badge ${badgeClass}">${condicion}</span>
                        </td>
                    </tr>
                `;
            });
            
            document.getElementById('actaTabla').innerHTML = tbody;
            document.getElementById('actaContainer').classList.remove('hidden');
        }

        function exportarActaPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape');
            doc.text('Acta Final de Calificaciones', 14, 15);
            
            const data = [];
            document.querySelectorAll('#actaTabla tr').forEach(row => {
                const cells = row.querySelectorAll('td');
                data.push([cells[0].textContent, cells[1].textContent, cells[2].textContent, cells[3].textContent, cells[4].textContent, cells[5].textContent, cells[6].textContent, cells[7].textContent]);
            });
            
            doc.autoTable({
                head: [['Estudiante', 'I Per', 'II Per', 'III Per', 'Prom Anual', 'PNE', 'Nota Final', 'Condici贸n']],
                body: data,
                styles: { fontSize: 8 }
            });
            doc.save('acta_final.pdf');
            Utils.mostrarToast('Acta exportada a PDF');
        }

        function exportarActaWord() {
            const tabla = document.querySelector('#actaTabla').parentElement.outerHTML;
            const html = `<html><body><h1>Acta Final</h1>${tabla}</body></html>`;
            saveAs(new Blob([html], { type: 'application/msword' }), 'acta_final.doc');
            Utils.mostrarToast('Acta exportada a Word');
        }

        // ==================== RESPALDO ====================
        function exportarRespaldoJSON() {
            const backup = {
                instituciones,
                grupos,
                estudiantes,
                notas,
                asistencia,
                bitacora,
                instrumentos,
                configuracionesEvaluacion,
                fecha: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            saveAs(blob, `respaldo_mep_${new Date().toISOString().slice(0,10)}.json`);
            Utils.mostrarToast('Respaldo JSON exportado');
        }

        function importarRespaldo() {
            const file = document.getElementById('backupInput').files[0];
            if (!file) {
                Utils.mostrarToast('Seleccione un archivo', 'error');
                return;
            }
            
            if (!Utils.confirmar('驴Restaurar respaldo? Se perder谩n los datos actuales.')) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const backup = JSON.parse(e.target.result);
                    
                    if (backup.instituciones) instituciones = backup.instituciones;
                    if (backup.grupos) grupos = backup.grupos;
                    if (backup.estudiantes) estudiantes = backup.estudiantes;
                    if (backup.notas) notas = backup.notas;
                    if (backup.asistencia) asistencia = backup.asistencia;
                    if (backup.bitacora) bitacora = backup.bitacora;
                    if (backup.instrumentos) instrumentos = backup.instrumentos;
                    if (backup.configuracionesEvaluacion) configuracionesEvaluacion = backup.configuracionesEvaluacion;
                    
                    DB.set('instituciones', instituciones);
                    DB.set('grupos', grupos);
                    DB.set('estudiantes', estudiantes);
                    DB.set('notas', notas);
                    DB.set('asistencia', asistencia);
                    DB.set('bitacora', bitacora);
                    DB.set('instrumentos', instrumentos);
                    DB.set('configuracionesEvaluacion', configuracionesEvaluacion);
                    
                    Utils.mostrarToast('Respaldo restaurado');
                    
                    if (document.getElementById('instituciones').classList.contains('active')) {
                        renderizarInstituciones();
                    }
                } catch {
                    Utils.mostrarToast('Error al leer el archivo', 'error');
                }
            };
            reader.readAsText(file);
            document.getElementById('backupInput').value = '';
        }

        function exportarTodoCSV() {
            let csvEst = 'Instituci贸n,Grupo,N煤mero,Nombre,Tel茅fono,Correo,Condici贸n,Observaciones\n';
            estudiantes.forEach(e => {
                const grupo = grupos.find(g => g.id === e.grupo);
                const institucion = grupo ? instituciones.find(i => i.id === grupo.institucion) : null;
                csvEst += `"${institucion ? institucion.nombre : ''}","${grupo ? grupo.nombre : ''}",${e.numero || ''},"${e.nombre}","${e.telefono || ''}","${e.correo || ''}",${e.condicion},"${e.observaciones || ''}"\n`;
            });
            
            const blobEst = new Blob([csvEst], { type: 'text/csv' });
            saveAs(blobEst, 'estudiantes.csv');
            
            Utils.mostrarToast('Exportaci贸n completada');
        }

        // ==================== ALERTAS ====================
        function mostrarAlertas() {
            const alertas = [];
            
            estudiantes.forEach(est => {
                let bajo = false;
                Object.keys(notas).forEach(key => {
                    if (notas[key][est.id]) {
                        const n = notas[key][est.id];
                        let suma = 0, count = 0;
                        
                        Object.values(n).forEach(v => {
                            if (v) { suma += v; count++; }
                        });
                        
                        if (count > 0) {
                            const promedio = suma / count;
                            if (promedio < 65) bajo = true;
                        }
                    }
                });
                if (bajo) {
                    alertas.push(`锔 ${est.nombre} tiene promedio bajo (menor a 65)`);
                }
            });
            
            const lista = document.getElementById('alertasLista');
            if (!alertas.length) {
                lista.innerHTML = '<p class="text-gray-500 dark:text-gray-400">No hay alertas</p>';
            } else {
                lista.innerHTML = alertas.map(a => `<div class="p-2 bg-yellow-50 dark:bg-yellow-900 dark:text-yellow-200 rounded">${a}</div>`).join('');
            }
            
            document.getElementById('alertasModal').classList.add('active');
        }

        // ==================== PRUEBAS ====================
        function ejecutarPruebas() {
            try {
                Utils.mostrarToast(' Sistema funcionando correctamente', 'success');
            } catch (error) {
                Utils.mostrarToast(' Error en pruebas: ' + error.message, 'error');
            }
        }

        // ==================== INICIALIZACIN ====================
        document.addEventListener('DOMContentLoaded', () => {
            const darkModePreference = localStorage.getItem('mep_darkMode');
            if (darkModePreference === 'true') {
                document.documentElement.classList.add('dark');
                document.getElementById('darkModeIcon').className = 'fas fa-sun w-6 text-gray-600 dark:text-gray-400';
                document.getElementById('darkModeText').textContent = 'Modo Claro';
            }
            
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('es-CR', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });
            
            if (document.getElementById('instituciones').classList.contains('active')) {
                renderizarInstituciones();
            }
        });
    </script>
</body>
</html>
