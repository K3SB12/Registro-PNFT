<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIGD-MEP 2026 - Sistema Profesional Docente</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- jsPDF y autotable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <!-- SheetJS para Excel/CSV -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <!-- FileSaver.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background: #f3f4f6;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 280px;
            height: 100vh;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .sidebar.open {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0 !important;
            }
            .menu-btn {
                display: flex !important;
            }
        }

        @media (min-width: 769px) {
            .sidebar {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 280px;
            }
            .menu-btn {
                display: none !important;
            }
        }

        .main-content {
            transition: margin-left 0.3s ease;
            height: 100vh;
            overflow-y: auto;
        }

        .menu-btn {
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 1100;
            background: #1e3a8a;
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 8px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            backdrop-filter: blur(3px);
        }

        .overlay.active {
            display: block;
        }

        .tab-pane {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-pane.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border: 1px solid #e5e7eb;
            margin-bottom: 1.5rem;
        }

        .dark .card {
            background: #1f2937;
            border-color: #374151;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1e3a8a, #3b82f6);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(30, 58, 138, 0.3);
        }

        .btn-secondary {
            background: white;
            color: #1e3a8a;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-secondary:hover {
            background: #f9fafb;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
            color: #374151;
        }

        .dark .form-label {
            color: #e5e7eb;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            transition: all 0.2s;
            font-size: 1rem;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .dark .form-input, .dark .form-select {
            background: #374151;
            border-color: #4b5563;
            color: white;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f9fafb;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.875rem;
            border-bottom: 2px solid #e5e7eb;
        }

        .dark th {
            background: #374151;
            border-bottom-color: #4b5563;
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .dark td {
            border-bottom-color: #374151;
        }

        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-warning {
            background: #fed7aa;
            color: #92400e;
        }

        .badge-danger {
            background: #fee2e2;
            color: #b91c1c;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .dark .modal-content {
            background: #1f2937;
        }

        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: #1f2937;
            color: white;
            padding: 1rem 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(200%);
            transition: transform 0.3s;
            z-index: 2100;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .toast.show {
            transform: translateY(0);
        }

        .component-chip {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            background: #f3f4f6;
            border-radius: 9999px;
            font-size: 0.875rem;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            border: 1px solid #d1d5db;
        }

        .dark .component-chip {
            background: #374151;
            border-color: #4b5563;
        }

        .component-chip.active {
            background: #dbeafe;
            border-color: #3b82f6;
            color: #1e3a8a;
        }

        .instrumento-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            transition: all 0.2s;
        }

        .instrumento-card:hover {
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <!-- BotÃ³n menÃº hamburguesa -->
    <button class="menu-btn" onclick="toggleMenu()" id="menuBtn">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Overlay -->
    <div class="overlay" id="overlay" onclick="closeMenu()"></div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <!-- Logo -->
        <div class="p-6 bg-gradient-to-r from-blue-900 to-blue-700 text-white">
            <h1 class="text-2xl font-bold">SIGD-MEP 2026</h1>
            <p class="text-sm opacity-90">Sistema Profesional Docente</p>
        </div>

        <!-- NavegaciÃ³n -->
        <nav class="p-4">
            <button onclick="showTab('dashboard')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-blue-50 dark:hover:bg-gray-700 mb-1 flex items-center gap-3">
                <i class="fas fa-home w-6 text-blue-600"></i>
                <span>Dashboard</span>
            </button>
            <button onclick="showTab('centros')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-blue-50 dark:hover:bg-gray-700 mb-1 flex items-center gap-3">
                <i class="fas fa-school w-6 text-green-600"></i>
                <span>Centros Educativos</span>
            </button>
            <button onclick="showTab('grupos')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-blue-50 dark:hover:bg-gray-700 mb-1 flex items-center gap-3">
                <i class="fas fa-users w-6 text-purple-600"></i>
                <span>Grupos y Estudiantes</span>
            </button>
            <button onclick="showTab('evaluacion')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-blue-50 dark:hover:bg-gray-700 mb-1 flex items-center gap-3">
                <i class="fas fa-calculator w-6 text-orange-600"></i>
                <span>EvaluaciÃ³n</span>
            </button>
            <button onclick="showTab('instrumentos')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-blue-50 dark:hover:bg-gray-700 mb-1 flex items-center gap-3">
                <i class="fas fa-clipboard-list w-6 text-red-600"></i>
                <span>Instrumentos</span>
            </button>
            <button onclick="showTab('asistencia')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-blue-50 dark:hover:bg-gray-700 mb-1 flex items-center gap-3">
                <i class="fas fa-calendar-check w-6 text-indigo-600"></i>
                <span>Asistencia</span>
            </button>
            <button onclick="showTab('bitacora')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-blue-50 dark:hover:bg-gray-700 mb-1 flex items-center gap-3">
                <i class="fas fa-book w-6 text-pink-600"></i>
                <span>BitÃ¡cora</span>
            </button>
            <button onclick="showTab('reportes')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-blue-50 dark:hover:bg-gray-700 mb-1 flex items-center gap-3">
                <i class="fas fa-chart-bar w-6 text-teal-600"></i>
                <span>Reportes</span>
            </button>
            <button onclick="showTab('acta')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-blue-50 dark:hover:bg-gray-700 mb-1 flex items-center gap-3">
                <i class="fas fa-file-signature w-6 text-amber-600"></i>
                <span>Acta Final</span>
            </button>
            <button onclick="showTab('respaldo')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-blue-50 dark:hover:bg-gray-700 mb-1 flex items-center gap-3">
                <i class="fas fa-database w-6 text-gray-600"></i>
                <span>Respaldo</span>
            </button>
        </nav>

        <!-- Footer -->
        <div class="absolute bottom-0 w-full p-4 border-t dark:border-gray-700 bg-white dark:bg-gray-800">
            <button onclick="toggleDarkMode()" class="w-full flex items-center px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                <i class="fas fa-moon w-6" id="darkModeIcon"></i>
                <span id="darkModeText">Modo Oscuro</span>
            </button>
            <button onclick="runTests()" class="w-full flex items-center px-4 py-2 text-sm text-blue-600 hover:bg-blue-50 dark:hover:bg-gray-700 rounded-lg mt-2">
                <i class="fas fa-vial w-6"></i>
                <span>Pruebas del Sistema</span>
            </button>
            <a href="https://k3sb12.github.io/Plantilla-planeamiento-PNFT/" target="_blank" class="w-full flex items-center px-4 py-2 text-sm text-green-600 hover:bg-green-50 dark:hover:bg-gray-700 rounded-lg mt-2">
                <i class="fas fa-external-link-alt w-6"></i>
                <span>Acceso a PIA</span>
            </a>
        </div>
    </aside>

    <!-- Contenido Principal -->
    <main class="main-content" id="mainContent">
        <!-- Header -->
        <header class="bg-white dark:bg-gray-800 shadow-sm px-6 py-4 flex items-center justify-between sticky top-0 z-40">
            <div class="flex items-center gap-4">
                <h2 id="pageTitle" class="text-xl font-semibold">Dashboard</h2>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="showAlerts()" class="relative p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full">
                    <i class="fas fa-bell text-xl"></i>
                    <span id="alertBadge" class="absolute top-0 right-0 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
                </button>
                <span id="currentDate" class="text-sm text-gray-600 dark:text-gray-400"></span>
            </div>
        </header>

        <!-- Contenido -->
        <div class="p-6">
            <!-- DASHBOARD -->
            <div id="dashboard" class="tab-pane active">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="card text-center">
                        <i class="fas fa-school text-4xl text-blue-600 mb-2"></i>
                        <p class="text-3xl font-bold" id="dashCentros">0</p>
                        <p class="text-gray-600">Centros</p>
                    </div>
                    <div class="card text-center">
                        <i class="fas fa-users text-4xl text-green-600 mb-2"></i>
                        <p class="text-3xl font-bold" id="dashGrupos">0</p>
                        <p class="text-gray-600">Grupos</p>
                    </div>
                    <div class="card text-center">
                        <i class="fas fa-user-graduate text-4xl text-purple-600 mb-2"></i>
                        <p class="text-3xl font-bold" id="dashEstudiantes">0</p>
                        <p class="text-gray-600">Estudiantes</p>
                    </div>
                    <div class="card text-center">
                        <i class="fas fa-file-alt text-4xl text-orange-600 mb-2"></i>
                        <p class="text-3xl font-bold" id="dashInstrumentos">0</p>
                        <p class="text-gray-600">Instrumentos</p>
                    </div>
                </div>

                <div class="card">
                    <h3 class="text-lg font-semibold mb-4">Bienvenido al Sistema Integral de GestiÃ³n Docente MEP 2026</h3>
                    <p class="text-gray-600 dark:text-gray-400 mb-4">Este sistema ha sido actualizado con los lineamientos tÃ©cnicos de evaluaciÃ³n para el aprendizaje del curso lectivo 2026, cumpliendo con la normativa del Ministerio de EducaciÃ³n PÃºblica de Costa Rica.</p>
                    
                    <div class="grid md:grid-cols-2 gap-6 mt-6">
                        <div class="border-l-4 border-blue-600 pl-4">
                            <h4 class="font-semibold">Primaria (1Â° a 6Â°)</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Componentes: Trabajo Cotidiano, Tareas, Pruebas</p>
                        </div>
                        <div class="border-l-4 border-green-600 pl-4">
                            <h4 class="font-semibold">Secundaria (7Â° a 12Â°)</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Componentes: Trabajo Cotidiano, Tareas, Prueba o Proyecto (segÃºn corresponda)</p>
                        </div>
                        <div class="border-l-4 border-purple-600 pl-4">
                            <h4 class="font-semibold">TÃ©cnica / CINDEA</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Componentes adicionales: Portafolio, DemostraciÃ³n de lo aprendido</p>
                        </div>
                        <div class="border-l-4 border-orange-600 pl-4">
                            <h4 class="font-semibold">Asistencia</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Aplica como componente en todas las modalidades</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CENTROS EDUCATIVOS -->
            <div id="centros" class="tab-pane">
                <div class="card">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Mis Centros Educativos</h3>
                        <button onclick="abrirModalCentro()" class="btn-primary">
                            <i class="fas fa-plus"></i> Nuevo Centro
                        </button>
                    </div>
                    
                    <div id="centrosLista" class="space-y-4"></div>
                </div>
            </div>

            <!-- GRUPOS Y ESTUDIANTES -->
            <div id="grupos" class="tab-pane">
                <div class="flex flex-wrap gap-4 justify-between items-center mb-6">
                    <div class="flex gap-2">
                        <button onclick="abrirModalGrupo()" class="btn-primary">
                            <i class="fas fa-plus"></i> Nuevo Grupo
                        </button>
                        <button onclick="document.getElementById('csvInput').click()" class="btn-secondary">
                            <i class="fas fa-file-import"></i> Importar CSV
                        </button>
                        <input type="file" id="csvInput" accept=".csv" class="hidden" onchange="importarCSV(this)">
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-sm">Filtrar por centro:</label>
                        <select id="filtroCentroGrupos" class="form-select w-64" onchange="filtrarGruposPorCentro()">
                            <option value="">Todos los centros</option>
                        </select>
                    </div>
                </div>

                <div id="gruposContainer" class="grid grid-cols-1 lg:grid-cols-2 gap-6"></div>
            </div>

            <!-- EVALUACIÃ“N -->
            <div id="evaluacion" class="tab-pane">
                <div class="card">
                    <div class="grid md:grid-cols-3 gap-4 mb-6">
                        <div>
                            <label class="form-label">Centro Educativo</label>
                            <select id="evalCentro" class="form-select" onchange="cargarGruposPorCentro('evalGrupo', this.value)">
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">Grupo</label>
                            <select id="evalGrupo" class="form-select" onchange="cargarComponentesPorGrupo()">
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">Periodo</label>
                            <select id="evalPeriodo" class="form-select">
                                <option value="I">Periodo I</option>
                                <option value="II">Periodo II</option>
                                <option value="III">Periodo III</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">Asignatura</label>
                            <input type="text" id="evalAsignatura" class="form-input" placeholder="Ej: MatemÃ¡tica">
                        </div>
                        <div class="flex items-end">
                            <button onclick="cargarTablaEvaluacion()" class="btn-primary w-full">
                                <i class="fas fa-search"></i> Cargar
                            </button>
                        </div>
                    </div>

                    <!-- Componentes activos -->
                    <div id="componentesContainer" class="mb-4 p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                        <p class="text-sm font-medium mb-2">Componentes activos para este grupo:</p>
                        <div id="componentesLista" class="flex flex-wrap"></div>
                    </div>

                    <div id="evaluacionTableContainer" class="hidden">
                        <div class="table-container">
                            <table>
                                <thead id="evalTableHeader"></thead>
                                <tbody id="evaluacionTableBody"></tbody>
                            </table>
                        </div>
                        
                        <div class="mt-4 flex justify-between items-center p-4 bg-blue-50 dark:bg-blue-900 rounded-lg">
                            <div>
                                <p class="text-sm font-medium">Promedio del Grupo: <span id="promedioGrupo" class="text-2xl font-bold">0.00</span></p>
                            </div>
                            <button onclick="guardarNotas()" class="btn-primary">
                                <i class="fas fa-save"></i> Guardar Notas
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- INSTRUMENTOS -->
            <div id="instrumentos" class="tab-pane">
                <div class="card">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-semibold">Mis Instrumentos de EvaluaciÃ³n</h3>
                        <button onclick="abrirModalInstrumento()" class="btn-primary">
                            <i class="fas fa-plus"></i> Nuevo Instrumento
                        </button>
                    </div>

                    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4" id="instrumentosLista"></div>
                </div>
            </div>

            <!-- ASISTENCIA -->
            <div id="asistencia" class="tab-pane">
                <div class="card">
                    <div class="grid md:grid-cols-3 gap-4 mb-6">
                        <div>
                            <label class="form-label">Centro Educativo</label>
                            <select id="asistCentro" class="form-select" onchange="cargarGruposPorCentro('asistGrupo', this.value)">
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">Grupo</label>
                            <select id="asistGrupo" class="form-select"></select>
                        </div>
                        <div>
                            <label class="form-label">Mes</label>
                            <input type="month" id="asistMes" class="form-input">
                        </div>
                        <div class="flex items-end">
                            <button onclick="cargarAsistencia()" class="btn-primary w-full">
                                <i class="fas fa-calendar-check"></i> Cargar
                            </button>
                        </div>
                    </div>

                    <div id="asistenciaContainer" class="hidden">
                        <div class="table-container">
                            <table class="border-collapse">
                                <thead id="asistenciaHeader"></thead>
                                <tbody id="asistenciaBody"></tbody>
                            </table>
                        </div>
                        <div class="mt-4 flex gap-2 text-sm">
                            <span class="badge-success px-3 py-1 rounded">P = Presente</span>
                            <span class="badge-danger px-3 py-1 rounded">A = Ausente</span>
                            <span class="badge-warning px-3 py-1 rounded">T = TardÃ­a</span>
                            <span class="badge bg-blue-100 text-blue-800 px-3 py-1 rounded">J = Justificada</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- BITÃCORA -->
            <div id="bitacora" class="tab-pane">
                <div class="card">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-semibold">BitÃ¡cora Docente</h3>
                        <div class="flex gap-2">
                            <button onclick="exportarBitacoraWord()" class="btn-secondary">
                                <i class="fas fa-file-word"></i> Word
                            </button>
                            <button onclick="exportarBitacoraPDF()" class="btn-secondary">
                                <i class="fas fa-file-pdf"></i> PDF
                            </button>
                        </div>
                    </div>

                    <div class="grid md:grid-cols-2 gap-4 mb-6">
                        <input type="date" id="bitacoraFecha" class="form-input">
                        <input type="text" id="bitacoraTema" class="form-input" placeholder="Tema">
                        <input type="text" id="bitacoraActividad" class="form-input" placeholder="Actividad">
                        <input type="text" id="bitacoraAjustes" class="form-input" placeholder="Ajustes DUA">
                        <button onclick="agregarEntradaBitacora()" class="btn-primary md:col-span-2">
                            <i class="fas fa-plus"></i> Agregar Entrada
                        </button>
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Tema</th>
                                    <th>Actividad</th>
                                    <th>Ajustes DUA</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="bitacoraTabla"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- REPORTES -->
            <div id="reportes" class="tab-pane">
                <div class="card">
                    <div class="grid md:grid-cols-3 gap-4 mb-6">
                        <div>
                            <label class="form-label">Centro Educativo</label>
                            <select id="reportCentro" class="form-select" onchange="cargarGruposPorCentro('reportGrupo', this.value)">
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">Grupo</label>
                            <select id="reportGrupo" class="form-select"></select>
                        </div>
                        <div>
                            <label class="form-label">Periodo</label>
                            <select id="reportPeriodo" class="form-select">
                                <option value="I">Periodo I</option>
                                <option value="II">Periodo II</option>
                                <option value="III">Periodo III</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">Asignatura</label>
                            <select id="reportAsignatura" class="form-select">
                                <option value="">Todas</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button onclick="generarReporte()" class="btn-primary w-full">
                                <i class="fas fa-chart-bar"></i> Generar
                            </button>
                        </div>
                    </div>

                    <div id="reporteContainer" class="hidden space-y-6">
                        <div class="grid md:grid-cols-3 gap-4">
                            <div class="bg-gradient-to-br from-yellow-100 to-yellow-200 p-4 rounded-lg border border-yellow-300">
                                <h4 class="font-bold text-yellow-800 mb-2">ðŸ¥‡ Primer Lugar</h4>
                                <p id="top1" class="text-lg font-semibold">-</p>
                                <p id="top1Nota" class="text-2xl font-bold text-yellow-700">-</p>
                            </div>
                            <div class="bg-gradient-to-br from-gray-100 to-gray-200 p-4 rounded-lg border border-gray-300">
                                <h4 class="font-bold text-gray-800 mb-2">ðŸ¥ˆ Segundo Lugar</h4>
                                <p id="top2" class="text-lg font-semibold">-</p>
                                <p id="top2Nota" class="text-2xl font-bold text-gray-700">-</p>
                            </div>
                            <div class="bg-gradient-to-br from-orange-100 to-orange-200 p-4 rounded-lg border border-orange-300">
                                <h4 class="font-bold text-orange-800 mb-2">ðŸ¥‰ Tercer Lugar</h4>
                                <p id="top3" class="text-lg font-semibold">-</p>
                                <p id="top3Nota" class="text-2xl font-bold text-orange-700">-</p>
                            </div>
                        </div>

                        <div class="table-container">
                            <table>
                                <thead id="reporteHeader"></thead>
                                <tbody id="reporteTabla"></tbody>
                            </table>
                        </div>

                        <div class="flex gap-3">
                            <button onclick="exportarReportePDF()" class="btn-primary">
                                <i class="fas fa-file-pdf"></i> PDF
                            </button>
                            <button onclick="exportarReporteWord()" class="btn-secondary">
                                <i class="fas fa-file-word"></i> Word
                            </button>
                            <button onclick="exportarReporteCSV()" class="btn-secondary">
                                <i class="fas fa-file-csv"></i> CSV
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ACTA FINAL -->
            <div id="acta" class="tab-pane">
                <div class="card">
                    <div class="grid md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label class="form-label">Centro Educativo</label>
                            <select id="actaCentro" class="form-select" onchange="cargarGruposPorCentro('actaGrupo', this.value)">
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">Grupo</label>
                            <select id="actaGrupo" class="form-select"></select>
                        </div>
                        <div>
                            <label class="form-label">AÃ±o Lectivo</label>
                            <input type="text" id="actaAnio" class="form-input" value="2026">
                        </div>
                        <div class="flex items-end">
                            <button onclick="generarActaFinal()" class="btn-primary w-full">
                                <i class="fas fa-file-signature"></i> Generar Acta
                            </button>
                        </div>
                    </div>

                    <div id="actaContainer" class="hidden">
                        <div class="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                            <p class="text-sm text-yellow-800">
                                <i class="fas fa-info-circle mr-2"></i>
                                SegÃºn el nuevo reglamento MEP 2026: La nota final se compone de 50% promedio anual + 50% PNE.
                            </p>
                        </div>

                        <div class="table-container mb-6">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Estudiante</th>
                                        <th class="text-center">I Per</th>
                                        <th class="text-center">II Per</th>
                                        <th class="text-center">III Per</th>
                                        <th class="text-center">Prom. Anual</th>
                                        <th class="text-center">PNE</th>
                                        <th class="text-center">Nota Final</th>
                                        <th class="text-center">CondiciÃ³n</th>
                                    </tr>
                                </thead>
                                <tbody id="actaTabla"></tbody>
                            </table>
                        </div>

                        <div class="flex gap-3">
                            <button onclick="exportarActaPDF()" class="btn-primary">
                                <i class="fas fa-file-pdf"></i> PDF
                            </button>
                            <button onclick="exportarActaWord()" class="btn-secondary">
                                <i class="fas fa-file-word"></i> Word
                            </button>
                            <button onclick="validarActa()" class="btn-secondary">
                                <i class="fas fa-check-circle"></i> Validar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RESPALDO -->
            <div id="respaldo" class="tab-pane">
                <div class="max-w-4xl mx-auto space-y-6">
                    <div class="card">
                        <h3 class="text-lg font-semibold mb-4">ExportaciÃ³n de Datos</h3>
                        
                        <div class="grid md:grid-cols-2 gap-4 mb-6">
                            <button onclick="exportarRespaldoJSON()" class="p-6 border-2 border-blue-200 rounded-lg hover:bg-blue-50 text-left">
                                <i class="fas fa-file-code text-3xl text-blue-600 mb-2"></i>
                                <h4 class="font-semibold">Respaldo Completo (JSON)</h4>
                                <p class="text-sm text-gray-600">Exporta todos los datos del sistema</p>
                            </button>
                            
                            <button onclick="exportarTodoCSV()" class="p-6 border-2 border-green-200 rounded-lg hover:bg-green-50 text-left">
                                <i class="fas fa-file-csv text-3xl text-green-600 mb-2"></i>
                                <h4 class="font-semibold">ExportaciÃ³n Masiva (CSV)</h4>
                                <p class="text-sm text-gray-600">Exporta todas las tablas en CSV</p>
                            </button>
                        </div>

                        <div class="border-t pt-6">
                            <h4 class="font-semibold mb-4">Importar Respaldo</h4>
                            <div class="flex gap-4">
                                <input type="file" id="backupInput" accept=".json" class="form-input flex-1">
                                <button onclick="importarRespaldo()" class="btn-primary">
                                    <i class="fas fa-upload"></i> Restaurar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- MODALES -->
    <!-- Centro Modal -->
    <div id="centroModal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-semibold mb-4">Nuevo Centro Educativo</h3>
            <div class="space-y-4">
                <input type="text" id="centroNombre" class="form-input" placeholder="Nombre del Centro (ej: Liceo de San JosÃ©)">
                <input type="text" id="centroCodigo" class="form-input" placeholder="CÃ³digo MEP (opcional)">
                <select id="centroModalidad" class="form-select">
                    <option value="primaria">Primaria (1Â° a 6Â°)</option>
                    <option value="secundaria">Secundaria AcadÃ©mica (7Â° a 12Â°)</option>
                    <option value="tecnica">Colegio TÃ©cnico Profesional</option>
                    <option value="cindea">CINDEA / IPEC</option>
                    <option value="preescolar">Preescolar / Materno</option>
                </select>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button onclick="cerrarModal('centroModal')" class="btn-secondary">Cancelar</button>
                <button onclick="guardarCentro()" class="btn-primary">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Grupo Modal -->
    <div id="grupoModal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-semibold mb-4">Nuevo Grupo/SecciÃ³n</h3>
            <div class="space-y-4">
                <select id="grupoCentro" class="form-select" required>
                    <option value="">Seleccione centro educativo</option>
                </select>
                <input type="text" id="grupoNombre" class="form-input" placeholder="Ej: 7-1, 10-3, 2Â°B" required>
                <select id="grupoNivel" class="form-select" required>
                    <option value="">Seleccione nivel</option>
                    <option value="1">1Â° Primaria</option>
                    <option value="2">2Â° Primaria</option>
                    <option value="3">3Â° Primaria</option>
                    <option value="4">4Â° Primaria</option>
                    <option value="5">5Â° Primaria</option>
                    <option value="6">6Â° Primaria</option>
                    <option value="7">7Â° Secundaria</option>
                    <option value="8">8Â° Secundaria</option>
                    <option value="9">9Â° Secundaria</option>
                    <option value="10">10Â° Secundaria</option>
                    <option value="11">11Â° Secundaria</option>
                    <option value="12">12Â° Secundaria</option>
                </select>
                <input type="text" id="grupoAsignaturas" class="form-input" placeholder="Asignaturas (separadas por coma) - Opcional">
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button onclick="cerrarModal('grupoModal')" class="btn-secondary">Cancelar</button>
                <button onclick="guardarGrupo()" class="btn-primary">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Estudiante Modal -->
    <div id="estudianteModal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-semibold mb-4">Agregar Estudiante</h3>
            <div class="space-y-4">
                <select id="estGrupo" class="form-select" required>
                    <option value="">Seleccione grupo</option>
                </select>
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" id="estNumero" class="form-input" placeholder="NÂ° lista">
                    <input type="text" id="estNombre" class="form-input" placeholder="Nombre completo" required>
                </div>
                <input type="tel" id="estTelefono" class="form-input" placeholder="TelÃ©fono encargado">
                <input type="email" id="estCorreo" class="form-input" placeholder="Correo">
                <select id="estCondicion" class="form-select">
                    <option value="regular">Regular</option>
                    <option value="acs">ACS - AdecuaciÃ³n Significativa</option>
                    <option value="ns">AdecuaciÃ³n No Significativa</option>
                </select>
                <textarea id="estObservaciones" class="form-input" rows="2" placeholder="Observaciones"></textarea>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button onclick="cerrarModal('estudianteModal')" class="btn-secondary">Cancelar</button>
                <button onclick="guardarEstudiante()" class="btn-primary">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Instrumento Modal -->
    <div id="instrumentoModal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-semibold mb-4">Crear Instrumento de EvaluaciÃ³n</h3>
            <div class="space-y-4">
                <select id="instTipo" class="form-select">
                    <option value="rubrica">RÃºbrica AnalÃ­tica</option>
                    <option value="cotejo">Lista de Cotejo</option>
                    <option value="escala">Escala de DesempeÃ±o</option>
                </select>
                <input type="text" id="instNombre" class="form-input" placeholder="Nombre del instrumento" required>
                <input type="text" id="instAsignatura" class="form-input" placeholder="Asignatura">
                <select id="instGrupo" class="form-select">
                    <option value="">Sin asignar (plantilla general)</option>
                </select>
                
                <div id="indicadoresContainer">
                    <label class="form-label">Indicadores / Criterios</label>
                    <div class="space-y-2" id="indicadoresLista">
                        <div class="flex gap-2">
                            <input type="text" class="indicador-input form-input flex-1" placeholder="Indicador 1">
                            <button type="button" onclick="eliminarIndicador(this)" class="btn-secondary hidden">-</button>
                        </div>
                    </div>
                    <button type="button" onclick="agregarIndicador()" class="btn-secondary mt-2 text-sm">
                        <i class="fas fa-plus"></i> Agregar Indicador
                    </button>
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button onclick="cerrarModal('instrumentoModal')" class="btn-secondary">Cancelar</button>
                <button onclick="guardarInstrumento()" class="btn-primary">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Alertas Modal -->
    <div id="alertasModal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-semibold mb-4 flex items-center">
                <i class="fas fa-bell mr-2 text-yellow-500"></i>
                Alertas Tempranas
            </h3>
            <div id="alertasLista" class="space-y-3 max-h-96 overflow-y-auto"></div>
            <div class="mt-6 flex justify-end">
                <button onclick="cerrarModal('alertasModal')" class="btn-primary">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast">
        <i id="toastIcon" class="fas fa-check-circle text-green-400"></i>
        <span id="toastMessage">OperaciÃ³n exitosa</span>
    </div>

    <script>
        // ==================== INICIALIZACIÃ“N ====================
        const DB = {
            get: (key) => {
                try {
                    const data = localStorage.getItem(`mep_${key}`);
                    return data ? JSON.parse(data) : null;
                } catch {
                    return null;
                }
            },
            set: (key, value) => {
                localStorage.setItem(`mep_${key}`, JSON.stringify(value));
            },
            init: () => {
                if (!DB.get('centros')) DB.set('centros', []);
                if (!DB.get('grupos')) DB.set('grupos', []);
                if (!DB.get('estudiantes')) DB.set('estudiantes', []);
                if (!DB.get('notas')) DB.set('notas', {});
                if (!DB.get('asistencia')) DB.set('asistencia', {});
                if (!DB.get('bitacora')) DB.set('bitacora', []);
                if (!DB.get('instrumentos')) DB.set('instrumentos', []);
                if (!DB.get('config')) {
                    DB.set('config', {
                        modalidad: 'secundaria',
                        periodo: 'I',
                        porcentajes: {
                            trabajoCotidiano: 40,
                            tareas: 20,
                            pruebas: 30,
                            proyecto: 10,
                            asistencia: 0,
                            portafolio: 0
                        },
                        formulaACS: '(trabajoCotidiano * 0.7) + (tareas * 0.3)'
                    });
                }
            }
        };

        // ==================== UTILIDADES ====================
        const Utils = {
            generarId: () => Date.now().toString(36) + Math.random().toString(36).substring(2),
            mostrarToast: (mensaje, tipo = 'success') => {
                const toast = document.getElementById('toast');
                const icon = document.getElementById('toastIcon');
                const msg = document.getElementById('toastMessage');
                
                msg.textContent = mensaje;
                icon.className = tipo === 'success' ? 'fas fa-check-circle text-green-400' : 
                                 tipo === 'error' ? 'fas fa-exclamation-circle text-red-400' : 
                                 'fas fa-exclamation-triangle text-yellow-400';
                
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 3000);
            },
            confirmar: (mensaje) => confirm(mensaje),
            formatearFecha: (fecha) => new Date(fecha).toLocaleDateString('es-CR')
        };

        // ==================== MENÃš ====================
        function toggleMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
        }

        function closeMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            sidebar.classList.remove('open');
            overlay.classList.remove('active');
        }

        // ==================== PESTAÃ‘AS ====================
        function showTab(tabId) {
            document.querySelectorAll('.tab-pane').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            
            const titles = {
                'dashboard': 'Dashboard',
                'centros': 'Centros Educativos',
                'grupos': 'Grupos y Estudiantes',
                'evaluacion': 'EvaluaciÃ³n',
                'instrumentos': 'Instrumentos',
                'asistencia': 'Asistencia',
                'bitacora': 'BitÃ¡cora',
                'reportes': 'Reportes',
                'acta': 'Acta Final',
                'respaldo': 'Respaldo'
            };
            document.getElementById('pageTitle').textContent = titles[tabId];
            
            if (window.innerWidth <= 768) closeMenu();
            
            // Cargar datos segÃºn pestaÃ±a
            if (tabId === 'dashboard') {
                actualizarDashboard();
            } else if (tabId === 'centros') {
                renderizarCentros();
            } else if (tabId === 'grupos') {
                renderizarGruposCompleto();
            } else if (tabId === 'instrumentos') {
                renderizarInstrumentos();
            } else if (tabId === 'bitacora') {
                renderizarBitacora();
            } else if (tabId === 'evaluacion') {
                cargarCentrosSelect('evalCentro');
            } else if (tabId === 'asistencia') {
                cargarCentrosSelect('asistCentro');
            } else if (tabId === 'reportes') {
                cargarCentrosSelect('reportCentro');
            } else if (tabId === 'acta') {
                cargarCentrosSelect('actaCentro');
            }
        }

        // ==================== TEMA OSCURO ====================
        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            const icon = document.getElementById('darkModeIcon');
            const text = document.getElementById('darkModeText');
            icon.className = document.documentElement.classList.contains('dark') ? 'fas fa-sun w-6' : 'fas fa-moon w-6';
            text.textContent = document.documentElement.classList.contains('dark') ? 'Modo Claro' : 'Modo Oscuro';
        }

        // ==================== MODALES ====================
        function abrirModalCentro() {
            document.getElementById('centroModal').classList.add('active');
        }

        function abrirModalGrupo() {
            cargarCentrosSelect('grupoCentro');
            document.getElementById('grupoModal').classList.add('active');
        }

        function abrirModalEstudiante(grupoId = null) {
            cargarGruposSelect('estGrupo');
            if (grupoId) {
                document.getElementById('estGrupo').value = grupoId;
            }
            document.getElementById('estudianteModal').classList.add('active');
        }

        function abrirModalInstrumento() {
            cargarGruposSelect('instGrupo');
            document.getElementById('indicadoresLista').innerHTML = `
                <div class="flex gap-2">
                    <input type="text" class="indicador-input form-input flex-1" placeholder="Indicador 1">
                    <button type="button" onclick="eliminarIndicador(this)" class="btn-secondary hidden">-</button>
                </div>
            `;
            document.getElementById('instrumentoModal').classList.add('active');
        }

        function cerrarModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        // ==================== CENTROS ====================
        function renderizarCentros() {
            const centros = DB.get('centros') || [];
            const container = document.getElementById('centrosLista');
            
            if (!centros.length) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No hay centros registrados. Â¡Crea tu primer centro!</p>';
                return;
            }
            
            container.innerHTML = centros.map(c => `
                <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                    <div>
                        <p class="font-medium text-lg">${c.nombre}</p>
                        <p class="text-sm text-gray-500">${c.codigo ? `CÃ³digo: ${c.codigo} | ` : ''}Modalidad: ${c.modalidad}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editarCentro('${c.id}')" class="text-blue-600 hover:text-blue-800">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="eliminarCentro('${c.id}')" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            
            // Actualizar selects de centros
            const selectores = ['evalCentro', 'asistCentro', 'reportCentro', 'actaCentro', 'filtroCentroGrupos'];
            const options = '<option value="">Todos los centros</option>' + centros.map(c => `<option value="${c.id}">${c.nombre}</option>`).join('');
            selectores.forEach(id => {
                const sel = document.getElementById(id);
                if (sel) {
                    const valorActual = sel.value;
                    sel.innerHTML = id === 'filtroCentroGrupos' ? options : `<option value="">Seleccione...</option>${options.replace('Todos los centros', 'Seleccione...')}`;
                    if (valorActual && centros.some(c => c.id === valorActual)) {
                        sel.value = valorActual;
                    }
                }
            });
        }

        function guardarCentro() {
            const nombre = document.getElementById('centroNombre').value.trim();
            const codigo = document.getElementById('centroCodigo').value.trim();
            const modalidad = document.getElementById('centroModalidad').value;
            
            if (!nombre) {
                Utils.mostrarToast('El nombre del centro es obligatorio', 'error');
                return;
            }
            
            const centros = DB.get('centros') || [];
            centros.push({
                id: Utils.generarId(),
                nombre,
                codigo,
                modalidad
            });
            DB.set('centros', centros);
            
            cerrarModal('centroModal');
            renderizarCentros();
            actualizarDashboard();
            Utils.mostrarToast('Centro agregado correctamente');
            
            document.getElementById('centroNombre').value = '';
            document.getElementById('centroCodigo').value = '';
        }

        function eliminarCentro(id) {
            if (!Utils.confirmar('Â¿Eliminar este centro? TambiÃ©n se eliminarÃ¡n todos sus grupos y estudiantes.')) return;
            
            const centros = DB.get('centros').filter(c => c.id !== id);
            DB.set('centros', centros);
            
            // Eliminar grupos y estudiantes asociados
            const grupos = DB.get('grupos').filter(g => g.centro !== id);
            DB.set('grupos', grupos);
            
            const estudiantes = DB.get('estudiantes').filter(e => {
                const grupo = grupos.find(g => g.id === e.grupo);
                return grupo;
            });
            DB.set('estudiantes', estudiantes);
            
            renderizarCentros();
            actualizarDashboard();
            Utils.mostrarToast('Centro eliminado');
        }

        function editarCentro(id) {
            const centros = DB.get('centros');
            const centro = centros.find(c => c.id === id);
            if (!centro) return;
            
            const nuevoNombre = prompt('Nuevo nombre del centro:', centro.nombre);
            if (!nuevoNombre) return;
            
            centro.nombre = nuevoNombre;
            DB.set('centros', centros);
            renderizarCentros();
            Utils.mostrarToast('Centro actualizado');
        }

        // ==================== GRUPOS ====================
        function renderizarGruposCompleto() {
            const grupos = DB.get('grupos') || [];
            const centros = DB.get('centros') || [];
            const estudiantes = DB.get('estudiantes') || [];
            const container = document.getElementById('gruposContainer');
            const filtroCentro = document.getElementById('filtroCentroGrupos').value;
            
            let gruposFiltrados = grupos;
            if (filtroCentro) {
                gruposFiltrados = grupos.filter(g => g.centro === filtroCentro);
            }
            
            if (!gruposFiltrados.length) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8 col-span-2">No hay grupos registrados para mostrar.</p>';
                return;
            }
            
            container.innerHTML = gruposFiltrados.map(grupo => {
                const centro = centros.find(c => c.id === grupo.centro);
                const estudiantesGrupo = estudiantes.filter(e => e.grupo === grupo.id);
                const tipoNivel = parseInt(grupo.nivel) <= 6 ? 'Primaria' : 'Secundaria';
                
                return `
                    <div class="card">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h4 class="font-bold text-lg">${grupo.nombre}</h4>
                                <p class="text-sm text-gray-500">${centro ? centro.nombre : 'Centro no encontrado'} â€¢ ${tipoNivel} â€¢ Nivel ${grupo.nivel}</p>
                                ${grupo.asignaturas ? `<p class="text-xs text-gray-400 mt-1">Asignaturas: ${grupo.asignaturas}</p>` : ''}
                            </div>
                            <div class="flex gap-2">
                                <button onclick="abrirModalEstudiante('${grupo.id}')" class="btn-primary text-sm py-1 px-3">
                                    <i class="fas fa-plus"></i> Estudiante
                                </button>
                                <button onclick="eliminarGrupo('${grupo.id}')" class="text-red-600 hover:text-red-800">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <h5 class="font-semibold mb-2 text-sm">Estudiantes (${estudiantesGrupo.length})</h5>
                            ${estudiantesGrupo.length ? `
                                <div class="table-container">
                                    <table class="text-sm">
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>Nombre</th>
                                                <th>CondiciÃ³n</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${estudiantesGrupo.sort((a,b) => (a.numero||0) - (b.numero||0)).map((e, i) => `
                                                <tr>
                                                    <td>${e.numero || i+1}</td>
                                                    <td>${e.nombre}</td>
                                                    <td>
                                                        <span class="badge ${e.condicion === 'acs' ? 'bg-purple-100 text-purple-800' : 'bg-gray-100'}">
                                                            ${e.condicion === 'acs' ? 'ACS' : e.condicion === 'ns' ? 'No Signif.' : 'Regular'}
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <button onclick="eliminarEstudiante('${e.id}')" class="text-red-600 hover:text-red-800">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            ` : '<p class="text-gray-400 text-sm">No hay estudiantes en este grupo</p>'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function guardarGrupo() {
            const centro = document.getElementById('grupoCentro').value;
            const nombre = document.getElementById('grupoNombre').value.trim();
            const nivel = document.getElementById('grupoNivel').value;
            const asignaturas = document.getElementById('grupoAsignaturas').value.trim();
            
            if (!centro || !nombre || !nivel) {
                Utils.mostrarToast('Complete todos los campos obligatorios', 'error');
                return;
            }
            
            const grupos = DB.get('grupos') || [];
            grupos.push({
                id: Utils.generarId(),
                centro,
                nombre,
                nivel,
                asignaturas
            });
            DB.set('grupos', grupos);
            
            cerrarModal('grupoModal');
            renderizarGruposCompleto();
            actualizarDashboard();
            Utils.mostrarToast('Grupo creado correctamente');
            
            document.getElementById('grupoNombre').value = '';
            document.getElementById('grupoAsignaturas').value = '';
        }

        function eliminarGrupo(id) {
            if (!Utils.confirmar('Â¿Eliminar este grupo? TambiÃ©n se eliminarÃ¡n sus estudiantes.')) return;
            
            const grupos = DB.get('grupos').filter(g => g.id !== id);
            DB.set('grupos', grupos);
            
            const estudiantes = DB.get('estudiantes').filter(e => e.grupo !== id);
            DB.set('estudiantes', estudiantes);
            
            renderizarGruposCompleto();
            actualizarDashboard();
            Utils.mostrarToast('Grupo eliminado');
        }

        function filtrarGruposPorCentro() {
            renderizarGruposCompleto();
        }

        // ==================== ESTUDIANTES ====================
        function guardarEstudiante() {
            const grupo = document.getElementById('estGrupo').value;
            const nombre = document.getElementById('estNombre').value.trim();
            
            if (!grupo || !nombre) {
                Utils.mostrarToast('Complete grupo y nombre', 'error');
                return;
            }
            
            const estudiantes = DB.get('estudiantes') || [];
            estudiantes.push({
                id: Utils.generarId(),
                grupo,
                numero: parseInt(document.getElementById('estNumero').value) || null,
                nombre,
                telefono: document.getElementById('estTelefono').value,
                correo: document.getElementById('estCorreo').value,
                condicion: document.getElementById('estCondicion').value,
                observaciones: document.getElementById('estObservaciones').value
            });
            DB.set('estudiantes', estudiantes);
            
            cerrarModal('estudianteModal');
            renderizarGruposCompleto();
            actualizarDashboard();
            Utils.mostrarToast('Estudiante agregado');
            
            document.getElementById('estNumero').value = '';
            document.getElementById('estNombre').value = '';
            document.getElementById('estTelefono').value = '';
            document.getElementById('estCorreo').value = '';
            document.getElementById('estObservaciones').value = '';
        }

        function eliminarEstudiante(id) {
            if (!Utils.confirmar('Â¿Eliminar este estudiante?')) return;
            
            const estudiantes = DB.get('estudiantes').filter(e => e.id !== id);
            DB.set('estudiantes', estudiantes);
            renderizarGruposCompleto();
            actualizarDashboard();
            Utils.mostrarToast('Estudiante eliminado');
        }

        // ==================== COMPONENTES POR NIVEL ====================
        function obtenerComponentesPorNivel(nivel, centroModalidad = null) {
            const n = parseInt(nivel);
            const componentes = {
                trabajoCotidiano: { nombre: 'Trabajo Cotidiano', activo: true, porcentaje: 0 },
                tareas: { nombre: 'Tareas', activo: true, porcentaje: 0 },
                pruebas: { nombre: 'Pruebas', activo: false, porcentaje: 0 },
                proyecto: { nombre: 'Proyecto', activo: false, porcentaje: 0 },
                asistencia: { nombre: 'Asistencia', activo: false, porcentaje: 0 },
                portafolio: { nombre: 'Portafolio', activo: false, porcentaje: 0 },
                demostracion: { nombre: 'DemostraciÃ³n', activo: false, porcentaje: 0 }
            };
            
            // Primaria (1-6)
            if (n >= 1 && n <= 6) {
                componentes.pruebas.activo = true;
                componentes.asistencia.activo = true;
                // Primaria no usa proyecto
            }
            
            // Secundaria (7-12)
            if (n >= 7 && n <= 12) {
                componentes.pruebas.activo = true;
                componentes.proyecto.activo = true; // Opcional, puede elegirse
                componentes.asistencia.activo = true;
            }
            
            // TÃ©cnica / CINDEA (podrÃ­a tener portafolio)
            if (centroModalidad === 'tecnica' || centroModalidad === 'cindea') {
                componentes.portafolio.activo = true;
                componentes.demostracion.activo = true;
            }
            
            return componentes;
        }

        function cargarComponentesPorGrupo() {
            const grupoId = document.getElementById('evalGrupo').value;
            if (!grupoId) return;
            
            const grupos = DB.get('grupos') || [];
            const centros = DB.get('centros') || [];
            const grupo = grupos.find(g => g.id === grupoId);
            if (!grupo) return;
            
            const centro = centros.find(c => c.id === grupo.centro);
            const componentes = obtenerComponentesPorNivel(grupo.nivel, centro?.modalidad);
            
            const container = document.getElementById('componentesLista');
            const html = [];
            
            if (componentes.trabajoCotidiano.activo) html.push('<span class="component-chip active">Trabajo Cotidiano</span>');
            if (componentes.tareas.activo) html.push('<span class="component-chip active">Tareas</span>');
            if (componentes.pruebas.activo) html.push('<span class="component-chip active">Pruebas</span>');
            if (componentes.proyecto.activo) html.push('<span class="component-chip active">Proyecto</span>');
            if (componentes.asistencia.activo) html.push('<span class="component-chip active">Asistencia</span>');
            if (componentes.portafolio.activo) html.push('<span class="component-chip active">Portafolio</span>');
            if (componentes.demostracion.activo) html.push('<span class="component-chip active">DemostraciÃ³n</span>');
            
            container.innerHTML = html.join('') || '<span class="text-sm text-gray-500">No hay componentes definidos</span>';
            
            return componentes;
        }

        // ==================== EVALUACIÃ“N ====================
        function cargarTablaEvaluacion() {
            const grupoId = document.getElementById('evalGrupo').value;
            const periodo = document.getElementById('evalPeriodo').value;
            const asignatura = document.getElementById('evalAsignatura').value.trim();
            
            if (!grupoId || !asignatura) {
                Utils.mostrarToast('Seleccione grupo y asignatura', 'error');
                return;
            }
            
            const grupos = DB.get('grupos') || [];
            const centros = DB.get('centros') || [];
            const estudiantes = (DB.get('estudiantes') || []).filter(e => e.grupo === grupoId);
            const grupo = grupos.find(g => g.id === grupoId);
            const centro = centros.find(c => c.id === grupo?.centro);
            
            if (!estudiantes.length) {
                Utils.mostrarToast('No hay estudiantes en este grupo', 'warning');
                return;
            }
            
            const componentes = obtenerComponentesPorNivel(grupo.nivel, centro?.modalidad);
            const notas = DB.get('notas') || {};
            const key = `${grupoId}_${periodo}_${asignatura}`;
            const notasGrupo = notas[key] || {};
            
            // Generar header de tabla dinÃ¡mica
            let headerHtml = '<tr><th class="sticky left-0">Estudiante</th>';
            if (componentes.trabajoCotidiano.activo) headerHtml += '<th class="text-center">TC</th>';
            if (componentes.tareas.activo) headerHtml += '<th class="text-center">Tareas</th>';
            if (componentes.pruebas.activo) headerHtml += '<th class="text-center">Prueba</th>';
            if (componentes.proyecto.activo) headerHtml += '<th class="text-center">Proyecto</th>';
            if (componentes.asistencia.activo) headerHtml += '<th class="text-center">Asist.</th>';
            if (componentes.portafolio.activo) headerHtml += '<th class="text-center">Portaf.</th>';
            if (componentes.demostracion.activo) headerHtml += '<th class="text-center">Demost.</th>';
            headerHtml += '<th class="text-center font-bold">Prom.</th></tr>';
            document.getElementById('evalTableHeader').innerHTML = headerHtml;
            
            let tbody = '', suma = 0;
            
            estudiantes.sort((a, b) => (a.numero || 0) - (b.numero || 0)).forEach(est => {
                const n = notasGrupo[est.id] || {};
                let row = `<tr><td class="sticky left-0 bg-white dark:bg-gray-800">${est.nombre}</td>`;
                let valores = [];
                let promedio = 0;
                let totalPorcentaje = 0;
                let sumaPonderada = 0;
                
                if (componentes.trabajoCotidiano.activo) {
                    const val = n.trabajoCotidiano || '';
                    row += `<td><input type="number" class="w-16 px-2 py-1 border rounded dark:bg-gray-700" value="${val}" data-est="${est.id}" data-campo="trabajoCotidiano" onchange="actualizarNota(this)"></td>`;
                    if (val) {
                        sumaPonderada += parseFloat(val) * 0.4; // Porcentaje por defecto
                        totalPorcentaje += 40;
                    }
                }
                if (componentes.tareas.activo) {
                    const val = n.tareas || '';
                    row += `<td><input type="number" class="w-16 px-2 py-1 border rounded dark:bg-gray-700" value="${val}" data-est="${est.id}" data-campo="tareas" onchange="actualizarNota(this)"></td>`;
                    if (val) {
                        sumaPonderada += parseFloat(val) * 0.2;
                        totalPorcentaje += 20;
                    }
                }
                if (componentes.pruebas.activo) {
                    const val = n.pruebas || '';
                    row += `<td><input type="number" class="w-16 px-2 py-1 border rounded dark:bg-gray-700" value="${val}" data-est="${est.id}" data-campo="pruebas" onchange="actualizarNota(this)"></td>`;
                    if (val) {
                        sumaPonderada += parseFloat(val) * 0.3;
                        totalPorcentaje += 30;
                    }
                }
                if (componentes.proyecto.activo) {
                    const val = n.proyecto || '';
                    row += `<td><input type="number" class="w-16 px-2 py-1 border rounded dark:bg-gray-700" value="${val}" data-est="${est.id}" data-campo="proyecto" onchange="actualizarNota(this)"></td>`;
                    if (val) {
                        sumaPonderada += parseFloat(val) * 0.1;
                        totalPorcentaje += 10;
                    }
                }
                if (componentes.asistencia.activo) {
                    const val = n.asistencia || '';
                    row += `<td><input type="number" class="w-16 px-2 py-1 border rounded dark:bg-gray-700" value="${val}" data-est="${est.id}" data-campo="asistencia" onchange="actualizarNota(this)"></td>`;
                    if (val) {
                        sumaPonderada += parseFloat(val) * 0.1;
                        totalPorcentaje += 10;
                    }
                }
                if (componentes.portafolio.activo) {
                    const val = n.portafolio || '';
                    row += `<td><input type="number" class="w-16 px-2 py-1 border rounded dark:bg-gray-700" value="${val}" data-est="${est.id}" data-campo="portafolio" onchange="actualizarNota(this)"></td>`;
                }
                if (componentes.demostracion.activo) {
                    const val = n.demostracion || '';
                    row += `<td><input type="number" class="w-16 px-2 py-1 border rounded dark:bg-gray-700" value="${val}" data-est="${est.id}" data-campo="demostracion" onchange="actualizarNota(this)"></td>`;
                }
                
                if (totalPorcentaje > 0) {
                    promedio = sumaPonderada;
                    suma += promedio;
                }
                
                row += `<td class="font-bold text-center" id="prom_${est.id}">${promedio ? promedio.toFixed(2) : '-'}</td></tr>`;
                tbody += row;
            });
            
            document.getElementById('evaluacionTableBody').innerHTML = tbody;
            document.getElementById('evaluacionTableContainer').classList.remove('hidden');
            document.getElementById('promedioGrupo').textContent = estudiantes.length ? (suma / estudiantes.length).toFixed(2) : '0.00';
        }

        function actualizarNota(input) {
            const row = input.closest('tr');
            const inputs = row.querySelectorAll('input[data-est]');
            const estId = input.dataset.est;
            
            let sumaPonderada = 0;
            let totalPorcentaje = 0;
            
            inputs.forEach(inp => {
                const campo = inp.dataset.campo;
                const valor = parseFloat(inp.value) || 0;
                let porcentaje = 0;
                
                // Porcentajes por defecto (simplificado)
                if (campo === 'trabajoCotidiano') porcentaje = 40;
                else if (campo === 'tareas') porcentaje = 20;
                else if (campo === 'pruebas') porcentaje = 30;
                else if (campo === 'proyecto') porcentaje = 10;
                else if (campo === 'asistencia') porcentaje = 10;
                else if (campo === 'portafolio') porcentaje = 10;
                else if (campo === 'demostracion') porcentaje = 10;
                
                if (porcentaje > 0 && valor > 0) {
                    sumaPonderada += valor * (porcentaje / 100);
                    totalPorcentaje += porcentaje;
                }
            });
            
            const promedio = totalPorcentaje > 0 ? sumaPonderada : 0;
            document.getElementById(`prom_${estId}`).textContent = promedio.toFixed(2);
            
            let suma = 0, count = 0;
            document.querySelectorAll('#evaluacionTableBody td[id^="prom_"]').forEach(td => {
                const val = parseFloat(td.textContent);
                if (!isNaN(val)) { suma += val; count++; }
            });
            document.getElementById('promedioGrupo').textContent = count ? (suma / count).toFixed(2) : '0.00';
        }

        function guardarNotas() {
            const grupoId = document.getElementById('evalGrupo').value;
            const periodo = document.getElementById('evalPeriodo').value;
            const asignatura = document.getElementById('evalAsignatura').value.trim();
            
            if (!grupoId || !asignatura) return;
            
            const key = `${grupoId}_${periodo}_${asignatura}`;
            const notas = DB.get('notas') || {};
            notas[key] = {};
            
            document.querySelectorAll('#evaluacionTableBody tr').forEach(row => {
                const estId = row.querySelector('input[data-est]')?.dataset.est;
                if (!estId) return;
                
                const notaEst = {};
                row.querySelectorAll('input[data-est]').forEach(inp => {
                    notaEst[inp.dataset.campo] = inp.value ? parseFloat(inp.value) : null;
                });
                notas[key][estId] = notaEst;
            });
            
            DB.set('notas', notas);
            Utils.mostrarToast('Notas guardadas correctamente');
        }

        // ==================== INSTRUMENTOS ====================
        function renderizarInstrumentos() {
            const instrumentos = DB.get('instrumentos') || [];
            const container = document.getElementById('instrumentosLista');
            
            if (!instrumentos.length) {
                container.innerHTML = '<p class="text-gray-500 col-span-full text-center py-8">No hay instrumentos creados. Â¡Crea tu primer instrumento!</p>';
                return;
            }
            
            container.innerHTML = instrumentos.map(i => `
                <div class="instrumento-card bg-white dark:bg-gray-800">
                    <h4 class="font-semibold">${i.nombre}</h4>
                    <p class="text-sm text-gray-500">${i.tipo === 'rubrica' ? 'RÃºbrica' : i.tipo === 'cotejo' ? 'Lista de Cotejo' : 'Escala'}</p>
                    ${i.asignatura ? `<p class="text-xs mt-1">Asignatura: ${i.asignatura}</p>` : ''}
                    <p class="text-xs mt-1">Indicadores: ${i.indicadores?.length || 0}</p>
                    <div class="mt-3 flex gap-2">
                        <button onclick="usarInstrumento('${i.id}')" class="text-xs px-2 py-1 bg-green-100 text-green-700 rounded">Usar</button>
                        <button onclick="duplicarInstrumento('${i.id}')" class="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded">Duplicar</button>
                        <button onclick="eliminarInstrumento('${i.id}')" class="text-xs px-2 py-1 bg-red-100 text-red-700 rounded">Eliminar</button>
                    </div>
                </div>
            `).join('');
        }

        function agregarIndicador() {
            const lista = document.getElementById('indicadoresLista');
            const num = lista.children.length + 1;
            const div = document.createElement('div');
            div.className = 'flex gap-2';
            div.innerHTML = `
                <input type="text" class="indicador-input form-input flex-1" placeholder="Indicador ${num}">
                <button type="button" onclick="eliminarIndicador(this)" class="btn-secondary">-</button>
            `;
            lista.appendChild(div);
        }

        function eliminarIndicador(btn) {
            const div = btn.closest('.flex');
            if (div && document.querySelectorAll('.indicador-input').length > 1) {
                div.remove();
            }
        }

        function guardarInstrumento() {
            const nombre = document.getElementById('instNombre').value.trim();
            if (!nombre) {
                Utils.mostrarToast('Ingrese el nombre del instrumento', 'error');
                return;
            }
            
            const indicadores = [];
            document.querySelectorAll('.indicador-input').forEach(inp => {
                if (inp.value.trim()) indicadores.push(inp.value.trim());
            });
            
            if (!indicadores.length) {
                Utils.mostrarToast('Debe agregar al menos un indicador', 'error');
                return;
            }
            
            const instrumentos = DB.get('instrumentos') || [];
            instrumentos.push({
                id: Utils.generarId(),
                tipo: document.getElementById('instTipo').value,
                nombre,
                asignatura: document.getElementById('instAsignatura').value.trim(),
                grupo: document.getElementById('instGrupo').value || null,
                indicadores,
                fecha: new Date().toISOString()
            });
            DB.set('instrumentos', instrumentos);
            
            cerrarModal('instrumentoModal');
            renderizarInstrumentos();
            Utils.mostrarToast('Instrumento guardado');
        }

        function duplicarInstrumento(id) {
            const instrumentos = DB.get('instrumentos') || [];
            const original = instrumentos.find(i => i.id === id);
            if (!original) return;
            
            instrumentos.push({ ...original, id: Utils.generarId(), nombre: `${original.nombre} (copia)` });
            DB.set('instrumentos', instrumentos);
            renderizarInstrumentos();
            Utils.mostrarToast('Instrumento duplicado');
        }

        function eliminarInstrumento(id) {
            if (!Utils.confirmar('Â¿Eliminar este instrumento?')) return;
            
            const instrumentos = DB.get('instrumentos').filter(i => i.id !== id);
            DB.set('instrumentos', instrumentos);
            renderizarInstrumentos();
            Utils.mostrarToast('Instrumento eliminado');
        }

        function usarInstrumento(id) {
            Utils.mostrarToast('FunciÃ³n para usar instrumento en evaluaciÃ³n (en desarrollo)', 'info');
        }

        // ==================== ASISTENCIA ====================
        function cargarAsistencia() {
            const grupoId = document.getElementById('asistGrupo').value;
            const mes = document.getElementById('asistMes').value;
            
            if (!grupoId || !mes) {
                Utils.mostrarToast('Seleccione grupo y mes', 'error');
                return;
            }
            
            const estudiantes = (DB.get('estudiantes') || []).filter(e => e.grupo === grupoId);
            if (!estudiantes.length) {
                Utils.mostrarToast('No hay estudiantes en este grupo', 'warning');
                return;
            }
            
            const [year, month] = mes.split('-').map(Number);
            const daysInMonth = new Date(year, month, 0).getDate();
            
            let header = '<tr><th class="px-2 py-2 border sticky left-0">Estudiante</th><th class="px-2 py-2 border text-center">% Asist.</th>';
            for (let d = 1; d <= daysInMonth; d++) {
                header += `<th class="px-2 py-2 border text-center w-8">${d}</th>`;
            }
            header += '</tr>';
            document.getElementById('asistenciaHeader').innerHTML = header;
            
            const asistencia = DB.get('asistencia') || {};
            const key = `${grupoId}_${mes}`;
            const data = asistencia[key] || {};
            
            let tbody = '';
            estudiantes.sort((a, b) => (a.numero || 0) - (b.numero || 0)).forEach(est => {
                let presentes = 0, total = 0, diasRow = '';
                for (let d = 1; d <= daysInMonth; d++) {
                    const diaKey = `${year}-${String(month).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    const valor = (data[est.id] && data[est.id][diaKey]) || 'P';
                    if (valor === 'P' || valor === 'J') presentes++;
                    total++;
                    diasRow += `<td class="px-2 py-2 border text-center">
                        <select class="asist-select w-10 text-xs p-1 border rounded dark:bg-gray-700" data-est="${est.id}" data-dia="${diaKey}" onchange="actualizarAsistencia(this)">
                            <option value="P" ${valor === 'P' ? 'selected' : ''}>P</option>
                            <option value="A" ${valor === 'A' ? 'selected' : ''}>A</option>
                            <option value="J" ${valor === 'J' ? 'selected' : ''}>J</option>
                            <option value="T" ${valor === 'T' ? 'selected' : ''}>T</option>
                        </select>
                    </td>`;
                }
                const porcentaje = total ? ((presentes / total) * 100).toFixed(1) : 0;
                tbody += `<tr><td class="px-2 py-2 border sticky left-0 bg-white dark:bg-gray-800 font-medium">${est.nombre}</td>
                          <td class="px-2 py-2 border text-center font-bold">${porcentaje}%</td>${diasRow}</tr>`;
            });
            
            document.getElementById('asistenciaBody').innerHTML = tbody;
            document.getElementById('asistenciaContainer').classList.remove('hidden');
        }

        function actualizarAsistencia(select) {
            const estId = select.dataset.est;
            const dia = select.dataset.dia;
            const valor = select.value;
            const grupoId = document.getElementById('asistGrupo').value;
            const mes = document.getElementById('asistMes').value;
            
            const key = `${grupoId}_${mes}`;
            const asistencia = DB.get('asistencia') || {};
            if (!asistencia[key]) asistencia[key] = {};
            if (!asistencia[key][estId]) asistencia[key][estId] = {};
            asistencia[key][estId][dia] = valor;
            DB.set('asistencia', asistencia);
            
            const row = select.closest('tr');
            const selects = row.querySelectorAll('.asist-select');
            let presentes = 0;
            selects.forEach(s => { if (s.value === 'P' || s.value === 'J') presentes++; });
            row.cells[1].textContent = ((presentes / selects.length) * 100).toFixed(1) + '%';
        }

        // ==================== BITÃCORA ====================
        function renderizarBitacora() {
            const bitacora = DB.get('bitacora') || [];
            const tbody = document.getElementById('bitacoraTabla');
            
            if (!bitacora.length) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4">No hay registros</td></tr>';
                return;
            }
            
            bitacora.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            tbody.innerHTML = bitacora.map(e => `
                <tr>
                    <td>${Utils.formatearFecha(e.fecha)}</td>
                    <td>${e.tema}</td>
                    <td>${e.actividad}</td>
                    <td>${e.ajustes || '-'}</td>
                    <td>
                        <button onclick="eliminarEntradaBitacora('${e.id}')" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function agregarEntradaBitacora() {
            const fecha = document.getElementById('bitacoraFecha').value;
            const tema = document.getElementById('bitacoraTema').value.trim();
            const actividad = document.getElementById('bitacoraActividad').value.trim();
            
            if (!fecha || !tema || !actividad) {
                Utils.mostrarToast('Complete fecha, tema y actividad', 'error');
                return;
            }
            
            const bitacora = DB.get('bitacora') || [];
            bitacora.push({
                id: Utils.generarId(),
                fecha,
                tema,
                actividad,
                ajustes: document.getElementById('bitacoraAjustes').value.trim()
            });
            DB.set('bitacora', bitacora);
            
            renderizarBitacora();
            Utils.mostrarToast('Entrada agregada');
            
            document.getElementById('bitacoraFecha').value = '';
            document.getElementById('bitacoraTema').value = '';
            document.getElementById('bitacoraActividad').value = '';
            document.getElementById('bitacoraAjustes').value = '';
        }

        function eliminarEntradaBitacora(id) {
            if (!Utils.confirmar('Â¿Eliminar esta entrada?')) return;
            
            const bitacora = DB.get('bitacora').filter(e => e.id !== id);
            DB.set('bitacora', bitacora);
            renderizarBitacora();
            Utils.mostrarToast('Entrada eliminada');
        }

        function exportarBitacoraWord() {
            const bitacora = DB.get('bitacora') || [];
            let html = '<html><body><h1>BitÃ¡cora Docente</h1><table border="1"><tr><th>Fecha</th><th>Tema</th><th>Actividad</th><th>Ajustes DUA</th></tr>';
            bitacora.forEach(e => {
                html += `<tr><td>${e.fecha}</td><td>${e.tema}</td><td>${e.actividad}</td><td>${e.ajustes || ''}</td></tr>`;
            });
            html += '</table></body></html>';
            
            const blob = new Blob([html], { type: 'application/msword' });
            saveAs(blob, 'bitacora.doc');
            Utils.mostrarToast('BitÃ¡cora exportada a Word');
        }

        function exportarBitacoraPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text('BitÃ¡cora Docente', 14, 15);
            
            const bitacora = DB.get('bitacora') || [];
            doc.autoTable({
                head: [['Fecha', 'Tema', 'Actividad', 'Ajustes']],
                body: bitacora.map(e => [e.fecha, e.tema, e.actividad, e.ajustes || ''])
            });
            doc.save('bitacora.pdf');
            Utils.mostrarToast('BitÃ¡cora exportada a PDF');
        }

        // ==================== REPORTES ====================
        function generarReporte() {
            const grupoId = document.getElementById('reportGrupo').value;
            const periodo = document.getElementById('reportPeriodo').value;
            
            if (!grupoId || !periodo) {
                Utils.mostrarToast('Seleccione grupo y periodo', 'error');
                return;
            }
            
            const grupos = DB.get('grupos') || [];
            const estudiantes = (DB.get('estudiantes') || []).filter(e => e.grupo === grupoId);
            const notas = DB.get('notas') || {};
            const grupo = grupos.find(g => g.id === grupoId);
            
            if (!grupo) return;
            
            const asignaturas = grupo.asignaturas ? grupo.asignaturas.split(',').map(a => a.trim()) : ['MatemÃ¡tica'];
            const selectAsig = document.getElementById('reportAsignatura');
            selectAsig.innerHTML = '<option value="">Todas</option>' + asignaturas.map(a => `<option value="${a}">${a}</option>`).join('');
            
            let reportData = [];
            estudiantes.forEach(est => {
                let suma = 0, count = 0, tcTotal = 0, tareasTotal = 0, pruebasTotal = 0, proyectoTotal = 0;
                
                asignaturas.forEach(asig => {
                    const key = `${grupoId}_${periodo}_${asig}`;
                    if (notas[key] && notas[key][est.id]) {
                        const n = notas[key][est.id];
                        if (n.trabajoCotidiano) { tcTotal += n.trabajoCotidiano; suma += n.trabajoCotidiano; count++; }
                        if (n.tareas) { tareasTotal += n.tareas; suma += n.tareas; count++; }
                        if (n.pruebas) { pruebasTotal += n.pruebas; suma += n.pruebas; count++; }
                        if (n.proyecto) { proyectoTotal += n.proyecto; suma += n.proyecto; count++; }
                    }
                });
                
                const promedio = count ? (suma / count).toFixed(2) : 0;
                let condicion = promedio >= 65 ? 'Aprobado' : promedio >= 50 ? 'En riesgo' : 'Reprobado';
                
                reportData.push({
                    nombre: est.nombre,
                    numero: est.numero || '-',
                    tc: tcTotal,
                    tareas: tareasTotal,
                    pruebas: pruebasTotal,
                    proyecto: proyectoTotal,
                    promedio: +promedio,
                    condicion
                });
            });
            
            reportData.sort((a, b) => b.promedio - a.promedio);
            
            document.getElementById('top1').textContent = reportData[0]?.nombre || '-';
            document.getElementById('top1Nota').textContent = reportData[0]?.promedio || '-';
            document.getElementById('top2').textContent = reportData[1]?.nombre || '-';
            document.getElementById('top2Nota').textContent = reportData[1]?.promedio || '-';
            document.getElementById('top3').textContent = reportData[2]?.nombre || '-';
            document.getElementById('top3Nota').textContent = reportData[2]?.promedio || '-';
            
            document.getElementById('reporteHeader').innerHTML = `
                <tr>
                    <th>#</th>
                    <th>Estudiante</th>
                    <th class="text-center">TC</th>
                    <th class="text-center">Tareas</th>
                    <th class="text-center">Pruebas</th>
                    <th class="text-center">Proyecto</th>
                    <th class="text-center">Prom.</th>
                    <th class="text-center">CondiciÃ³n</th>
                </tr>
            `;
            
            document.getElementById('reporteTabla').innerHTML = reportData.map((item, idx) => `
                <tr>
                    <td>${idx+1}</td>
                    <td>${item.nombre}</td>
                    <td class="text-center">${item.tc}</td>
                    <td class="text-center">${item.tareas}</td>
                    <td class="text-center">${item.pruebas}</td>
                    <td class="text-center">${item.proyecto}</td>
                    <td class="text-center font-bold">${item.promedio}</td>
                    <td class="text-center">
                        <span class="badge ${item.condicion === 'Aprobado' ? 'bg-green-100 text-green-800' : item.condicion === 'En riesgo' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">
                            ${item.condicion}
                        </span>
                    </td>
                </tr>
            `).join('');
            
            document.getElementById('reporteContainer').classList.remove('hidden');
        }

        function exportarReportePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text('Reporte por Periodo', 14, 15);
            
            const data = [];
            document.querySelectorAll('#reporteTabla tr').forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length) {
                    data.push([cells[0].textContent, cells[1].textContent, cells[2].textContent, cells[3].textContent, cells[4].textContent, cells[5].textContent, cells[6].textContent, cells[7].textContent]);
                }
            });
            
            doc.autoTable({
                head: [['#', 'Estudiante', 'TC', 'Tareas', 'Pruebas', 'Proy', 'Prom', 'CondiciÃ³n']],
                body: data
            });
            doc.save('reporte.pdf');
            Utils.mostrarToast('Reporte exportado a PDF');
        }

        function exportarReporteWord() {
            const tabla = document.querySelector('#reporteTabla').parentElement.outerHTML;
            const top = document.querySelector('.grid.md\\:grid-cols-3.gap-4').outerHTML;
            const html = `<html><body><h1>Reporte por Periodo</h1>${top}${tabla}</body></html>`;
            saveAs(new Blob([html], { type: 'application/msword' }), 'reporte.doc');
            Utils.mostrarToast('Reporte exportado a Word');
        }

        function exportarReporteCSV() {
            let csv = '#,Estudiante,TC,Tareas,Pruebas,Proyecto,Promedio,CondiciÃ³n\n';
            document.querySelectorAll('#reporteTabla tr').forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length) {
                    csv += `${cells[0].textContent},"${cells[1].textContent}",${cells[2].textContent},${cells[3].textContent},${cells[4].textContent},${cells[5].textContent},${cells[6].textContent},"${cells[7].textContent}"\n`;
                }
            });
            saveAs(new Blob([csv], { type: 'text/csv' }), 'reporte.csv');
            Utils.mostrarToast('Reporte exportado a CSV');
        }

        // ==================== ACTA FINAL ====================
        function generarActaFinal() {
            const grupoId = document.getElementById('actaGrupo').value;
            if (!grupoId) {
                Utils.mostrarToast('Seleccione un grupo', 'error');
                return;
            }
            
            const estudiantes = (DB.get('estudiantes') || []).filter(e => e.grupo === grupoId);
            const grupo = (DB.get('grupos') || []).find(g => g.id === grupoId);
            const asignaturas = grupo ? (grupo.asignaturas ? grupo.asignaturas.split(',').map(a => a.trim()) : ['MatemÃ¡tica']) : [];
            const notas = DB.get('notas') || {};
            
            let tbody = '';
            estudiantes.sort((a, b) => (a.numero || 0) - (b.numero || 0)).forEach(est => {
                let sumaPeriodos = 0, periodosCompletos = 0;
                let notasPeriodos = { I: '-', II: '-', III: '-' };
                
                ['I', 'II', 'III'].forEach(per => {
                    let sumaAsignaturas = 0, count = 0;
                    asignaturas.forEach(asig => {
                        const key = `${grupoId}_${per}_${asig}`;
                        if (notas[key] && notas[key][est.id]) {
                            const n = notas[key][est.id];
                            if (n.trabajoCotidiano && n.tareas && (n.pruebas || n.proyecto)) {
                                const promedio = (n.trabajoCotidiano || 0) * 0.4 + 
                                                (n.tareas || 0) * 0.2 + 
                                                ((n.pruebas || n.proyecto) || 0) * 0.3;
                                sumaAsignaturas += promedio;
                                count++;
                            }
                        }
                    });
                    if (count > 0) {
                        const promedioPeriodo = (sumaAsignaturas / count).toFixed(2);
                        notasPeriodos[per] = promedioPeriodo;
                        sumaPeriodos += +promedioPeriodo;
                        periodosCompletos++;
                    }
                });
                
                const promedioAnual = periodosCompletos ? (sumaPeriodos / periodosCompletos).toFixed(2) : 0;
                const pne = 65;
                const notaFinal = ((promedioAnual * 0.5) + (pne * 0.5)).toFixed(2);
                const condicion = notaFinal >= 65 ? 'Aprobado' : notaFinal >= 50 ? 'Convocatoria' : 'Reprobado';
                
                tbody += `
                    <tr>
                        <td>${est.nombre}</td>
                        <td class="text-center">${notasPeriodos.I}</td>
                        <td class="text-center">${notasPeriodos.II}</td>
                        <td class="text-center">${notasPeriodos.III}</td>
                        <td class="text-center font-bold">${promedioAnual}</td>
                        <td class="text-center">${pne}</td>
                        <td class="text-center font-bold">${notaFinal}</td>
                        <td class="text-center">
                            <span class="badge ${condicion === 'Aprobado' ? 'bg-green-100 text-green-800' : condicion === 'Convocatoria' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">
                                ${condicion}
                            </span>
                        </td>
                    </tr>
                `;
            });
            
            document.getElementById('actaTabla').innerHTML = tbody;
            document.getElementById('actaContainer').classList.remove('hidden');
        }

        function exportarActaPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape');
            doc.text('Acta Final de Calificaciones', 14, 15);
            
            const data = [];
            document.querySelectorAll('#actaTabla tr').forEach(row => {
                const cells = row.querySelectorAll('td');
                data.push([cells[0].textContent, cells[1].textContent, cells[2].textContent, cells[3].textContent, cells[4].textContent, cells[5].textContent, cells[6].textContent, cells[7].textContent]);
            });
            
            doc.autoTable({
                head: [['Estudiante', 'I Per', 'II Per', 'III Per', 'Prom Anual', 'PNE', 'Nota Final', 'CondiciÃ³n']],
                body: data,
                styles: { fontSize: 8 }
            });
            doc.save('acta_final.pdf');
            Utils.mostrarToast('Acta exportada a PDF');
        }

        function exportarActaWord() {
            const tabla = document.querySelector('#actaTabla').parentElement.outerHTML;
            const html = `<html><body><h1>Acta Final</h1>${tabla}</body></html>`;
            saveAs(new Blob([html], { type: 'application/msword' }), 'acta_final.doc');
            Utils.mostrarToast('Acta exportada a Word');
        }

        function validarActa() {
            const grupoId = document.getElementById('actaGrupo').value;
            if (!grupoId) {
                Utils.mostrarToast('Seleccione un grupo', 'error');
                return;
            }
            
            const estudiantes = DB.get('estudiantes').filter(e => e.grupo === grupoId);
            const notas = DB.get('notas') || {};
            let incompletos = [];
            
            estudiantes.forEach(est => {
                ['I', 'II', 'III'].forEach(per => {
                    let tieneNotas = false;
                    const keys = Object.keys(notas).filter(k => k.startsWith(`${grupoId}_${per}_`));
                    keys.forEach(key => {
                        if (notas[key][est.id] && notas[key][est.id].trabajoCotidiano) {
                            tieneNotas = true;
                        }
                    });
                    if (!tieneNotas) incompletos.push(`${est.nombre} - Periodo ${per}`);
                });
            });
            
            if (incompletos.length) {
                Utils.mostrarToast(`Faltan notas: ${incompletos.slice(0,3).join(', ')}${incompletos.length > 3 ? '...' : ''}`, 'warning');
            } else {
                Utils.mostrarToast('Todos los periodos estÃ¡n completos', 'success');
            }
        }

        // ==================== RESPALDO ====================
        function exportarRespaldoJSON() {
            const backup = {
                centros: DB.get('centros'),
                grupos: DB.get('grupos'),
                estudiantes: DB.get('estudiantes'),
                notas: DB.get('notas'),
                asistencia: DB.get('asistencia'),
                bitacora: DB.get('bitacora'),
                instrumentos: DB.get('instrumentos'),
                config: DB.get('config'),
                fecha: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            saveAs(blob, `respaldo_mep_${new Date().toISOString().slice(0,10)}.json`);
            Utils.mostrarToast('Respaldo JSON exportado');
        }

        function importarRespaldo() {
            const file = document.getElementById('backupInput').files[0];
            if (!file) {
                Utils.mostrarToast('Seleccione un archivo', 'error');
                return;
            }
            
            if (!Utils.confirmar('Â¿Restaurar respaldo? Se perderÃ¡n los datos actuales.')) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const backup = JSON.parse(e.target.result);
                    
                    DB.set('centros', backup.centros || []);
                    DB.set('grupos', backup.grupos || []);
                    DB.set('estudiantes', backup.estudiantes || []);
                    DB.set('notas', backup.notas || {});
                    DB.set('asistencia', backup.asistencia || {});
                    DB.set('bitacora', backup.bitacora || []);
                    DB.set('instrumentos', backup.instrumentos || []);
                    DB.set('config', backup.config || {});
                    
                    actualizarDashboard();
                    renderizarCentros();
                    renderizarGruposCompleto();
                    Utils.mostrarToast('Respaldo restaurado');
                } catch {
                    Utils.mostrarToast('Error al leer el archivo', 'error');
                }
            };
            reader.readAsText(file);
            document.getElementById('backupInput').value = '';
        }

        function exportarTodoCSV() {
            // Exportar estudiantes
            const estudiantes = DB.get('estudiantes') || [];
            const grupos = DB.get('grupos') || [];
            let csvEst = 'Grupo,NÃºmero,Nombre,TelÃ©fono,Correo,CondiciÃ³n,Observaciones\n';
            estudiantes.forEach(e => {
                const grupo = grupos.find(g => g.id === e.grupo);
                csvEst += `"${grupo ? grupo.nombre : ''}",${e.numero || ''},"${e.nombre}","${e.telefono || ''}","${e.correo || ''}",${e.condicion},"${e.observaciones || ''}"\n`;
            });
            
            const blobEst = new Blob([csvEst], { type: 'text/csv' });
            saveAs(blobEst, 'estudiantes.csv');
            
            // Exportar notas
            const notas = DB.get('notas') || {};
            let csvNotas = 'Grupo,Periodo,Asignatura,Estudiante_ID,TC,Tareas,Prueba,Proyecto,Asist,Portaf\n';
            Object.keys(notas).forEach(key => {
                const [grupoId, periodo, asignatura] = key.split('_');
                Object.keys(notas[key]).forEach(estId => {
                    const n = notas[key][estId];
                    csvNotas += `${grupoId},${periodo},${asignatura},${estId},${n.trabajoCotidiano || ''},${n.tareas || ''},${n.pruebas || ''},${n.proyecto || ''},${n.asistencia || ''},${n.portafolio || ''}\n`;
                });
            });
            
            const blobNotas = new Blob([csvNotas], { type: 'text/csv' });
            saveAs(blobNotas, 'notas.csv');
            
            Utils.mostrarToast('ExportaciÃ³n masiva completada');
        }

        // ==================== DASHBOARD ====================
        function actualizarDashboard() {
            document.getElementById('dashCentros').textContent = (DB.get('centros') || []).length;
            document.getElementById('dashGrupos').textContent = (DB.get('grupos') || []).length;
            document.getElementById('dashEstudiantes').textContent = (DB.get('estudiantes') || []).length;
            document.getElementById('dashInstrumentos').textContent = (DB.get('instrumentos') || []).length;
        }

        // ==================== ALERTAS ====================
        function showAlerts() {
            const estudiantes = DB.get('estudiantes') || [];
            const notas = DB.get('notas') || {};
            const alertas = [];
            
            estudiantes.forEach(est => {
                let bajo = false;
                Object.keys(notas).forEach(key => {
                    if (notas[key][est.id] && notas[key][est.id].trabajoCotidiano) {
                        const n = notas[key][est.id];
                        const promedio = ((n.trabajoCotidiano || 0) * 0.4) + 
                                       ((n.tareas || 0) * 0.2) + 
                                       ((n.pruebas || n.proyecto || 0) * 0.3);
                        if (promedio < 65) bajo = true;
                    }
                });
                if (bajo) alertas.push(`âš ï¸ ${est.nombre} tiene promedio bajo`);
            });
            
            const lista = document.getElementById('alertasLista');
            if (!alertas.length) {
                lista.innerHTML = '<p class="text-gray-500">No hay alertas</p>';
            } else {
                lista.innerHTML = alertas.map(a => `<div class="p-2 bg-yellow-50 dark:bg-yellow-900 rounded">${a}</div>`).join('');
            }
            
            document.getElementById('alertasModal').classList.add('active');
        }

        // ==================== UTILIDADES SELECTS ====================
        function cargarCentrosSelect(selectId) {
            const centros = DB.get('centros') || [];
            const select = document.getElementById(selectId);
            if (!select) return;
            
            const valorActual = select.value;
            select.innerHTML = '<option value="">Seleccione...</option>' + 
                centros.map(c => `<option value="${c.id}">${c.nombre}</option>`).join('');
            
            if (valorActual && centros.some(c => c.id === valorActual)) {
                select.value = valorActual;
            }
        }

        function cargarGruposSelect(selectId) {
            const grupos = DB.get('grupos') || [];
            const select = document.getElementById(selectId);
            if (!select) return;
            
            const valorActual = select.value;
            select.innerHTML = '<option value="">Seleccione...</option>' + 
                grupos.map(g => `<option value="${g.id}">${g.nombre}</option>`).join('');
            
            if (valorActual && grupos.some(g => g.id === valorActual)) {
                select.value = valorActual;
            }
        }

        function cargarGruposPorCentro(selectId, centroId) {
            const grupos = DB.get('grupos') || [];
            const select = document.getElementById(selectId);
            if (!select) return;
            
            const gruposFiltrados = centroId ? grupos.filter(g => g.centro === centroId) : grupos;
            select.innerHTML = '<option value="">Seleccione...</option>' + 
                gruposFiltrados.map(g => `<option value="${g.id}">${g.nombre}</option>`).join('');
        }

        // ==================== PRUEBAS ====================
        function runTests() {
            try {
                // Test 1: Crear centro
                const centros = DB.get('centros') || [];
                const testCentro = { id: 'test1', nombre: 'Centro Prueba', codigo: '001', modalidad: 'secundaria' };
                centros.push(testCentro);
                DB.set('centros', centros);
                
                // Test 2: Crear grupo
                const grupos = DB.get('grupos') || [];
                const testGrupo = { id: 'test2', nombre: 'Grupo Prueba', centro: 'test1', nivel: '7', asignaturas: 'MatemÃ¡tica' };
                grupos.push(testGrupo);
                DB.set('grupos', grupos);
                
                // Test 3: Crear estudiante
                const estudiantes = DB.get('estudiantes') || [];
                const testEst = { id: 'test3', grupo: 'test2', numero: 1, nombre: 'Estudiante Prueba', condicion: 'regular' };
                estudiantes.push(testEst);
                DB.set('estudiantes', estudiantes);
                
                // Test 4: Guardar notas
                const notas = DB.get('notas') || {};
                notas['test2_I_MatemÃ¡tica'] = {
                    'test3': { trabajoCotidiano: 80, tareas: 90, pruebas: 70 }
                };
                DB.set('notas', notas);
                
                Utils.mostrarToast('âœ… Pruebas exitosas - Todos los mÃ³dulos funcionan', 'success');
                
                // Limpiar datos de prueba
                DB.set('centros', centros.filter(c => c.id !== 'test1'));
                DB.set('grupos', grupos.filter(g => g.id !== 'test2'));
                DB.set('estudiantes', estudiantes.filter(e => e.id !== 'test3'));
                
            } catch (error) {
                Utils.mostrarToast('âŒ Error en pruebas: ' + error.message, 'error');
            }
        }

        // ==================== INICIALIZACIÃ“N ====================
        document.addEventListener('DOMContentLoaded', () => {
            DB.init();
            actualizarDashboard();
            renderizarCentros();
            
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('es-CR', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });
            
            // Precargar centros en selects
            setTimeout(() => {
                cargarCentrosSelect('evalCentro');
                cargarCentrosSelect('asistCentro');
                cargarCentrosSelect('reportCentro');
                cargarCentrosSelect('actaCentro');
            }, 100);
        });
    </script>
</body>
</html>
