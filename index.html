<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>Registro Docente MEP ¬∑ 2026</title>
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- jsPDF y html2canvas para exportaciones reales -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, system-ui, -apple-system, sans-serif;
        }

        :root {
            --bg: #f0f5fb;
            --sidebar: #0b2c42;
            --sidebar-hover: #1e4b68;
            --card: #ffffff;
            --text: #1f3a5f;
            --text-light: #4a6d8c;
            --border: #d0deef;
            --accent: #0f6f93;
            --accent-light: #e3f0fa;
            --success: #2b7a4b;
            --warning: #b95e0a;
            --danger: #c13e3e;
            --shadow: 0 12px 30px rgba(0, 20, 40, 0.08);
            --header-bg: #f9fcff;
            --input-bg: #ffffff;
        }

        .dark {
            --bg: #1a2535;
            --sidebar: #0b1d30;
            --card: #253544;
            --text: #e2ecf8;
            --text-light: #b0c6df;
            --border: #405872;
            --accent: #1f8ab3;
            --accent-light: #1e3e57;
            --header-bg: #1f3145;
            --input-bg: #2d4058;
            --shadow: 0 12px 30px rgba(0, 0, 0, 0.5);
        }

        body {
            background: var(--bg);
            color: var(--text);
            display: flex;
            min-height: 100vh;
            transition: background 0.2s, color 0.2s;
        }

        /* SIDEBAR - desktop fijo, m√≥vil adaptable */
        .sidebar {
            width: 280px;
            background: var(--sidebar);
            color: #d9ecfc;
            padding: 2rem 1rem;
            overflow-y: auto;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            z-index: 100;
            transition: 0.3s;
        }

        .sidebar h2 {
            font-weight: 400;
            font-size: 1.5rem;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid #2f5a78;
            padding-bottom: 1.2rem;
        }

        .sidebar nav {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
            flex: 1;
        }

        .sidebar button {
            background: none;
            border: none;
            color: #c6e2ff;
            text-align: left;
            padding: 1rem 1.2rem;
            font-size: 1rem;
            border-radius: 14px;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 14px;
            width: 100%;
        }

        .sidebar button i { width: 26px; font-size: 1.2rem; }
        .sidebar button:hover { background: var(--sidebar-hover); color: white; }
        .sidebar button.active { background: var(--accent); color: white; font-weight: 500; box-shadow: 0 6px 12px rgba(0, 50, 70, 0.5); }
        .sidebar-footer { font-size: 0.9rem; color: #8bb9dd; padding-top: 2rem; border-top: 1px solid #1f4a69; }

        .main-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            max-height: 100vh;
        }

        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            background: var(--header-bg);
            padding: 1rem 2rem;
            border-radius: 50px;
            box-shadow: var(--shadow);
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header-bar h1 { font-size: 1.6rem; font-weight: 400; display: flex; align-items: center; gap: 10px; }
        .modo-toggle { background: var(--card); border: 1px solid var(--border); padding: 0.6rem 1.4rem; border-radius: 40px; cursor: pointer; display: flex; align-items: center; gap: 8px; }

        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        .card {
            background: var(--card);
            border-radius: 32px;
            padding: 2rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            border: 1px solid var(--border);
        }

        .card h3 {
            margin-bottom: 1.8rem;
            font-weight: 500;
            border-left: 6px solid var(--accent);
            padding-left: 1.2rem;
            font-size: 1.4rem;
        }

        .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.8rem; }
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem; }
        .grid-4 { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.2rem; }

        .btn {
            background: var(--card);
            border: 1px solid var(--border);
            padding: 0.7rem 1.5rem;
            border-radius: 40px;
            cursor: pointer;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: 0.2s;
            color: var(--text);
            font-size: 0.95rem;
        }

        .btn-primary { background: var(--accent); color: white; border: none; }
        .btn-primary:hover { background: #0b5f7a; }
        .btn-success { background: var(--success); color: white; border: none; }
        .btn-warning { background: var(--warning); color: white; border: none; }
        .btn-danger { background: var(--danger); color: white; border: none; }
        .btn-sm { padding: 0.5rem 1.2rem; font-size: 0.85rem; }

        input, select, textarea {
            background: var(--input-bg);
            border: 1px solid var(--border);
            padding: 0.8rem 1.2rem;
            border-radius: 30px;
            width: 100%;
            margin-bottom: 1rem;
            color: var(--text);
            font-size: 0.95rem;
        }

        label { font-weight: 600; margin-bottom: 0.4rem; display: block; color: var(--text-light); font-size: 0.9rem; }

        .table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card);
            border-radius: 20px;
            overflow: hidden;
            margin: 1rem 0;
            display: block;
            overflow-x: auto;
            white-space: nowrap;
        }

        .table th { background: var(--accent-light); text-align: left; padding: 1rem; }
        .table td { padding: 0.9rem 1rem; border-bottom: 1px solid var(--border); }

        .badge { padding: 0.3rem 0.8rem; border-radius: 30px; font-size: 0.75rem; background: var(--accent-light); color: var(--accent); font-weight: 600; }
        .fila-acciones i { margin: 0 6px; cursor: pointer; opacity: 0.7; font-size: 1rem; }
        .fila-acciones i:hover { opacity: 1; color: var(--accent); }
        .barra-acciones { display: flex; gap: 10px; flex-wrap: wrap; margin: 1.5rem 0; }

        .toast {
            position: fixed; bottom: 20px; right: 20px; background: var(--accent); color: white; padding: 1rem 2rem; border-radius: 60px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: none; z-index: 9999; font-weight: 500;
        }

        .alert { padding: 1rem 1.5rem; border-radius: 30px; margin: 1rem 0; border-left: 8px solid; }
        .alert-warning { background: #fff1d6; border-color: var(--warning); color: #6b4100; }
        .dark .alert-warning { background: #362d1a; color: #ffdcaa; }

        /* Calendario asistencia */
        .calendario {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
            margin: 1rem 0;
            overflow-x: auto;
        }
        .dia { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 0.5rem; text-align: center; min-width: 90px; }
        .dia select { margin-top: 4px; font-size: 0.75rem; padding: 0.2rem; width: 100%; }

        /* Responsive m√≥vil */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            .sidebar {
                width: 100%; padding: 1rem; max-height: 80px; overflow: visible; flex-direction: row; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 1000;
            }
            .sidebar h2 { margin-bottom: 0; border-bottom: none; padding-bottom: 0; font-size: 1.2rem; }
            .sidebar nav { flex-direction: row; overflow-x: auto; gap: 0.2rem; }
            .sidebar button { padding: 0.5rem 0.8rem; font-size: 0.8rem; white-space: nowrap; }
            .sidebar-footer { display: none; }
            .main-content { padding: 1rem; max-height: none; }
            .header-bar { flex-direction: column; align-items: flex-start; padding: 1rem; }
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
            .barra-acciones { flex-direction: column; align-items: stretch; }
            .btn { justify-content: center; }
        }

        .componente-desactivado { opacity: 0.5; pointer-events: none; }
        .indicador-modalidad { background: var(--accent-light); padding: 0.3rem 1rem; border-radius: 30px; font-size: 0.8rem; font-weight: 600; }
        .rubrica-item { border-left: 4px solid var(--accent); padding-left: 1rem; margin-bottom: 1rem; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2><i class="fas fa-chalkboard-teacher"></i> MEP 2026</h2>
        <nav id="menuNav">
            <button data-tab="tab1" class="active"><i class="fas fa-cog"></i> Config</button>
            <button data-tab="tab2"><i class="fas fa-users"></i> Grupos</button>
            <button data-tab="tab3"><i class="fas fa-star"></i> Evaluaci√≥n</button>
            <button data-tab="tab4"><i class="fas fa-tasks"></i> Instrumentos</button>
            <button data-tab="tab5"><i class="fas fa-calendar-check"></i> Asistencia</button>
            <button data-tab="tab6"><i class="fas fa-book-open"></i> Bit√°cora</button>
            <button data-tab="tab7"><i class="fas fa-chart-bar"></i> Reportes</button>
            <button data-tab="tab8"><i class="fas fa-file-certificate"></i> Acta</button>
            <button data-tab="tab9"><i class="fas fa-database"></i> Respaldos</button>
        </nav>
        <div class="sidebar-footer"><i class="fas fa-sync-alt"></i> auto</div>
    </div>

    <div class="main-content">
        <div class="header-bar">
            <h1><i class="fas fa-clipboard-list"></i> <span id="currentInstitucion">Liceo MEP</span></h1>
            <div class="modo-toggle" id="toggleModo"><i class="fas fa-moon"></i> <span>Modo oscuro</span></div>
        </div>

        <!-- PANEL 1: CONFIGURACI√ìN (con modalidad) -->
        <div id="tab1" class="tab-panel active">
            <div class="card">
                <h3>‚öôÔ∏è Configuraci√≥n General</h3>
                <div class="grid-2">
                    <div>
                        <label>Instituci√≥n</label>
                        <input id="institucionNombre" placeholder="Nombre" value="Liceo de Costa Rica">
                        <label>Logo URL (opcional)</label>
                        <input id="institucionLogo" placeholder="https://...">
                        <button class="btn btn-primary" id="guardarInstitucion"><i class="fas fa-save"></i> Guardar</button>
                    </div>
                    <div>
                        <label>Modalidad del centro</label>
                        <select id="selectModalidad">
                            <option value="primaria">Educaci√≥n Primaria</option>
                            <option value="secundaria" selected>Secundaria Acad√©mica</option>
                            <option value="tecnica">Educaci√≥n T√©cnica / CINDEA</option>
                            <option value="epja">EPJA (J√≥venes y Adultos)</option>
                        </select>
                        <span class="indicador-modalidad" id="modalidadLabel">Secundaria Acad√©mica</span>
                    </div>
                </div>
                <hr style="margin:2rem 0">
                <h4>üìÖ Periodos y porcentajes (solo componentes activos seg√∫n modalidad)</h4>
                <div id="periodosContainer"></div>
                <div class="barra-acciones">
                    <button class="btn" id="agregarPeriodo"><i class="fas fa-plus"></i> Nuevo periodo</button>
                    <button class="btn btn-primary" id="guardarPorcentajes"><i class="fas fa-check"></i> Validar y guardar</button>
                </div>
                <div class="alert" id="totalPorcentajesDisplay">Total suma: 0% (debe ser 100%)</div>
                <div id="componentesActivosMsg" class="alert-warning" style="margin-top:1rem"></div>
            </div>
        </div>

        <!-- PANEL 2: GRUPOS -->
        <div id="tab2" class="tab-panel">
            <div class="card">
                <h3>üìö Grupos y Estudiantes</h3>
                <div class="barra-acciones">
                    <button class="btn" id="btnNuevoGrupo"><i class="fas fa-layer-group"></i> Nuevo grupo</button>
                    <button class="btn" id="btnImportarCSVEst"><i class="fas fa-file-import"></i> Importar CSV</button>
                    <button class="btn" id="btnExportarCSVEst"><i class="fas fa-file-export"></i> Exportar CSV</button>
                </div>
                <div id="gruposList"></div>
            </div>
        </div>

        <!-- PANEL 3: EVALUACI√ìN -->
        <div id="tab3" class="tab-panel">
            <div class="card">
                <h3>üìù Registro de Componentes</h3>
                <div class="grid-3">
                    <div><label>Grupo</label><select id="evalGrupoSelect"></select></div>
                    <div><label>Estudiante</label><select id="evalEstudianteSelect"></select></div>
                    <div><label>Periodo</label><select id="evalPeriodoSelect"></select></div>
                </div>
                <div id="notasForm" style="margin: 2rem 0;"></div>
                <button class="btn btn-primary" id="guardarNotas"><i class="fas fa-calculator"></i> Calcular y guardar</button>
                <div id="promedioCalculado" class="alert" style="margin-top:1rem"></div>
            </div>
        </div>

        <!-- PANEL 4: INSTRUMENTOS (completo) -->
        <div id="tab4" class="tab-panel">
            <div class="card">
                <h3>üìã Instrumentos de Evaluaci√≥n</h3>
                <div class="barra-acciones">
                    <button class="btn" id="nuevoInstrumento"><i class="fas fa-plus"></i> Nuevo instrumento</button>
                    <select id="tipoInstrumento">
                        <option value="rubrica">R√∫brica anal√≠tica</option>
                        <option value="lista">Lista de cotejo</option>
                        <option value="escala">Escala de desempe√±o</option>
                        <option value="prueba">Prueba estructurada</option>
                    </select>
                </div>
                <div id="instrumentosList" class="grid-3"></div>
                <div id="instrumentoEditor" style="margin-top:2rem; display:none;">
                    <h4 id="editorTitulo">Editar instrumento</h4>
                    <input type="text" id="instrumentoNombre" placeholder="Nombre del instrumento">
                    <div id="indicadoresContainer"></div>
                    <button class="btn btn-success" id="guardarInstrumento"><i class="fas fa-save"></i> Guardar instrumento</button>
                </div>
            </div>
        </div>

        <!-- PANEL 5: ASISTENCIA (completo) -->
        <div id="tab5" class="tab-panel">
            <div class="card">
                <h3>üìÖ Control de Asistencia</h3>
                <div class="grid-2">
                    <div><label>Grupo</label><select id="asistGrupoSelect"></select></div>
                    <div><label>Mes</label><input type="month" id="asistMes" value="2026-02"></div>
                </div>
                <div id="calendarioAsistencia"></div>
                <div class="barra-acciones">
                    <button class="btn" id="guardarAsistencia"><i class="fas fa-save"></i> Guardar asistencia</button>
                    <button class="btn btn-warning" id="generarAlertaWA"><i class="fab fa-whatsapp"></i> Alerta WhatsApp</button>
                    <button class="btn" id="reporteAusentismo"><i class="fas fa-chart-line"></i> Reporte ausentismo</button>
                </div>
                <div id="ausentismoResultado"></div>
            </div>
        </div>

        <!-- PANEL 6: BIT√ÅCORA (completa) -->
        <div id="tab6" class="tab-panel">
            <div class="card">
                <h3>üìì Bit√°cora Docente</h3>
                <div class="barra-acciones">
                    <button class="btn" id="nuevaEntradaBitacora"><i class="fas fa-pen"></i> Nueva entrada</button>
                    <input type="text" id="buscarBitacora" placeholder="Buscar por tema...">
                    <button class="btn" id="exportarBitacoraPDF"><i class="fas fa-file-pdf"></i> PDF</button>
                    <button class="btn" id="exportarBitacoraWord"><i class="fas fa-file-word"></i> Word</button>
                </div>
                <div id="bitacoraEntries" style="margin-top:2rem;"></div>
            </div>
        </div>

        <!-- PANEL 7: REPORTES (completos) -->
        <div id="tab7" class="tab-panel">
            <div class="card">
                <h3>üìä Reportes por Periodo</h3>
                <div class="grid-3">
                    <div><label>Periodo</label><select id="reportePeriodoSelect"></select></div>
                    <div><label>Grupo</label><select id="reporteGrupoSelect"></select></div>
                    <div><label>Estudiante</label><select id="reporteEstudianteSelect"><option value="">Todos</option></select></div>
                </div>
                <div class="barra-acciones">
                    <button class="btn" id="generarReporteIndividual"><i class="fas fa-user"></i> Individual</button>
                    <button class="btn" id="generarReporteGrupal"><i class="fas fa-users"></i> Grupal</button>
                    <button class="btn" id="exportarReportePDF"><i class="fas fa-file-pdf"></i> Exportar PDF</button>
                    <button class="btn" id="exportarReporteWord"><i class="fas fa-file-word"></i> Exportar Word</button>
                    <button class="btn" id="exportarReporteCSV"><i class="fas fa-file-csv"></i> Exportar CSV</button>
                </div>
                <div id="reporteResultado" style="margin-top:2rem;"></div>
            </div>
        </div>

        <!-- PANEL 8: ACTA FINAL (completa) -->
        <div id="tab8" class="tab-panel">
            <div class="card">
                <h3>üìú Acta Final de Curso Lectivo</h3>
                <div class="barra-acciones">
                    <button class="btn btn-primary" id="consolidarActa"><i class="fas fa-file-signature"></i> Consolidar acta</button>
                    <button class="btn" id="exportarActaPDF"><i class="fas fa-file-pdf"></i> Exportar PDF</button>
                    <button class="btn" id="exportarActaWord"><i class="fas fa-file-word"></i> Exportar Word</button>
                </div>
                <div id="actaResultado" style="margin-top:2rem; white-space:pre-wrap; font-family: monospace;"></div>
            </div>
        </div>

        <!-- PANEL 9: RESPALDOS (completos) -->
        <div id="tab9" class="tab-panel">
            <div class="card">
                <h3>üíæ Respaldo Global</h3>
                <div class="grid-2">
                    <div>
                        <button class="btn btn-primary" id="exportarJSON"><i class="fas fa-download"></i> Exportar JSON</button>
                        <button class="btn" id="importarJSONBtn"><i class="fas fa-upload"></i> Importar JSON</button>
                        <input type="file" id="importJSONFile" accept=".json" style="display:none;">
                    </div>
                    <div>
                        <button class="btn" id="exportarTodoCSV"><i class="fas fa-file-csv"></i> Exportar CSV masivo</button>
                    </div>
                </div>
                <hr>
                <p><strong>√öltima copia:</strong> <span id="fechaUltimoRespaldo">nunca</span></p>
            </div>
        </div>

        <div class="toast" id="toastMsg">‚úÖ Listo</div>
    </div>

    <!-- INYECTAR PARTE 2 AQU√ç -->
    <!-- (este marcador se reemplazar√° con el c√≥digo de la parte 2) -->

    <script>
        // ----- INICIO DE LA PARTE 1 (JS BASE) -----
        // Configuraci√≥n de modalidades seg√∫n Reglamento MEP 2026
        const MODALIDADES = {
            primaria: {
                nombre: 'Educaci√≥n Primaria',
                componentes: { tc: true, tareas: true, proyecto: false, prueba: true, demo: false },
                etiquetas: { tc: 'Trabajo Cotidiano', tareas: 'Tareas', proyecto: 'Proyecto', prueba: 'Prueba', demo: 'Demostraci√≥n' }
            },
            secundaria: {
                nombre: 'Secundaria Acad√©mica',
                componentes: { tc: true, tareas: true, proyecto: true, prueba: true, demo: false },
                etiquetas: { tc: 'Trabajo Cotidiano', tareas: 'Tareas', proyecto: 'Proyecto', prueba: 'Prueba', demo: 'Demostraci√≥n' }
            },
            tecnica: {
                nombre: 'Educaci√≥n T√©cnica / CINDEA',
                componentes: { tc: true, tareas: true, proyecto: true, prueba: false, demo: true },
                etiquetas: { tc: 'Trabajo Cotidiano', tareas: 'Tareas', proyecto: 'Proyecto', prueba: 'Prueba', demo: 'Demostraci√≥n' }
            },
            epja: {
                nombre: 'Educaci√≥n de Personas J√≥venes y Adultas',
                componentes: { tc: true, tareas: false, proyecto: true, prueba: false, demo: true },
                etiquetas: { tc: 'Trabajo Cotidiano', tareas: 'Tareas', proyecto: 'Proyecto', prueba: 'Prueba', demo: 'Demostraci√≥n' }
            }
        };

        // Estado inicial completo
        let state = {
            institucion: { nombre: 'Liceo de Costa Rica', logo: '' },
            modalidad: 'secundaria',
            periodos: [
                { id: 'p1', nombre: 'I Periodo', tc: 30, tareas: 20, proyecto: 20, prueba: 30, demo: 0, activo: true },
                { id: 'p2', nombre: 'II Periodo', tc: 30, tareas: 20, proyecto: 20, prueba: 30, demo: 0, activo: true },
                { id: 'p3', nombre: 'III Periodo', tc: 30, tareas: 20, proyecto: 20, prueba: 30, demo: 0, activo: true }
            ],
            grupos: [
                { id: 'g1', nombre: '7-1', nivel: 'Secundaria', estudiantes: [
                    { id: 'e1', nombre: 'Mar√≠a P√©rez', telefono: '8888-1111', correo: 'maria@e.cr', acs: false, observaciones: '', traslados: [], notas: {} },
                    { id: 'e2', nombre: 'Juan Castro', telefono: '8888-2222', correo: 'juan@e.cr', acs: true, observaciones: 'ACS', traslados: [], notas: {} }
                ]}
            ],
            instrumentos: [], // cada instrumento: { id, nombre, tipo, indicadores: [] }
            bitacora: [],
            asistencia: [], // { id, fecha, grupoId, estudianteId, estado }
            respaldo: { fecha: null }
        };

        // Cargar de localStorage
        (function() {
            try {
                const saved = localStorage.getItem('mepFinalCompleto');
                if (saved) state = JSON.parse(saved);
            } catch(e) { console.warn('Error cargando estado'); }
        })();

        function saveToast(msg = '‚úÖ Guardado') {
            localStorage.setItem('mepFinalCompleto', JSON.stringify(state));
            const t = document.getElementById('toastMsg');
            t.style.display = 'block'; t.innerText = msg;
            setTimeout(() => t.style.display = 'none', 2000);
        }

        // Utilidades
        function componentesActivos() {
            return MODALIDADES[state.modalidad]?.componentes || MODALIDADES.secundaria.componentes;
        }

        function validarSumaPeriodo(p) {
            let comp = componentesActivos();
            let suma = 0;
            if(comp.tc) suma += p.tc || 0;
            if(comp.tareas) suma += p.tareas || 0;
            if(comp.proyecto) suma += p.proyecto || 0;
            if(comp.prueba) suma += p.prueba || 0;
            if(comp.demo) suma += p.demo || 0;
            return suma;
        }

        function actualizarMsgComponentes() {
            let comp = componentesActivos();
            let activos = [];
            if(comp.tc) activos.push('TC');
            if(comp.tareas) activos.push('Tareas');
            if(comp.proyecto) activos.push('Proyecto');
            if(comp.prueba) activos.push('Prueba');
            if(comp.demo) activos.push('Demostraci√≥n');
            document.getElementById('componentesActivosMsg').innerHTML = `üìå Componentes activos: <strong>${activos.join(' ¬∑ ')}</strong>`;
            document.getElementById('modalidadLabel').innerText = MODALIDADES[state.modalidad]?.nombre || 'Secundaria';
        }

        // Renderizado b√°sico de periodos
        function renderPeriodos() {
            let container = document.getElementById('periodosContainer');
            if(!container) return;
            let comp = componentesActivos();
            let html = '';
            state.periodos.forEach((p, idx) => {
                html += `<div style="border:1px solid var(--border); border-radius:24px; padding:1.5rem; margin-bottom:1.5rem;">`;
                html += `<input type="text" value="${p.nombre}" placeholder="Nombre" data-idx="${idx}" class="periodoNombre" style="margin-bottom:1rem;">`;
                html += `<div style="display:flex; flex-wrap:wrap; gap:1rem;">`;
                if(comp.tc) html += `<label>TC <input type="number" class="periodoTc" data-idx="${idx}" value="${p.tc}" min="0" max="100" style="width:90px;"></label>`;
                if(comp.tareas) html += `<label>Tareas <input type="number" class="periodoTareas" data-idx="${idx}" value="${p.tareas}" min="0" max="100" style="width:90px;"></label>`;
                if(comp.proyecto) html += `<label>Proyecto <input type="number" class="periodoProyecto" data-idx="${idx}" value="${p.proyecto}" min="0" max="100" style="width:90px;"></label>`;
                if(comp.prueba) html += `<label>Prueba <input type="number" class="periodoPrueba" data-idx="${idx}" value="${p.prueba}" min="0" max="100" style="width:90px;"></label>`;
                if(comp.demo) html += `<label>Demostraci√≥n <input type="number" class="periodoDemo" data-idx="${idx}" value="${p.demo || 0}" min="0" max="100" style="width:90px;"></label>`;
                html += `</div>`;
                html += `<button class="btn btn-sm btn-danger eliminarPeriodo" data-idx="${idx}" style="margin-top:1rem;"><i class="fas fa-trash"></i> Eliminar</button>`;
                html += `</div>`;
            });
            container.innerHTML = html;
            actualizarMsgComponentes();
            recalcularTotalPeriodos();
        }

        function recalcularTotalPeriodos() {
            let sumaTotal = 0;
            state.periodos.forEach(p => { sumaTotal += validarSumaPeriodo(p); });
            document.getElementById('totalPorcentajesDisplay').innerText = `Total suma: ${sumaTotal}% (debe ser 100%)`;
            if(sumaTotal !== 100) document.getElementById('totalPorcentajesDisplay').className = 'alert alert-warning';
            else document.getElementById('totalPorcentajesDisplay').className = 'alert';
        }

        // Render grupos b√°sico
        function renderGrupos() {
            let div = document.getElementById('gruposList');
            if(!div) return;
            let html = '';
            state.grupos.forEach((g, idxG) => {
                html += `<div style="background:var(--accent-light); padding:1.5rem; border-radius:24px; margin-bottom:1.5rem;">`;
                html += `<div style="display:flex; justify-content:space-between;"><h4>${g.nombre}</h4>`;
                html += `<div><button class="btn btn-sm" onclick="editarGrupo(${idxG})"><i class="fas fa-edit"></i></button> <button class="btn btn-sm btn-danger" onclick="eliminarGrupo(${idxG})"><i class="fas fa-trash"></i></button></div></div>`;
                html += `<table class="table"><tr><th>Nombre</th><th>Tel√©fono</th><th>ACS</th><th>Acciones</th></tr>`;
                (g.estudiantes || []).forEach((e, idxE) => {
                    html += `<tr><td>${e.nombre}</td><td>${e.telefono || ''}</td><td>${e.acs ? 'ACS' : ''}</td>`;
                    html += `<td class="fila-acciones"><i class="fas fa-edit" onclick="editarEstudiante(${idxG},${idxE})"></i> <i class="fas fa-trash" onclick="eliminarEstudiante(${idxG},${idxE})"></i></td></tr>`;
                });
                html += `</table><button class="btn btn-sm" onclick="agregarEstudiante(${idxG})"><i class="fas fa-user-plus"></i> A√±adir</button>`;
                html += `</div>`;
            });
            div.innerHTML = html || '<p>No hay grupos</p>';
        }

        // Funciones globales para botones inline
        window.agregarEstudiante = (g) => { 
            let nom = prompt('Nombre completo'); 
            if(nom) { 
                state.grupos[g].estudiantes.push({ 
                    id: 'e'+Date.now()+Math.random(), 
                    nombre: nom, 
                    telefono: '', 
                    correo: '', 
                    acs: false, 
                    observaciones: '', 
                    traslados: [], 
                    notas: {} 
                }); 
                saveToast(); 
                renderGrupos(); 
            } 
        };
        window.editarEstudiante = (g, e) => { 
            let est = state.grupos[g].estudiantes[e]; 
            est.nombre = prompt('Nombre', est.nombre) || est.nombre; 
            est.telefono = prompt('Tel√©fono', est.telefono || ''); 
            est.acs = confirm('¬øACS?'); 
            saveToast(); 
            renderGrupos(); 
        };
        window.eliminarEstudiante = (g, e) => { 
            if(confirm('¬øEliminar estudiante?')) { 
                state.grupos[g].estudiantes.splice(e,1); 
                saveToast(); 
                renderGrupos(); 
            } 
        };
        window.editarGrupo = (g) => { 
            let nom = prompt('Nombre del grupo', state.grupos[g].nombre); 
            if(nom) { 
                state.grupos[g].nombre = nom; 
                saveToast(); 
                renderGrupos(); 
            } 
        };
        window.eliminarGrupo = (g) => { 
            if(confirm('¬øEliminar grupo completo?')) { 
                state.grupos.splice(g,1); 
                saveToast(); 
                renderGrupos(); 
            } 
        };

        // Llenar selects b√°sicos
        function llenarSelectores() {
            let selEvalG = document.getElementById('evalGrupoSelect');
            let selAsist = document.getElementById('asistGrupoSelect');
            let selRepoG = document.getElementById('reporteGrupoSelect');
            let op = '<option value="">-- Seleccionar --</option>' + state.grupos.map((g,i)=>`<option value="${i}">${g.nombre}</option>`).join('');
            if(selEvalG) selEvalG.innerHTML = op;
            if(selAsist) selAsist.innerHTML = op;
            if(selRepoG) selRepoG.innerHTML = op;

            let selPeriodo = document.getElementById('evalPeriodoSelect');
            if(selPeriodo) selPeriodo.innerHTML = state.periodos.map((p,i)=>`<option value="${i}">${p.nombre}</option>`).join('');

            let selRepoP = document.getElementById('reportePeriodoSelect');
            if(selRepoP) selRepoP.innerHTML = state.periodos.map((p,i)=>`<option value="${i}">${p.nombre}</option>`).join('');
        }

        // Event listeners b√°sicos
        document.getElementById('toggleModo')?.addEventListener('click', () => document.body.classList.toggle('dark'));

        document.querySelectorAll('#menuNav button').forEach(b => {
            b.addEventListener('click', (e) => {
                document.querySelectorAll('#menuNav button').forEach(bb => bb.classList.remove('active'));
                b.classList.add('active');
                document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
                document.getElementById(b.dataset.tab).classList.add('active');
            });
        });

        document.getElementById('guardarInstitucion')?.addEventListener('click', ()=>{
            state.institucion.nombre = document.getElementById('institucionNombre').value;
            state.institucion.logo = document.getElementById('institucionLogo').value;
            document.getElementById('currentInstitucion').innerText = state.institucion.nombre;
            saveToast();
        });

        document.getElementById('selectModalidad')?.addEventListener('change', (e)=>{
            state.modalidad = e.target.value;
            saveToast();
            renderPeriodos();
            llenarSelectores();
        });

        document.getElementById('agregarPeriodo')?.addEventListener('click', ()=>{
            state.periodos.push({ id:'p'+Date.now(), nombre:'Nuevo periodo', tc:25, tareas:25, proyecto:25, prueba:25, demo:0 });
            saveToast();
            renderPeriodos();
            llenarSelectores();
        });

        document.getElementById('guardarPorcentajes')?.addEventListener('click', ()=>{
            document.querySelectorAll('.periodoNombre').forEach(i => { let idx=i.dataset.idx; state.periodos[idx].nombre = i.value; });
            document.querySelectorAll('.periodoTc').forEach(i => { let idx=i.dataset.idx; state.periodos[idx].tc = parseInt(i.value)||0; });
            document.querySelectorAll('.periodoTareas').forEach(i => { let idx=i.dataset.idx; state.periodos[idx].tareas = parseInt(i.value)||0; });
            document.querySelectorAll('.periodoProyecto').forEach(i => { let idx=i.dataset.idx; state.periodos[idx].proyecto = parseInt(i.value)||0; });
            document.querySelectorAll('.periodoPrueba').forEach(i => { let idx=i.dataset.idx; state.periodos[idx].prueba = parseInt(i.value)||0; });
            document.querySelectorAll('.periodoDemo').forEach(i => { let idx=i.dataset.idx; state.periodos[idx].demo = parseInt(i.value)||0; });
            let ok = true;
            state.periodos.forEach((p,idx) => { let s = validarSumaPeriodo(p); if(s !== 100) { alert(`Periodo ${p.nombre} suma ${s}%`); ok = false; } });
            if(ok) { saveToast('‚úÖ Porcentajes v√°lidos'); renderPeriodos(); }
        });

        document.getElementById('btnNuevoGrupo')?.addEventListener('click', ()=>{
            let nom = prompt('Nombre del grupo (ej. 8-2)');
            if(nom) { state.grupos.push({ id:'g'+Date.now(), nombre: nom, nivel: 'Secundaria', estudiantes: [] }); saveToast(); renderGrupos(); llenarSelectores(); }
        });

        document.getElementById('btnExportarCSVEst')?.addEventListener('click', ()=>{
            let csv = "Grupo,Nombre,Tel√©fono,Correo,ACS\n";
            state.grupos.forEach(g => g.estudiantes?.forEach(e => csv+=`${g.nombre},${e.nombre},${e.telefono||''},${e.correo||''},${e.acs?1:0}\n`));
            let blob = new Blob([csv],{type:'text/csv'}); 
            let a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'estudiantes.csv'; a.click();
        });

        // Auto-guardado
        setInterval(() => saveToast('‚è≤Ô∏è Auto-guardado'), 45000);

        // Inicializar vista
        renderPeriodos();
        renderGrupos();
        llenarSelectores();
    </script>
    <!-- ========== PARTE 2: FUNCIONALIDADES COMPLETAS ========== -->
<!-- Instrucciones: Pegar este contenido justo despu√©s del marcador en la Parte 1, antes del cierre </body> -->

<script>
    // ============================================================
    // PARTE 2: M√ìDULOS COMPLETOS - INSTRUMENTOS, ASISTENCIA, 
    // BIT√ÅCORA, REPORTES, ACTA FINAL, EXPORTACIONES
    // ============================================================

    // ---------- 1. INSTRUMENTOS (R√∫bricas, Listas, Escalas) ----------
    function renderInstrumentos() {
        let container = document.getElementById('instrumentosList');
        if (!container) return;
        
        let html = '';
        state.instrumentos.forEach((inst, idx) => {
            html += `<div class="card" style="padding:1.2rem; cursor:pointer;" onclick="editarInstrumento(${idx})">`;
            html += `<div style="display:flex; justify-content:space-between;">`;
            html += `<strong>${inst.nombre}</strong>`;
            html += `<span class="badge">${inst.tipo}</span>`;
            html += `</div>`;
            html += `<small>${inst.indicadores?.length || 0} indicadores</small>`;
            html += `<div style="margin-top:1rem;">`;
            html += `<i class="fas fa-copy" onclick="duplicarInstrumento(${idx}); event.stopPropagation();"></i> `;
            html += `<i class="fas fa-trash" onclick="eliminarInstrumento(${idx}); event.stopPropagation();"></i>`;
            html += `</div>`;
            html += `</div>`;
        });
        container.innerHTML = html || '<p>No hay instrumentos. Cree uno nuevo.</p>';
    }

    window.eliminarInstrumento = (idx) => {
        if (confirm('¬øEliminar instrumento?')) {
            state.instrumentos.splice(idx, 1);
            saveToast();
            renderInstrumentos();
        }
    };

    window.duplicarInstrumento = (idx) => {
        let copia = JSON.parse(JSON.stringify(state.instrumentos[idx]));
        copia.id = 'inst' + Date.now() + Math.random();
        copia.nombre += ' (copia)';
        state.instrumentos.push(copia);
        saveToast();
        renderInstrumentos();
    };

    let instrumentoEditando = null;

    window.editarInstrumento = (idx) => {
        instrumentoEditando = idx;
        let inst = state.instrumentos[idx];
        document.getElementById('instrumentoEditor').style.display = 'block';
        document.getElementById('editorTitulo').innerText = 'Editando: ' + inst.nombre;
        document.getElementById('instrumentoNombre').value = inst.nombre;
        
        let indicadoresContainer = document.getElementById('indicadoresContainer');
        let html = '<h5>Indicadores / Criterios</h5>';
        
        if (inst.tipo === 'rubrica') {
            html += `<p><small>R√∫brica anal√≠tica - definir niveles (4=Excelente, 3=Bueno, 2=Suficiente, 1=Insuficiente)</small></p>`;
            (inst.indicadores || []).forEach((ind, i) => {
                html += `<div class="rubrica-item" style="margin-bottom:1.5rem; padding:1rem; background:var(--accent-light); border-radius:16px;">`;
                html += `<input type="text" placeholder="Indicador" value="${ind.nombre || ''}" id="ind_nombre_${i}" style="width:100%;">`;
                for (let nivel = 4; nivel >= 1; nivel--) {
                    let nivelNombre = nivel === 4 ? 'Excelente' : (nivel === 3 ? 'Bueno' : (nivel === 2 ? 'Suficiente' : 'Insuficiente'));
                    html += `<label>${nivelNombre}: <input type="text" value="${ind.niveles?.[nivel] || ''}" id="ind_${i}_nivel${nivel}" placeholder="Descripci√≥n"></label>`;
                }
                html += `<button class="btn btn-sm btn-danger" onclick="eliminarIndicador(${i})" style="margin-top:0.5rem;">Eliminar indicador</button>`;
                html += `</div>`;
            });
        } else if (inst.tipo === 'lista') {
            html += `<p><small>Lista de cotejo (S√≠/No)</small></p>`;
            (inst.indicadores || []).forEach((ind, i) => {
                html += `<div style="margin-bottom:1rem;">`;
                html += `<input type="text" placeholder="Criterio" value="${ind.nombre || ''}" id="ind_nombre_${i}" style="width:80%; display:inline-block;">`;
                html += `<button class="btn btn-sm btn-danger" onclick="eliminarIndicador(${i})"><i class="fas fa-trash"></i></button>`;
                html += `</div>`;
            });
        } else {
            // escala o prueba
            (inst.indicadores || []).forEach((ind, i) => {
                html += `<div><input type="text" placeholder="Indicador" value="${ind.nombre || ''}" id="ind_nombre_${i}" style="width:80%;">`;
                html += `<button class="btn btn-sm btn-danger" onclick="eliminarIndicador(${i})"><i class="fas fa-trash"></i></button></div>`;
            });
        }
        
        html += `<button class="btn btn-sm" id="agregarIndicadorBtn"><i class="fas fa-plus"></i> Agregar indicador</button>`;
        indicadoresContainer.innerHTML = html;
        
        document.getElementById('agregarIndicadorBtn')?.addEventListener('click', () => {
            if (!state.instrumentos[instrumentoEditando].indicadores) 
                state.instrumentos[instrumentoEditando].indicadores = [];
            state.instrumentos[instrumentoEditando].indicadores.push({ nombre: '' });
            editarInstrumento(instrumentoEditando); // re-render
        });
    };

    window.eliminarIndicador = (idxInd) => {
        if (instrumentoEditando !== null) {
            state.instrumentos[instrumentoEditando].indicadores.splice(idxInd, 1);
            editarInstrumento(instrumentoEditando);
        }
    };

    document.getElementById('guardarInstrumento')?.addEventListener('click', () => {
        if (instrumentoEditando === null) return;
        let inst = state.instrumentos[instrumentoEditando];
        inst.nombre = document.getElementById('instrumentoNombre').value;
        
        // Guardar indicadores seg√∫n tipo
        if (inst.tipo === 'rubrica') {
            inst.indicadores = inst.indicadores || [];
            inst.indicadores.forEach((ind, i) => {
                ind.nombre = document.getElementById(`ind_nombre_${i}`)?.value || '';
                ind.niveles = {
                    4: document.getElementById(`ind_${i}_nivel4`)?.value || '',
                    3: document.getElementById(`ind_${i}_nivel3`)?.value || '',
                    2: document.getElementById(`ind_${i}_nivel2`)?.value || '',
                    1: document.getElementById(`ind_${i}_nivel1`)?.value || ''
                };
            });
        } else {
            inst.indicadores = inst.indicadores || [];
            inst.indicadores.forEach((ind, i) => {
                ind.nombre = document.getElementById(`ind_nombre_${i}`)?.value || '';
            });
        }
        
        saveToast('‚úÖ Instrumento guardado');
        document.getElementById('instrumentoEditor').style.display = 'none';
        renderInstrumentos();
    });

    document.getElementById('nuevoInstrumento')?.addEventListener('click', () => {
        let tipo = document.getElementById('tipoInstrumento').value;
        let nombre = prompt('Nombre del instrumento', 'Nuevo instrumento');
        if (!nombre) return;
        
        let nuevo = {
            id: 'inst' + Date.now(),
            nombre: nombre,
            tipo: tipo,
            indicadores: []
        };
        state.instrumentos.push(nuevo);
        saveToast();
        renderInstrumentos();
        editarInstrumento(state.instrumentos.length - 1);
    });

    // ---------- 2. ASISTENCIA COMPLETA (calendario + reporte ausentismo) ----------
    function renderCalendarioAsistencia() {
        let container = document.getElementById('calendarioAsistencia');
        let grupoSelect = document.getElementById('asistGrupoSelect');
        let mesInput = document.getElementById('asistMes');
        if (!container || !grupoSelect) return;

        let grupoIdx = grupoSelect.value;
        if (grupoIdx === '') {
            container.innerHTML = '<p>Seleccione un grupo</p>';
            return;
        }
        let grupo = state.grupos[grupoIdx];
        let fechaBase = mesInput.value ? new Date(mesInput.value + '-01') : new Date();
        let year = fechaBase.getFullYear();
        let month = fechaBase.getMonth();
        let diasEnMes = new Date(year, month + 1, 0).getDate();

        let html = '<div class="calendario">';
        for (let d = 1; d <= diasEnMes; d++) {
            let fechaStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            html += `<div class="dia">`;
            html += `<div><strong>${d}</strong></div>`;
            
            grupo.estudiantes.forEach((est, estIdx) => {
                let asistKey = `${fechaStr}_${grupo.id}_${est.id}`;
                let registro = state.asistencia.find(a => a.id === asistKey);
                let estado = registro ? registro.estado : 'P';
                html += `<select data-fecha="${fechaStr}" data-grupo="${grupoIdx}" data-estudiante="${estIdx}" class="asistSelect" style="margin-top:2px; font-size:0.7rem;">`;
                html += `<option value="P" ${estado==='P'?'selected':''}>P</option>`;
                html += `<option value="A" ${estado==='A'?'selected':''}>A</option>`;
                html += `<option value="J" ${estado==='J'?'selected':''}>J</option>`;
                html += `<option value="T" ${estado==='T'?'selected':''}>T</option>`;
                html += `</select>`;
            });
            html += '</div>';
        }
        html += '</div>';
        container.innerHTML = html;
    }

    document.getElementById('guardarAsistencia')?.addEventListener('click', () => {
        let selects = document.querySelectorAll('.asistSelect');
        selects.forEach(sel => {
            let fecha = sel.dataset.fecha;
            let grupoIdx = sel.dataset.grupo;
            let estudianteIdx = sel.dataset.estudiante;
            let estado = sel.value;
            let grupo = state.grupos[grupoIdx];
            let estudiante = grupo.estudiantes[estudianteIdx];
            let asistId = `${fecha}_${grupo.id}_${estudiante.id}`;
            let idx = state.asistencia.findIndex(a => a.id === asistId);
            if (idx >= 0) state.asistencia[idx].estado = estado;
            else state.asistencia.push({ id: asistId, fecha, grupoId: grupo.id, estudianteId: estudiante.id, estado });
        });
        saveToast('‚úÖ Asistencia guardada');
    });

    document.getElementById('generarAlertaWA')?.addEventListener('click', () => {
        let grupoIdx = document.getElementById('asistGrupoSelect').value;
        if (grupoIdx === '') return alert('Seleccione un grupo');
        let estudiantes = state.grupos[grupoIdx].estudiantes;
        let ausentes = [];
        
        estudiantes.forEach(e => {
            let ausencias = state.asistencia.filter(a => a.estudianteId === e.id && a.estado === 'A').length;
            if (ausencias >= 3) ausentes.push(`${e.nombre} (${ausencias} ausencias)`);
        });
        
        if (ausentes.length === 0) {
            alert('No hay estudiantes con ausencias cr√≠ticas');
            return;
        }
        
        let msg = '‚ö†Ô∏è ALERTA DE AUSENTISMO MEP\n\nEstudiantes con 3+ ausencias:\n' + ausentes.join('\n');
        window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`);
    });

    document.getElementById('reporteAusentismo')?.addEventListener('click', () => {
        let grupoIdx = document.getElementById('asistGrupoSelect').value;
        if (grupoIdx === '') return alert('Seleccione grupo');
        let grupo = state.grupos[grupoIdx];
        let html = '<h4>Reporte de ausentismo</h4><table class="table"><tr><th>Estudiante</th><th>Ausencias (A)</th><th>Justificadas (J)</th><th>Tard√≠as (T)</th></tr>';
        
        grupo.estudiantes.forEach(e => {
            let aus = state.asistencia.filter(a => a.estudianteId === e.id && a.estado === 'A').length;
            let jus = state.asistencia.filter(a => a.estudianteId === e.id && a.estado === 'J').length;
            let tar = state.asistencia.filter(a => a.estudianteId === e.id && a.estado === 'T').length;
            html += `<tr><td>${e.nombre}</td><td>${aus}</td><td>${jus}</td><td>${tar}</td></tr>`;
        });
        html += '</table>';
        document.getElementById('ausentismoResultado').innerHTML = html;
    });

    // ---------- 3. BIT√ÅCORA COMPLETA (con exportaciones) ----------
    function renderBitacora() {
        let div = document.getElementById('bitacoraEntries');
        if (!div) return;
        let filtro = document.getElementById('buscarBitacora')?.value?.toLowerCase() || '';
        let items = state.bitacora.filter(b => !filtro || b.tema?.toLowerCase().includes(filtro) || b.actividad?.toLowerCase().includes(filtro));
        
        let html = '';
        items.forEach((b, idx) => {
            html += `<div style="border-bottom:1px solid var(--border); padding:1rem;">`;
            html += `<strong>${b.fecha}</strong> - ${b.tema}<br>`;
            html += `<p>${b.actividad}</p>`;
            if (b.observaciones) html += `<small><i>${b.observaciones}</i></small>`;
            html += `<div class="fila-acciones">`;
            html += `<i class="fas fa-edit" onclick="editarBitacora(${idx})"></i> `;
            html += `<i class="fas fa-trash" onclick="eliminarBitacora(${idx})"></i>`;
            html += `</div></div>`;
        });
        div.innerHTML = html || '<p>No hay entradas en la bit√°cora.</p>';
    }

    window.eliminarBitacora = (idx) => {
        if (confirm('¬øEliminar entrada?')) {
            state.bitacora.splice(idx, 1);
            saveToast();
            renderBitacora();
        }
    };

    window.editarBitacora = (idx) => {
        let b = state.bitacora[idx];
        let nuevaAct = prompt('Actividad', b.actividad);
        if (nuevaAct) b.actividad = nuevaAct;
        b.observaciones = prompt('Observaciones', b.observaciones || '');
        saveToast();
        renderBitacora();
    };

    document.getElementById('nuevaEntradaBitacora')?.addEventListener('click', () => {
        let fecha = prompt('Fecha (YYYY-MM-DD)', new Date().toISOString().slice(0,10));
        let tema = prompt('Tema');
        let actividad = prompt('Actividad');
        if (tema && actividad) {
            state.bitacora.push({
                id: Date.now(),
                fecha,
                tema,
                actividad,
                observaciones: '',
                ajustesDUA: ''
            });
            saveToast();
            renderBitacora();
        }
    });

    document.getElementById('buscarBitacora')?.addEventListener('input', renderBitacora);

    // Exportar Bit√°cora PDF
    document.getElementById('exportarBitacoraPDF')?.addEventListener('click', () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text('Bit√°cora Docente - MEP 2026', 10, 10);
        let y = 20;
        state.bitacora.slice(0, 15).forEach((b, i) => {
            doc.text(`${b.fecha} - ${b.tema}`, 10, y);
            y += 7;
            doc.text(`${b.actividad.substring(0, 50)}...`, 15, y);
            y += 10;
            if (y > 280) { doc.addPage(); y = 20; }
        });
        doc.save('bitacora.pdf');
    });

    // Exportar Bit√°cora Word (simulado como HTML)
    document.getElementById('exportarBitacoraWord')?.addEventListener('click', () => {
        let html = `<html><head><meta charset="UTF-8"><title>Bit√°cora MEP</title></head><body>`;
        html += `<h1>Bit√°cora Docente</h1>`;
        state.bitacora.forEach(b => {
            html += `<div><strong>${b.fecha} - ${b.tema}</strong><br>${b.actividad}<br><i>${b.observaciones || ''}</i><hr></div>`;
        });
        html += `</body></html>`;
        let blob = new Blob([html], { type: 'application/msword' });
        let a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'bitacora.doc'; a.click();
    });

    // ---------- 4. EVALUACI√ìN COMPLETA (con selector de per√≠odo) ----------
    document.getElementById('evalGrupoSelect')?.addEventListener('change', (e) => {
        let idx = e.target.value;
        let estSelect = document.getElementById('evalEstudianteSelect');
        if (idx === '') { estSelect.innerHTML = '<option value="">--</option>'; return; }
        let estudiantes = state.grupos[idx]?.estudiantes || [];
        estSelect.innerHTML = '<option value="">-- Estudiante --</option>' + 
            estudiantes.map((es, i) => `<option value="${i}">${es.nombre}</option>`).join('');
    });

    document.getElementById('guardarNotas')?.addEventListener('click', () => {
        let gIdx = document.getElementById('evalGrupoSelect').value;
        let eIdx = document.getElementById('evalEstudianteSelect').value;
        let pIdx = document.getElementById('evalPeriodoSelect').value;
        if (gIdx === '' || eIdx === '' || pIdx === '') {
            alert('Seleccione grupo, estudiante y per√≠odo');
            return;
        }
        
        let estudiante = state.grupos[gIdx].estudiantes[eIdx];
        let periodo = state.periodos[pIdx];
        let pid = periodo.id;
        
        if (!estudiante.notas[pid]) estudiante.notas[pid] = {};
        
        let comp = componentesActivos();
        let tc = comp.tc ? parseFloat(prompt('Trabajo Cotidiano (0-100)', estudiante.notas[pid]?.tc || '0')) || 0 : 0;
        let tareas = comp.tareas ? parseFloat(prompt('Tareas (0-100)', estudiante.notas[pid]?.tareas || '0')) || 0 : 0;
        let proyecto = comp.proyecto ? parseFloat(prompt('Proyecto (0-100)', estudiante.notas[pid]?.proyecto || '0')) || 0 : 0;
        let prueba = comp.prueba ? parseFloat(prompt('Prueba (0-100)', estudiante.notas[pid]?.prueba || '0')) || 0 : 0;
        let demo = comp.demo ? parseFloat(prompt('Demostraci√≥n (0-100)', estudiante.notas[pid]?.demo || '0')) || 0 : 0;
        
        if (tc > 100 || tareas > 100 || proyecto > 100 || prueba > 100 || demo > 100) {
            alert('Las notas no pueden superar 100');
            return;
        }
        
        estudiante.notas[pid] = { tc, tareas, proyecto, prueba, demo };
        
        // C√°lculo ponderado
        let ponderado = 0;
        if (comp.tc) ponderado += tc * (periodo.tc / 100);
        if (comp.tareas) ponderado += tareas * (periodo.tareas / 100);
        if (comp.proyecto) ponderado += proyecto * (periodo.proyecto / 100);
        if (comp.prueba) ponderado += prueba * (periodo.prueba / 100);
        if (comp.demo) ponderado += demo * ((periodo.demo || 0) / 100);
        
        // F√≥rmula ACS (ejemplo: 10% de bonificaci√≥n)
        if (estudiante.acs) ponderado = Math.min(ponderado * 1.1, 100);
        
        estudiante.notas[pid].promedio = ponderado.toFixed(2);
        document.getElementById('promedioCalculado').innerHTML = 
            `<strong>‚úÖ Promedio per√≠odo ${periodo.nombre}: ${ponderado.toFixed(2)}%</strong>`;
        saveToast();
    });

    // ---------- 5. REPORTES COMPLETOS (con exportaciones reales) ----------
    document.getElementById('reporteGrupoSelect')?.addEventListener('change', (e) => {
        let gIdx = e.target.value;
        let estSelect = document.getElementById('reporteEstudianteSelect');
        if (gIdx === '') { estSelect.innerHTML = '<option value="">Todos</option>'; return; }
        let estudiantes = state.grupos[gIdx]?.estudiantes || [];
        estSelect.innerHTML = '<option value="">Todos</option>' + 
            estudiantes.map((es, i) => `<option value="${i}">${es.nombre}</option>`).join('');
    });

    function generarReporteHTML(grupoIdx, periodoIdx, estudianteIdx = null) {
        if (grupoIdx === '' || periodoIdx === '') return '<p>Seleccione grupo y per√≠odo</p>';
        let grupo = state.grupos[grupoIdx];
        let periodo = state.periodos[periodoIdx];
        let comp = componentesActivos();
        
        let html = `<h3>Reporte: ${grupo.nombre} - ${periodo.nombre}</h3>`;
        html += '<table class="table"><tr><th>Estudiante</th>';
        if (comp.tc) html += '<th>TC</th>';
        if (comp.tareas) html += '<th>Tareas</th>';
        if (comp.proyecto) html += '<th>Proyecto</th>';
        if (comp.prueba) html += '<th>Prueba</th>';
        if (comp.demo) html += '<th>Demo</th>';
        html += '<th>Promedio</th></tr>';
        
        let estudiantes = estudianteIdx !== null && estudianteIdx !== '' 
            ? [grupo.estudiantes[estudianteIdx]] 
            : grupo.estudiantes;
        
        estudiantes.forEach(e => {
            let n = e.notas[periodo.id] || {};
            html += '<tr>';
            html += `<td>${e.nombre}</td>`;
            if (comp.tc) html += `<td>${n.tc || '-'}</td>`;
            if (comp.tareas) html += `<td>${n.tareas || '-'}</td>`;
            if (comp.proyecto) html += `<td>${n.proyecto || '-'}</td>`;
            if (comp.prueba) html += `<td>${n.prueba || '-'}</td>`;
            if (comp.demo) html += `<td>${n.demo || '-'}</td>`;
            html += `<td><strong>${n.promedio || '-'}</strong></td>`;
            html += '</tr>';
        });
        html += '</table>';
        return html;
    }

    document.getElementById('generarReporteIndividual')?.addEventListener('click', () => {
        let g = document.getElementById('reporteGrupoSelect').value;
        let p = document.getElementById('reportePeriodoSelect').value;
        let e = document.getElementById('reporteEstudianteSelect').value;
        if (e === '') { alert('Seleccione un estudiante'); return; }
        document.getElementById('reporteResultado').innerHTML = generarReporteHTML(g, p, e);
    });

    document.getElementById('generarReporteGrupal')?.addEventListener('click', () => {
        let g = document.getElementById('reporteGrupoSelect').value;
        let p = document.getElementById('reportePeriodoSelect').value;
        document.getElementById('reporteResultado').innerHTML = generarReporteHTML(g, p);
    });

    // Exportar reporte PDF
    document.getElementById('exportarReportePDF')?.addEventListener('click', () => {
        let contenido = document.getElementById('reporteResultado').innerHTML;
        if (!contenido) { alert('Genere un reporte primero'); return; }
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.html(contenido, {
            callback: function(doc) {
                doc.save('reporte.pdf');
            },
            x: 10,
            y: 10,
            width: 180
        });
    });

    // Exportar reporte Word
    document.getElementById('exportarReporteWord')?.addEventListener('click', () => {
        let contenido = document.getElementById('reporteResultado').innerHTML;
        if (!contenido) { alert('Genere un reporte primero'); return; }
        
        let html = `<html><head><meta charset="UTF-8"><title>Reporte MEP</title></head><body>${contenido}</body></html>`;
        let blob = new Blob([html], { type: 'application/msword' });
        let a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'reporte.doc'; a.click();
    });

    // Exportar reporte CSV
    document.getElementById('exportarReporteCSV')?.addEventListener('click', () => {
        let g = document.getElementById('reporteGrupoSelect').value;
        let p = document.getElementById('reportePeriodoSelect').value;
        if (g === '' || p === '') { alert('Seleccione grupo y per√≠odo'); return; }
        
        let grupo = state.grupos[g];
        let periodo = state.periodos[p];
        let comp = componentesActivos();
        
        let csv = 'Estudiante';
        if (comp.tc) csv += ',TC';
        if (comp.tareas) csv += ',Tareas';
        if (comp.proyecto) csv += ',Proyecto';
        if (comp.prueba) csv += ',Prueba';
        if (comp.demo) csv += ',Demostraci√≥n';
        csv += ',Promedio\n';
        
        grupo.estudiantes.forEach(e => {
            let n = e.notas[periodo.id] || {};
            csv += e.nombre;
            if (comp.tc) csv += `,${n.tc || ''}`;
            if (comp.tareas) csv += `,${n.tareas || ''}`;
            if (comp.proyecto) csv += `,${n.proyecto || ''}`;
            if (comp.prueba) csv += `,${n.prueba || ''}`;
            if (comp.demo) csv += `,${n.demo || ''}`;
            csv += `,${n.promedio || ''}\n`;
        });
        
        let blob = new Blob([csv], { type: 'text/csv' });
        let a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'reporte.csv'; a.click();
    });

    // ---------- 6. ACTA FINAL COMPLETA (con exportaciones) ----------
    function generarActaHTML() {
        let acta = '<h2>ACTA FINAL DE EVALUACI√ìN MEP 2026</h2>';
        acta += '<p>Instituci√≥n: ' + state.institucion.nombre + '</p>';
        acta += '<table class="table"><tr><th>Grupo</th><th>Estudiante</th><th>Promedio Final</th><th>Condici√≥n</th></tr>';
        
        let incompleto = false;
        state.grupos.forEach(g => {
            g.estudiantes.forEach(e => {
                let suma = 0, count = 0;
                state.periodos.forEach(p => {
                    if (e.notas[p.id]?.promedio) {
                        suma += parseFloat(e.notas[p.id].promedio);
                        count++;
                    }
                });
                if (count < state.periodos.length) incompleto = true;
                let promFinal = count > 0 ? (suma / count).toFixed(2) : '--';
                let condicion = promFinal >= 65 ? 'Aprobado' : (promFinal > 0 ? 'Convocatoria' : 'Reprobado');
                acta += `<tr><td>${g.nombre}</td><td>${e.nombre}</td><td>${promFinal}</td><td>${condicion}</td></tr>`;
            });
        });
        acta += '</table>';
        if (incompleto) acta += '<p class="alert-warning">‚ö†Ô∏è Algunos per√≠odos tienen notas incompletas</p>';
        return acta;
    }

    document.getElementById('consolidarActa')?.addEventListener('click', () => {
        document.getElementById('actaResultado').innerHTML = generarActaHTML();
    });

    document.getElementById('exportarActaPDF')?.addEventListener('click', () => {
        let contenido = generarActaHTML();
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.html(contenido, {
            callback: function(doc) {
                doc.save('acta_final.pdf');
            },
            x: 10,
            y: 10,
            width: 180
        });
    });

    document.getElementById('exportarActaWord')?.addEventListener('click', () => {
        let contenido = generarActaHTML();
        let html = `<html><head><meta charset="UTF-8"><title>Acta Final MEP</title></head><body>${contenido}</body></html>`;
        let blob = new Blob([html], { type: 'application/msword' });
        let a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'acta_final.doc'; a.click();
    });

    // ---------- 7. IMPORTACI√ìN CSV ----------
    document.getElementById('btnImportarCSVEst')?.addEventListener('click', () => {
        let input = document.createElement('input');
        input.type = 'file';
        input.accept = '.csv';
        input.onchange = (e) => {
            let file = e.target.files[0];
            let reader = new FileReader();
            reader.onload = (ev) => {
                let lines = ev.target.result.split('\n');
                let headers = lines[0].split(',');
                // Formato esperado: Grupo,Nombre,Tel√©fono,Correo,ACS
                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i].trim()) continue;
                    let values = lines[i].split(',');
                    if (values.length < 2) continue;
                    let grupoNombre = values[0].trim();
                    let estudianteNombre = values[1].trim();
                    let telefono = values[2]?.trim() || '';
                    let correo = values[3]?.trim() || '';
                    let acs = values[4]?.trim() === '1';
                    
                    // Buscar o crear grupo
                    let grupo = state.grupos.find(g => g.nombre === grupoNombre);
                    if (!grupo) {
                        grupo = { id: 'g'+Date.now(), nombre: grupoNombre, nivel: 'Secundaria', estudiantes: [] };
                        state.grupos.push(grupo);
                    }
                    grupo.estudiantes.push({
                        id: 'e'+Date.now()+Math.random(),
                        nombre: estudianteNombre,
                        telefono: telefono,
                        correo: correo,
                        acs: acs,
                        observaciones: '',
                        traslados: [],
                        notas: {}
                    });
                }
                saveToast('‚úÖ Estudiantes importados');
                renderGrupos();
                llenarSelectores();
            };
            reader.readAsText(file);
        };
        input.click();
    });

    // ---------- 8. EXPORTACI√ìN MASIVA CSV ----------
    document.getElementById('exportarTodoCSV')?.addEventListener('click', () => {
        let csv = "=== REGISTRO COMPLETO MEP ===\n\n";
        csv += "INSTITUCI√ìN," + state.institucion.nombre + "\n";
        csv += "MODALIDAD," + MODALIDADES[state.modalidad].nombre + "\n\n";
        
        csv += "PERIODOS\n";
        csv += "Nombre,TC,Tareas,Proyecto,Prueba,Demo\n";
        state.periodos.forEach(p => {
            csv += `${p.nombre},${p.tc},${p.tareas},${p.proyecto},${p.prueba},${p.demo || 0}\n`;
        });
        
        csv += "\nGRUPOS Y ESTUDIANTES\n";
        csv += "Grupo,Estudiante,Tel√©fono,Correo,ACS\n";
        state.grupos.forEach(g => {
            g.estudiantes.forEach(e => {
                csv += `${g.nombre},${e.nombre},${e.telefono || ''},${e.correo || ''},${e.acs?1:0}\n`;
            });
        });
        
        let blob = new Blob([csv], { type: 'text/csv' });
        let a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'respaldo_completo.csv'; a.click();
    });

    // ---------- 9. MEJORAS EN RESPALDO ----------
    document.getElementById('exportarJSON')?.addEventListener('click', () => {
        let data = JSON.stringify(state, null, 2);
        let a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([data], { type: 'application/json' }));
        a.download = `mep_respaldo_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
        state.respaldo.fecha = new Date().toLocaleString();
        document.getElementById('fechaUltimoRespaldo').innerText = state.respaldo.fecha;
        saveToast();
    });

    document.getElementById('importarJSONBtn')?.addEventListener('click', () => {
        document.getElementById('importJSONFile').click();
    });

    document.getElementById('importJSONFile')?.addEventListener('change', (e) => {
        let file = e.target.files[0];
        if (!file) return;
        let reader = new FileReader();
        reader.onload = (ev) => {
            try {
                let newState = JSON.parse(ev.target.result);
                if (confirm('¬øSobrescribir todos los datos actuales?')) {
                    state = newState;
                    saveToast('‚úÖ Datos restaurados');
                    location.reload(); // Recargar para aplicar todo
                }
            } catch (ex) { alert('Archivo inv√°lido'); }
        };
        reader.readAsText(file);
    });

    // ---------- 10. INICIALIZAR TODOS LOS M√ìDULOS ----------
    // (Los m√≥dulos base ya se inicializan en Parte 1)
    // A√±adimos render de instrumentos y bit√°cora
    renderInstrumentos();
    renderBitacora();
    
    // Evento para actualizar calendario al cambiar grupo o mes
    document.getElementById('asistGrupoSelect')?.addEventListener('change', renderCalendarioAsistencia);
    document.getElementById('asistMes')?.addEventListener('change', renderCalendarioAsistencia);
    renderCalendarioAsistencia();

    // Llenar selectores de per√≠odo en evaluaci√≥n si no se llenaron
    if (document.getElementById('evalPeriodoSelect')) {
        document.getElementById('evalPeriodoSelect').innerHTML = state.periodos.map((p,i)=>`<option value="${i}">${p.nombre}</option>`).join('');
    }

    console.log('‚úÖ Parte 2 cargada: todos los m√≥dulos completos');


    completos')


    // ============================================================
// PARTE 3: NUEVAS FUNCIONALIDADES - ESTAD√çSTICAS, INSTITUCIONES, USUARIOS, TUTOR√çAS
// ============================================================

// ---------- 1. M√öLTIPLES INSTITUCIONES ----------
function renderSelectorInstituciones() {
    let selector = document.getElementById('selectorInstitucion');
    if (!selector) return;
    
    selector.innerHTML = state.instituciones.map(inst => 
        `<option value="${inst.id}" ${inst.id === state.institucionActual ? 'selected' : ''}>${inst.nombre}</option>`
    ).join('');
}

function cambiarInstitucion(id) {
    state.institucionActual = id;
    let inst = state.instituciones.find(i => i.id === id);
    if (inst) {
        state.modalidad = inst.modalidad;
        state.periodos = inst.periodos;
        state.grupos = inst.grupos;
        document.getElementById('currentInstitucion').innerText = inst.nombre;
        saveToast('‚úÖ Instituci√≥n cambiada');
        
        // Recargar todas las vistas
        renderPeriodos();
        renderGrupos();
        llenarSelectores();
        renderSelectorInstituciones();
    }
}

document.getElementById('cambiarInstitucionBtn')?.addEventListener('click', () => {
    let selector = document.getElementById('selectorInstitucion');
    cambiarInstitucion(selector.value);
});

document.getElementById('crearInstitucionBtn')?.addEventListener('click', () => {
    let nombre = document.getElementById('nuevaInstitucionNombre').value;
    let modalidad = document.getElementById('nuevaInstitucionModalidad').value;
    
    if (!nombre) { alert('Ingrese nombre'); return; }
    
    let nuevaInst = {
        id: 'inst' + Date.now(),
        nombre: nombre,
        logo: '',
        modalidad: modalidad,
        periodos: [
            { id: 'p1', nombre: 'I Periodo', tc: 30, tareas: 20, proyecto: 20, prueba: 30, demo: 0, activo: true },
            { id: 'p2', nombre: 'II Periodo', tc: 30, tareas: 20, proyecto: 20, prueba: 30, demo: 0, activo: true },
            { id: 'p3', nombre: 'III Periodo', tc: 30, tareas: 20, proyecto: 20, prueba: 30, demo: 0, activo: true }
        ],
        grupos: [],
        tutorias: []
    };
    
    state.instituciones.push(nuevaInst);
    renderSelectorInstituciones();
    saveToast('‚úÖ Instituci√≥n creada');
});

// ---------- 2. USUARIOS Y PERMISOS ----------
function renderUsuarios() {
    let div = document.getElementById('usuariosList');
    if (!div) return;
    
    let html = '<table class="table"><tr><th>Usuario</th><th>Rol</th><th>Acciones</th></tr>';
    state.usuarios.forEach((u, idx) => {
        html += `<tr>
            <td>${u.nombre} (${u.email})</td>
            <td>${u.rol}</td>
            <td class="fila-acciones">
                <i class="fas fa-edit" onclick="editarUsuario(${idx})"></i>
                <i class="fas fa-trash" onclick="eliminarUsuario(${idx})"></i>
            </td>
        </tr>`;
    });
    html += '</table>';
    div.innerHTML = html;
    
    // Selector para permisos
    let selector = document.getElementById('usuarioSelectorPermisos');
    selector.innerHTML = state.usuarios.map((u, i) => `<option value="${i}">${u.nombre}</option>`).join('');
}

window.editarUsuario = (idx) => {
    let u = state.usuarios[idx];
    u.nombre = prompt('Nombre', u.nombre) || u.nombre;
    u.email = prompt('Email', u.email) || u.email;
    saveToast();
    renderUsuarios();
};

window.eliminarUsuario = (idx) => {
    if (confirm('¬øEliminar usuario?')) {
        state.usuarios.splice(idx, 1);
        saveToast();
        renderUsuarios();
    }
};

document.getElementById('nuevoUsuarioBtn')?.addEventListener('click', () => {
    let nombre = prompt('Nombre del docente');
    let email = prompt('Email');
    if (nombre && email) {
        state.usuarios.push({
            id: 'user' + Date.now(),
            nombre: nombre,
            email: email,
            rol: 'docente',
            institucionesPermitidas: [state.institucionActual]
        });
        saveToast();
        renderUsuarios();
    }
});

document.getElementById('usuarioSelectorPermisos')?.addEventListener('change', (e) => {
    let idx = e.target.value;
    if (idx === '') return;
    let usuario = state.usuarios[idx];
    
    let html = '<h5>Instituciones permitidas:</h5>';
    state.instituciones.forEach(inst => {
        let tienePermiso = usuario.institucionesPermitidas?.includes(inst.id) || false;
        html += `<label><input type="checkbox" class="permisoInstitucion" data-usuario="${idx}" data-inst="${inst.id}" ${tienePermiso ? 'checked' : ''}> ${inst.nombre}</label><br>`;
    });
    document.getElementById('institucionesPermisos').innerHTML = html;
});

document.getElementById('guardarPermisos')?.addEventListener('click', () => {
    let checkboxes = document.querySelectorAll('.permisoInstitucion');
    let permisosPorUsuario = {};
    
    checkboxes.forEach(cb => {
        let usuarioIdx = cb.dataset.usuario;
        let instId = cb.dataset.inst;
        if (!permisosPorUsuario[usuarioIdx]) permisosPorUsuario[usuarioIdx] = [];
        if (cb.checked) permisosPorUsuario[usuarioIdx].push(instId);
    });
    
    Object.keys(permisosPorUsuario).forEach(idx => {
        state.usuarios[idx].institucionesPermitidas = permisosPorUsuario[idx];
    });
    
    saveToast('‚úÖ Permisos actualizados');
});

// ---------- 3. GR√ÅFICOS ESTAD√çSTICOS ----------
let graficoRendimiento = null;

function renderEstadisticas() {
    let grupoIdx = document.getElementById('estadisticasGrupoSelect')?.value;
    let periodoIdx = document.getElementById('estadisticasPeriodoSelect')?.value;
    
    if (grupoIdx === '' || periodoIdx === '') return;
    
    let grupo = state.grupos[grupoIdx];
    let periodo = state.periodos[periodoIdx];
    
    // Datos para el gr√°fico
    let estudiantes = grupo.estudiantes.map(e => e.nombre);
    let promedios = grupo.estudiantes.map(e => parseFloat(e.notas[periodo.id]?.promedio || 0));
    
    // Destruir gr√°fico anterior si existe
    if (graficoRendimiento) graficoRendimiento.destroy();
    
    let ctx = document.getElementById('graficoRendimiento').getContext('2d');
    graficoRendimiento = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: estudiantes,
            datasets: [{
                label: `Promedios - ${periodo.nombre}`,
                data: promedios,
                backgroundColor: 'rgba(15, 111, 147, 0.6)',
                borderColor: '#0f6f93',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });
    
    // Tabla de promedios
    let tablaHtml = '<table class="table"><tr><th>Estudiante</th><th>Promedio</th></tr>';
    grupo.estudiantes.forEach(e => {
        let prom = e.notas[periodo.id]?.promedio || '-';
        tablaHtml += `<tr><td>${e.nombre}</td><td>${prom}</td></tr>`;
    });
    tablaHtml += '</table>';
    document.getElementById('tablaPromedios').innerHTML = tablaHtml;
    
    // Estad√≠sticas del grupo
    let valores = promedios.filter(p => p > 0);
    let promedioGrupal = valores.length ? (valores.reduce((a,b) => a+b, 0) / valores.length).toFixed(2) : 0;
    let max = Math.max(...valores);
    let min = Math.min(...valores);
    let aprobados = valores.filter(p => p >= 65).length;
    let reprobados = valores.filter(p => p > 0 && p < 65).length;
    
    let statsHtml = `
        <p><strong>Promedio grupal:</strong> ${promedioGrupal}%</p>
        <p><strong>Nota m√°s alta:</strong> ${max}%</p>
        <p><strong>Nota m√°s baja:</strong> ${min}%</p>
        <p><strong>Aprobados:</strong> ${aprobados}</p>
        <p><strong>En convocatoria:</strong> ${reprobados}</p>
        <p><strong>Sin notas:</strong> ${grupo.estudiantes.length - valores.length}</p>
    `;
    document.getElementById('estadisticasGrupo').innerHTML = statsHtml;
}

// Llenar selects de estad√≠sticas
function llenarSelectoresEstadisticas() {
    let selGrupo = document.getElementById('estadisticasGrupoSelect');
    let selPeriodo = document.getElementById('estadisticasPeriodoSelect');
    
    if (selGrupo) {
        selGrupo.innerHTML = '<option value="">-- Grupo --</option>' + 
            state.grupos.map((g,i) => `<option value="${i}">${g.nombre}</option>`).join('');
    }
    
    if (selPeriodo) {
        selPeriodo.innerHTML = state.periodos.map((p,i) => `<option value="${i}">${p.nombre}</option>`).join('');
    }
}

document.getElementById('estadisticasGrupoSelect')?.addEventListener('change', renderEstadisticas);
document.getElementById('estadisticasPeriodoSelect')?.addEventListener('change', renderEstadisticas);

// ---------- 4. TUTOR√çAS ----------
function renderTutorias() {
    let grupoIdx = document.getElementById('tutoriasGrupoSelect')?.value;
    let estudianteIdx = document.getElementById('tutoriasEstudianteSelect')?.value;
    
    if (grupoIdx === '' || estudianteIdx === '') return;
    
    let inst = state.instituciones.find(i => i.id === state.institucionActual);
    if (!inst.tutorias) inst.tutorias = [];
    
    let estudiante = state.grupos[grupoIdx].estudiantes[estudianteIdx];
    let tutoriasEstudiante = inst.tutorias.filter(t => t.estudianteId === estudiante.id);
    
    let html = '<h4>Historial de reuniones</h4>';
    html += '<table class="table"><tr><th>Fecha</th><th>Tema</th><th>Acuerdos</th><th>Acciones</th></tr>';
    
    tutoriasEstudiante.forEach((t, idx) => {
        html += `<tr>
            <td>${t.fecha}</td>
            <td>${t.tema}</td>
            <td>${t.acuerdos}</td>
            <td class="fila-acciones">
                <i class="fas fa-trash" onclick="eliminarTutoria(${idx}, '${estudiante.id}')"></i>
            </td>
        </tr>`;
    });
    
    html += '</table>';
    document.getElementById('tutoriasList').innerHTML = html;
}

window.eliminarTutoria = (idxTutoria, estudianteId) => {
    if (confirm('¬øEliminar registro de reuni√≥n?')) {
        let inst = state.instituciones.find(i => i.id === state.institucionActual);
        inst.tutorias = inst.tutorias.filter(t => !(t.estudianteId === estudianteId && inst.tutorias.indexOf(t) === idxTutoria));
        saveToast();
        renderTutorias();
    }
};

document.getElementById('tutoriasGrupoSelect')?.addEventListener('change', (e) => {
    let idx = e.target.value;
    let estSelect = document.getElementById('tutoriasEstudianteSelect');
    if (idx === '') { estSelect.innerHTML = '<option value="">--</option>'; return; }
    let estudiantes = state.grupos[idx]?.estudiantes || [];
    estSelect.innerHTML = '<option value="">-- Estudiante --</option>' + 
        estudiantes.map((es, i) => `<option value="${i}">${es.nombre}</option>`).join('');
});

document.getElementById('tutoriasEstudianteSelect')?.addEventListener('change', renderTutorias);

document.getElementById('nuevaTutoriaBtn')?.addEventListener('click', () => {
    let grupoIdx = document.getElementById('tutoriasGrupoSelect').value;
    let estudianteIdx = document.getElementById('tutoriasEstudianteSelect').value;
    
    if (grupoIdx === '' || estudianteIdx === '') {
        alert('Seleccione grupo y estudiante');
        return;
    }
    
    let fecha = prompt('Fecha (YYYY-MM-DD)', new Date().toISOString().slice(0,10));
    let tema = prompt('Tema de la reuni√≥n');
    let acuerdos = prompt('Acuerdos tomados');
    
    if (fecha && tema) {
        let inst = state.instituciones.find(i => i.id === state.institucionActual);
        if (!inst.tutorias) inst.tutorias = [];
        
        let estudiante = state.grupos[grupoIdx].estudiantes[estudianteIdx];
        
        inst.tutorias.push({
            id: 'tut' + Date.now(),
            estudianteId: estudiante.id,
            fecha: fecha,
            tema: tema,
            acuerdos: acuerdos || ''
        });
        
        saveToast('‚úÖ Reuni√≥n registrada');
        renderTutorias();
    }
});

// ---------- 5. IMPRESI√ìN DIRECTA ----------
document.getElementById('exportarActaPDF')?.addEventListener('click', () => {
    let contenido = generarActaHTML();
    let ventanaImpresion = window.open('', '_blank');
    ventanaImpresion.document.write(`
        <html>
            <head>
                <title>Acta Final MEP</title>
                <style>
                    body { font-family: Arial; padding: 2rem; }
                    table { border-collapse: collapse; width: 100%; }
                    th, td { border: 1px solid #ccc; padding: 0.5rem; }
                </style>
            </head>
            <body>${contenido}</body>
        </html>
    `);
    ventanaImpresion.document.close();
    ventanaImpresion.print();
});

// ---------- 6. ACTUALIZAR FUNCIONES EXISTENTES ----------
// Modificar saveToast para incluir instituciones
const originalSaveToast = saveToast;
saveToast = function(msg = '‚úÖ Guardado') {
    // Asegurar que las instituciones tengan sus datos actualizados
    let instActual = state.instituciones.find(i => i.id === state.institucionActual);
    if (instActual) {
        instActual.modalidad = state.modalidad;
        instActual.periodos = state.periodos;
        instActual.grupos = state.grupos;
    }
    originalSaveToast(msg);
};

// Inicializar nuevos elementos al cargar
(function initMejoras() {
    renderSelectorInstituciones();
    renderUsuarios();
    llenarSelectoresEstadisticas();
    
    // Llenar selectores de tutor√≠as
    let selTutoriaG = document.getElementById('tutoriasGrupoSelect');
    if (selTutoriaG) {
        selTutoriaG.innerHTML = '<option value="">-- Grupo --</option>' + 
            state.grupos.map((g,i) => `<option value="${i}">${g.nombre}</option>`).join('');
    }
})();
    
</script>
</body>
</html>
