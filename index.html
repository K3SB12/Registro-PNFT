<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>Registro Docente MEP ¬∑ 2026</title>
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- jsPDF y html2canvas para PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, system-ui, -apple-system, sans-serif;
        }

        :root {
            --bg: #f4f7fc;
            --sidebar: #0a2e44;
            --sidebar-hover: #1e4a66;
            --card: #ffffff;
            --text: #1e3a5f;
            --text-light: #4a6782;
            --border: #cbd6e6;
            --accent: #0d6b8c;
            --accent-light: #e3f0f9;
            --success: #2b7a4b;
            --warning: #b95e0a;
            --danger: #c13e3e;
            --shadow: 0 12px 30px rgba(0, 20, 40, 0.08);
            --header-bg: #f9fcff;
            --input-bg: #ffffff;
            --card-hover: #f5faff;
        }

        .dark {
            --bg: #1b2635;
            --sidebar: #0b1f30;
            --card: #263544;
            --text: #e2ecf5;
            --text-light: #aec3d9;
            --border: #3e536b;
            --accent: #1e88b0;
            --accent-light: #203e54;
            --header-bg: #1f3142;
            --input-bg: #2d4055;
            --shadow: 0 12px 30px rgba(0, 0, 0, 0.5);
            --card-hover: #2f4055;
        }

        body {
            background: var(--bg);
            color: var(--text);
            display: flex;
            min-height: 100vh;
            transition: background 0.2s, color 0.2s;
        }

        /* SIDEBAR - en desktop fijo, en m√≥vil se transforma */
        .sidebar {
            width: 280px;
            background: var(--sidebar);
            color: #e0f0fa;
            padding: 2rem 1rem;
            overflow-y: auto;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            transition: 0.3s;
            z-index: 100;
        }

        .sidebar h2 {
            font-weight: 400;
            font-size: 1.4rem;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid #2b5370;
            padding-bottom: 1.2rem;
        }

        .sidebar nav {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
            flex: 1;
        }

        .sidebar button {
            background: none;
            border: none;
            color: #cfecff;
            text-align: left;
            padding: 1rem 1.2rem;
            font-size: 1rem;
            border-radius: 14px;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 14px;
            width: 100%;
        }

        .sidebar button i {
            width: 26px;
            font-size: 1.2rem;
        }

        .sidebar button:hover {
            background: var(--sidebar-hover);
            color: white;
        }

        .sidebar button.active {
            background: var(--accent);
            color: white;
            font-weight: 500;
            box-shadow: 0 6px 12px rgba(0, 40, 60, 0.5);
        }

        .sidebar-footer {
            font-size: 0.9rem;
            color: #8fb4d4;
            padding-top: 2rem;
            border-top: 1px solid #1d405a;
        }

        /* MAIN CONTENT */
        .main-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            max-height: 100vh;
        }

        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            background: var(--header-bg);
            padding: 1rem 2rem;
            border-radius: 50px;
            box-shadow: var(--shadow);
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header-bar h1 {
            font-size: 1.6rem;
            font-weight: 400;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modo-toggle {
            background: var(--card);
            border: 1px solid var(--border);
            padding: 0.6rem 1.4rem;
            border-radius: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        .card {
            background: var(--card);
            border-radius: 32px;
            padding: 2rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            border: 1px solid var(--border);
        }

        .card h3 {
            margin-bottom: 1.8rem;
            font-weight: 500;
            border-left: 6px solid var(--accent);
            padding-left: 1.2rem;
            font-size: 1.4rem;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.8rem;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
        }

        .btn {
            background: var(--card);
            border: 1px solid var(--border);
            padding: 0.7rem 1.5rem;
            border-radius: 40px;
            cursor: pointer;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: 0.2s;
            color: var(--text);
            font-size: 0.95rem;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
            border: none;
        }

        .btn-primary:hover {
            background: #0b5b79;
        }

        .btn-success {
            background: var(--success);
            color: white;
            border: none;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
            border: none;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
            border: none;
        }

        .btn-sm {
            padding: 0.5rem 1.2rem;
            font-size: 0.85rem;
        }

        input, select, textarea {
            background: var(--input-bg);
            border: 1px solid var(--border);
            padding: 0.8rem 1.2rem;
            border-radius: 30px;
            width: 100%;
            margin-bottom: 1rem;
            color: var(--text);
            font-size: 0.95rem;
        }

        label {
            font-weight: 600;
            margin-bottom: 0.4rem;
            display: block;
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card);
            border-radius: 20px;
            overflow: hidden;
            margin: 1rem 0;
            display: block;
            overflow-x: auto;
            white-space: nowrap;
        }

        .table th {
            background: var(--accent-light);
            text-align: left;
            padding: 1rem;
        }

        .table td {
            padding: 0.9rem 1rem;
            border-bottom: 1px solid var(--border);
        }

        .badge {
            padding: 0.3rem 0.8rem;
            border-radius: 30px;
            font-size: 0.75rem;
            background: var(--accent-light);
            color: var(--accent);
            font-weight: 600;
        }

        .fila-acciones i {
            margin: 0 6px;
            cursor: pointer;
            opacity: 0.7;
            font-size: 1rem;
        }

        .fila-acciones i:hover {
            opacity: 1;
            color: var(--accent);
        }

        .barra-acciones {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 1.5rem 0;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--accent);
            color: white;
            padding: 1rem 2rem;
            border-radius: 60px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: none;
            z-index: 9999;
            font-weight: 500;
        }

        .alert {
            padding: 1rem 1.5rem;
            border-radius: 30px;
            margin: 1rem 0;
            border-left: 8px solid;
        }

        .alert-warning {
            background: #fff1d6;
            border-color: var(--warning);
            color: #6b4100;
        }

        .dark .alert-warning {
            background: #362d1a;
            color: #ffdcaa;
        }

        /* Calendario responsive */
        .calendario {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
            margin: 1rem 0;
            overflow-x: auto;
        }

        .dia {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 0.5rem;
            text-align: center;
            min-width: 90px;
        }

        .dia select {
            margin-top: 4px;
            font-size: 0.75rem;
            padding: 0.2rem;
            width: 100%;
        }

        /* Responsive para m√≥vil */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                padding: 1rem;
                max-height: 80px;
                overflow: visible;
                flex-direction: row;
                align-items: center;
                justify-content: space-between;
                position: sticky;
                top: 0;
                z-index: 1000;
            }
            .sidebar h2 {
                margin-bottom: 0;
                border-bottom: none;
                padding-bottom: 0;
                font-size: 1.2rem;
            }
            .sidebar nav {
                flex-direction: row;
                overflow-x: auto;
                gap: 0.2rem;
                padding: 0.2rem 0;
            }
            .sidebar button {
                padding: 0.5rem 0.8rem;
                font-size: 0.8rem;
                white-space: nowrap;
            }
            .sidebar button i {
                font-size: 1rem;
            }
            .sidebar-footer {
                display: none;
            }
            .main-content {
                padding: 1rem;
                max-height: none;
            }
            .header-bar {
                flex-direction: column;
                align-items: flex-start;
                padding: 1rem;
            }
            .card {
                padding: 1.5rem;
            }
            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }
            .barra-acciones {
                flex-direction: column;
                align-items: stretch;
            }
            .btn {
                justify-content: center;
            }
        }

        .componente-desactivado {
            opacity: 0.5;
            pointer-events: none;
        }

        .indicador-modalidad {
            background: var(--accent-light);
            padding: 0.3rem 1rem;
            border-radius: 30px;
            font-size: 0.8rem;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <!-- SIDEBAR -->
    <div class="sidebar">
        <h2><i class="fas fa-chalkboard-teacher"></i> MEP 2026</h2>
        <nav id="menuNav">
            <button data-tab="tab1" class="active"><i class="fas fa-cog"></i> Config</button>
            <button data-tab="tab2"><i class="fas fa-users"></i> Grupos</button>
            <button data-tab="tab3"><i class="fas fa-star"></i> Evaluaci√≥n</button>
            <button data-tab="tab4"><i class="fas fa-tasks"></i> Instrumentos</button>
            <button data-tab="tab5"><i class="fas fa-calendar-check"></i> Asistencia</button>
            <button data-tab="tab6"><i class="fas fa-book-open"></i> Bit√°cora</button>
            <button data-tab="tab7"><i class="fas fa-chart-bar"></i> Reportes</button>
            <button data-tab="tab8"><i class="fas fa-file-certificate"></i> Acta</button>
            <button data-tab="tab9"><i class="fas fa-database"></i> Respaldos</button>
        </nav>
        <div class="sidebar-footer">
            <i class="fas fa-sync-alt"></i> auto
        </div>
    </div>

    <!-- MAIN -->
    <div class="main-content">
        <div class="header-bar">
            <h1><i class="fas fa-clipboard-list"></i> <span id="currentInstitucion">Liceo MEP</span></h1>
            <div class="modo-toggle" id="toggleModo">
                <i class="fas fa-moon"></i> <span>Modo oscuro</span>
            </div>
        </div>

        <!-- PANEL 1: CONFIGURACI√ìN (con modalidad) -->
        <div id="tab1" class="tab-panel active">
            <div class="card">
                <h3>‚öôÔ∏è Configuraci√≥n General</h3>
                <div class="grid-2">
                    <div>
                        <label>Instituci√≥n</label>
                        <input id="institucionNombre" placeholder="Nombre" value="Liceo de Costa Rica">
                        <label>Logo URL (opcional)</label>
                        <input id="institucionLogo" placeholder="https://...">
                        <button class="btn btn-primary" id="guardarInstitucion"><i class="fas fa-save"></i> Guardar</button>
                    </div>
                    <div>
                        <label>Modalidad del centro</label>
                        <select id="selectModalidad">
                            <option value="primaria">Educaci√≥n Primaria</option>
                            <option value="secundaria" selected>Secundaria Acad√©mica</option>
                            <option value="tecnica">Educaci√≥n T√©cnica / CINDEA</option>
                            <option value="epja">EPJA (J√≥venes y Adultos)</option>
                        </select>
                        <span class="indicador-modalidad" id="modalidadLabel">Secundaria Acad√©mica</span>
                    </div>
                </div>
                <hr style="margin:2rem 0">
                <h4>üìÖ Periodos y porcentajes (solo componentes activos seg√∫n modalidad)</h4>
                <div id="periodosContainer"></div>
                <div class="barra-acciones">
                    <button class="btn" id="agregarPeriodo"><i class="fas fa-plus"></i> Nuevo periodo</button>
                    <button class="btn btn-primary" id="guardarPorcentajes"><i class="fas fa-check"></i> Validar y guardar</button>
                </div>
                <div class="alert" id="totalPorcentajesDisplay">Total suma: 0% (debe ser 100%)</div>
                <div id="componentesActivosMsg" class="alert-warning" style="margin-top:1rem"></div>
            </div>
        </div>

        <!-- PANEL 2: GRUPOS (id√©ntico a versi√≥n anterior pero se llenar√°) -->
        <div id="tab2" class="tab-panel"><div class="card"><h3>üìö Grupos y Estudiantes</h3><div class="barra-acciones"><button class="btn" id="btnNuevoGrupo"><i class="fas fa-layer-group"></i> Nuevo grupo</button><button class="btn" id="btnExportarCSVEst"><i class="fas fa-file-export"></i> Exportar CSV</button></div><div id="gruposList"></div></div></div>
        <!-- PANEL 3: EVALUACI√ìN -->
        <div id="tab3" class="tab-panel"><div class="card"><h3>üìù Registro de Componentes</h3><div class="grid-2"><div><label>Grupo</label><select id="evalGrupoSelect"></select></div><div><label>Estudiante</label><select id="evalEstudianteSelect"></select></div></div><div id="notasForm"></div><button class="btn btn-primary" id="guardarNotas"><i class="fas fa-calculator"></i> Calcular y guardar</button><div id="promedioCalculado" class="alert" style="margin-top:1rem"></div></div></div>
        <!-- PANEL 4: INSTRUMENTOS -->
        <div id="tab4" class="tab-panel"><div class="card"><h3>üìã Instrumentos</h3><div class="barra-acciones"><button class="btn" id="nuevoInstrumento"><i class="fas fa-plus"></i> Nuevo</button><button class="btn" id="duplicarInstrumento"><i class="fas fa-copy"></i> Duplicar</button></div><div id="instrumentosList" class="grid-3"></div></div></div>
        <!-- PANEL 5: ASISTENCIA -->
        <div id="tab5" class="tab-panel"><div class="card"><h3>üìÖ Asistencia</h3><div class="grid-2"><div><label>Grupo</label><select id="asistGrupoSelect"></select></div><div><label>Mes</label><input type="month" id="asistMes" value="2026-02"></div></div><div id="calendarioAsistencia"></div><div class="barra-acciones"><button class="btn" id="guardarAsistencia"><i class="fas fa-save"></i> Guardar</button><button class="btn btn-warning" id="generarAlertaWA"><i class="fab fa-whatsapp"></i> Alerta</button></div></div></div>
        <!-- PANEL 6: BIT√ÅCORA -->
        <div id="tab6" class="tab-panel"><div class="card"><h3>üìì Bit√°cora</h3><div class="barra-acciones"><button class="btn" id="nuevaEntradaBitacora"><i class="fas fa-pen"></i> Nueva</button><input type="text" id="buscarBitacora" placeholder="Buscar..."></div><div id="bitacoraEntries"></div></div></div>
        <!-- PANEL 7: REPORTES -->
        <div id="tab7" class="tab-panel"><div class="card"><h3>üìä Reportes</h3><div class="grid-2"><div><label>Periodo</label><select id="reportePeriodoSelect"></select></div><div><label>Grupo</label><select id="reporteGrupoSelect"></select></div></div><div class="barra-acciones"><button class="btn" id="generarReporteIndividual"><i class="fas fa-user"></i> Individual</button><button class="btn" id="exportarReportePDF"><i class="fas fa-file-pdf"></i> PDF</button></div><div id="reporteResultado"></div></div></div>
        <!-- PANEL 8: ACTA -->
        <div id="tab8" class="tab-panel"><div class="card"><h3>üìú Acta Final</h3><button class="btn btn-primary" id="consolidarActa"><i class="fas fa-file-signature"></i> Consolidar</button><div id="actaResultado" style="white-space:pre-wrap; margin-top:2rem"></div></div></div>
        <!-- PANEL 9: RESPALDO -->
        <div id="tab9" class="tab-panel"><div class="card"><h3>üíæ Respaldos</h3><div class="grid-2"><button class="btn btn-primary" id="exportarJSON"><i class="fas fa-download"></i> Exportar JSON</button><button class="btn" id="importarJSONBtn"><i class="fas fa-upload"></i> Importar</button><input type="file" id="importJSONFile" accept=".json" style="display:none"></div><p>√öltimo respaldo: <span id="fechaUltimoRespaldo">nunca</span></p></div></div>

        <div class="toast" id="toastMsg">‚úÖ Listo</div>
    </div>

    <script>
        (function() {
            // ---------- CONFIGURACI√ìN DE MODALIDADES (basada en Reglamento 2026) ----------
            const MODALIDADES = {
                primaria: {
                    nombre: 'Educaci√≥n Primaria',
                    componentes: { tc: true, tareas: true, proyecto: false, prueba: true, demo: false },
                    etiquetas: { tc: 'Trabajo Cotidiano', tareas: 'Tareas', proyecto: 'Proyecto', prueba: 'Prueba', demo: 'Demostraci√≥n' }
                },
                secundaria: {
                    nombre: 'Secundaria Acad√©mica',
                    componentes: { tc: true, tareas: true, proyecto: true, prueba: true, demo: false },
                    etiquetas: { tc: 'Trabajo Cotidiano', tareas: 'Tareas', proyecto: 'Proyecto', prueba: 'Prueba', demo: 'Demostraci√≥n' }
                },
                tecnica: {
                    nombre: 'Educaci√≥n T√©cnica / CINDEA',
                    componentes: { tc: true, tareas: true, proyecto: true, prueba: false, demo: true },
                    etiquetas: { tc: 'Trabajo Cotidiano', tareas: 'Tareas', proyecto: 'Proyecto', prueba: 'Prueba', demo: 'Demostraci√≥n' }
                },
                epja: {
                    nombre: 'Educaci√≥n de Personas J√≥venes y Adultas',
                    componentes: { tc: true, tareas: false, proyecto: true, prueba: false, demo: true },
                    etiquetas: { tc: 'Trabajo Cotidiano', tareas: 'Tareas', proyecto: 'Proyecto', prueba: 'Prueba', demo: 'Demostraci√≥n' }
                }
            };

            // Estado inicial
            let state = {
                institucion: { nombre: 'Liceo de Costa Rica', logo: '' },
                modalidad: 'secundaria', // por defecto
                periodos: [
                    { id: 'p1', nombre: 'I Periodo', tc: 30, tareas: 20, proyecto: 20, prueba: 30, demo: 0, activo: true },
                    { id: 'p2', nombre: 'II Periodo', tc: 30, tareas: 20, proyecto: 20, prueba: 30, demo: 0, activo: true },
                    { id: 'p3', nombre: 'III Periodo', tc: 30, tareas: 20, proyecto: 20, prueba: 30, demo: 0, activo: true }
                ],
                grupos: [
                    { id: 'g1', nombre: '7-1', nivel: 'Secundaria', estudiantes: [
                        { id: 'e1', nombre: 'Mar√≠a P√©rez', telefono: '8888-1111', correo: 'maria@e.cr', acs: false, observaciones: '', traslados: [], notas: {} },
                        { id: 'e2', nombre: 'Juan Castro', telefono: '8888-2222', correo: 'juan@e.cr', acs: true, observaciones: 'ACS', traslados: [], notas: {} }
                    ]}
                ],
                instrumentos: [],
                bitacora: [],
                asistencia: [],
                respaldo: { fecha: null }
            };

            // Cargar de localStorage
            try { if(localStorage.getItem('mepFinal')) state = JSON.parse(localStorage.getItem('mepFinal')); } catch(e) {}

            function saveToast(msg) {
                localStorage.setItem('mepFinal', JSON.stringify(state));
                const t = document.getElementById('toastMsg');
                t.style.display = 'block'; t.innerText = msg || '‚úÖ Guardado';
                setTimeout(() => t.style.display = 'none', 2000);
            }

            // Obtener componentes activos seg√∫n modalidad
            function componentesActivos() {
                return MODALIDADES[state.modalidad]?.componentes || MODALIDADES.secundaria.componentes;
            }

            // Validar suma de porcentajes para un periodo (solo componentes activos)
            function validarSumaPeriodo(p) {
                let comp = componentesActivos();
                let suma = 0;
                if(comp.tc) suma += p.tc || 0;
                if(comp.tareas) suma += p.tareas || 0;
                if(comp.proyecto) suma += p.proyecto || 0;
                if(comp.prueba) suma += p.prueba || 0;
                if(comp.demo) suma += p.demo || 0;
                return suma;
            }

            // Renderizar periodos con campos condicionales
            function renderPeriodos() {
                let container = document.getElementById('periodosContainer');
                if(!container) return;
                let comp = componentesActivos();
                let html = '';
                state.periodos.forEach((p, idx) => {
                    html += `<div style="border:1px solid var(--border); border-radius:24px; padding:1.5rem; margin-bottom:1.5rem;">`;
                    html += `<input type="text" value="${p.nombre}" placeholder="Nombre" data-idx="${idx}" class="periodoNombre" style="margin-bottom:1rem;">`;
                    html += `<div style="display:flex; flex-wrap:wrap; gap:1rem;">`;
                    if(comp.tc) html += `<label>TC <input type="number" class="periodoTc" data-idx="${idx}" value="${p.tc}" min="0" max="100" style="width:90px;"></label>`;
                    if(comp.tareas) html += `<label>Tareas <input type="number" class="periodoTareas" data-idx="${idx}" value="${p.tareas}" min="0" max="100" style="width:90px;"></label>`;
                    if(comp.proyecto) html += `<label>Proyecto <input type="number" class="periodoProyecto" data-idx="${idx}" value="${p.proyecto}" min="0" max="100" style="width:90px;"></label>`;
                    if(comp.prueba) html += `<label>Prueba <input type="number" class="periodoPrueba" data-idx="${idx}" value="${p.prueba}" min="0" max="100" style="width:90px;"></label>`;
                    if(comp.demo) html += `<label>Demostraci√≥n <input type="number" class="periodoDemo" data-idx="${idx}" value="${p.demo || 0}" min="0" max="100" style="width:90px;"></label>`;
                    html += `</div>`;
                    html += `<button class="btn btn-sm btn-danger eliminarPeriodo" data-idx="${idx}" style="margin-top:1rem;"><i class="fas fa-trash"></i> Eliminar</button>`;
                    html += `</div>`;
                });
                container.innerHTML = html;
                document.querySelectorAll('.eliminarPeriodo').forEach(b => b.addEventListener('click', (e) => {
                    if(confirm('¬øEliminar periodo?')) { state.periodos.splice(e.target.closest('button').dataset.idx, 1); saveToast(); actualizarTodo(); }
                }));
                actualizarMsgComponentes();
            }

            function actualizarMsgComponentes() {
                let comp = componentesActivos();
                let activos = [];
                if(comp.tc) activos.push('TC'); if(comp.tareas) activos.push('Tareas'); if(comp.proyecto) activos.push('Proyecto'); if(comp.prueba) activos.push('Prueba'); if(comp.demo) activos.push('Demostraci√≥n');
                document.getElementById('componentesActivosMsg').innerHTML = `üìå Componentes activos seg√∫n modalidad: <strong>${activos.join(' ¬∑ ')}</strong>`;
                document.getElementById('modalidadLabel').innerText = MODALIDADES[state.modalidad]?.nombre || 'Secundaria';
            }

            function recalcularTotalPeriodos() {
                let sumaTotal = 0;
                state.periodos.forEach(p => { sumaTotal += validarSumaPeriodo(p); });
                document.getElementById('totalPorcentajesDisplay').innerText = `Total suma: ${sumaTotal}% (debe ser 100%)`;
                if(sumaTotal !== 100) document.getElementById('totalPorcentajesDisplay').className = 'alert alert-warning';
                else document.getElementById('totalPorcentajesDisplay').className = 'alert';
            }

            // Render grupos, estudiantes, etc (simplificado pero funcional)
            function renderGrupos() {
                let div = document.getElementById('gruposList');
                if(!div) return;
                let html = '';
                state.grupos.forEach((g, idxG) => {
                    html += `<div class="grupo-item" style="background:var(--accent-light); padding:1.5rem; border-radius:24px; margin-bottom:1.5rem;">`;
                    html += `<div style="display:flex; justify-content:space-between;"><h4>${g.nombre}</h4>`;
                    html += `<div><button class="btn btn-sm" onclick="editarGrupo(${idxG})"><i class="fas fa-edit"></i></button> <button class="btn btn-sm btn-danger" onclick="eliminarGrupo(${idxG})"><i class="fas fa-trash"></i></button></div></div>`;
                    html += `<table class="table"><tr><th>Nombre</th><th>Tel√©fono</th><th>ACS</th><th>Acciones</th></tr>`;
                    (g.estudiantes || []).forEach((e, idxE) => {
                        html += `<tr><td>${e.nombre}</td><td>${e.telefono || ''}</td><td>${e.acs ? 'ACS' : ''}</td>`;
                        html += `<td class="fila-acciones"><i class="fas fa-edit" onclick="editarEstudiante(${idxG},${idxE})"></i> <i class="fas fa-trash" onclick="eliminarEstudiante(${idxG},${idxE})"></i></td></tr>`;
                    });
                    html += `</table><button class="btn btn-sm" onclick="agregarEstudiante(${idxG})"><i class="fas fa-user-plus"></i> A√±adir</button>`;
                    html += `</div>`;
                });
                div.innerHTML = html || '<p>No hay grupos</p>';
            }

            window.agregarEstudiante = (g) => { let nom = prompt('Nombre'); if(nom) { state.grupos[g].estudiantes.push({ id:'e'+Date.now(), nombre: nom, telefono:'', correo:'', acs:false, notas:{} }); saveToast(); renderGrupos(); } };
            window.editarEstudiante = (g, e) => { let est = state.grupos[g].estudiantes[e]; est.nombre = prompt('Nombre', est.nombre) || est.nombre; est.acs = confirm('¬øACS?'); saveToast(); renderGrupos(); };
            window.eliminarEstudiante = (g, e) => { if(confirm('Eliminar?')) { state.grupos[g].estudiantes.splice(e,1); saveToast(); renderGrupos(); } };
            window.editarGrupo = (g) => { let nom = prompt('Nombre grupo', state.grupos[g].nombre); if(nom) { state.grupos[g].nombre = nom; saveToast(); renderGrupos(); } };
            window.eliminarGrupo = (g) => { if(confirm('Eliminar grupo?')) { state.grupos.splice(g,1); saveToast(); renderGrupos(); } };

            // Evaluaci√≥n: llenar selects
            function llenarSelectores() {
                let selG = document.getElementById('evalGrupoSelect');
                let selA = document.getElementById('asistGrupoSelect');
                let selR = document.getElementById('reporteGrupoSelect');
                let op = '<option value="">--</option>' + state.grupos.map((g,i)=>`<option value="${i}">${g.nombre}</option>`).join('');
                if(selG) selG.innerHTML = op;
                if(selA) selA.innerHTML = op;
                if(selR) selR.innerHTML = op;
                let selP = document.getElementById('reportePeriodoSelect');
                if(selP) selP.innerHTML = state.periodos.map((p,i)=>`<option value="${i}">${p.nombre}</option>`).join('');
            }

            // Guardar notas (con validaci√≥n de componentes activos)
            document.getElementById('guardarNotas')?.addEventListener('click', ()=>{
                let g = document.getElementById('evalGrupoSelect').value;
                let e = document.getElementById('evalEstudianteSelect').value;
                if(g===''||e==='') return alert('Seleccione grupo y estudiante');
                let estudiante = state.grupos[g].estudiantes[e];
                let periodo = state.periodos[0]; // por simplicidad usamos el primero
                let pid = periodo.id;
                if(!estudiante.notas[pid]) estudiante.notas[pid] = {};
                let comp = componentesActivos();
                let tc = comp.tc ? parseFloat(prompt('Trabajo Cotidiano (0-100)', estudiante.notas[pid]?.tc||'0'))||0 : 0;
                let tareas = comp.tareas ? parseFloat(prompt('Tareas (0-100)', estudiante.notas[pid]?.tareas||'0'))||0 : 0;
                let proyecto = comp.proyecto ? parseFloat(prompt('Proyecto (0-100)', estudiante.notas[pid]?.proyecto||'0'))||0 : 0;
                let prueba = comp.prueba ? parseFloat(prompt('Prueba (0-100)', estudiante.notas[pid]?.prueba||'0'))||0 : 0;
                let demo = comp.demo ? parseFloat(prompt('Demostraci√≥n (0-100)', estudiante.notas[pid]?.demo||'0'))||0 : 0;
                if(tc>100||tareas>100||proyecto>100||prueba>100||demo>100) return alert('M√°x 100');
                estudiante.notas[pid] = { tc, tareas, proyecto, prueba, demo };
                // Calcular promedio ponderado seg√∫n modalidad
                let ponderado = 0;
                if(comp.tc) ponderado += tc * (periodo.tc/100);
                if(comp.tareas) ponderado += tareas * (periodo.tareas/100);
                if(comp.proyecto) ponderado += proyecto * (periodo.proyecto/100);
                if(comp.prueba) ponderado += prueba * (periodo.prueba/100);
                if(comp.demo) ponderado += demo * ((periodo.demo||0)/100);
                if(estudiante.acs) ponderado = ponderado * 0.9; // ejemplo f√≥rmula ACS
                estudiante.notas[pid].promedio = ponderado.toFixed(2);
                document.getElementById('promedioCalculado').innerText = `üìä Promedio: ${ponderado.toFixed(2)}%`;
                saveToast();
            });

            // Reporte individual
            document.getElementById('generarReporteIndividual')?.addEventListener('click', ()=>{
                let g = document.getElementById('reporteGrupoSelect').value;
                let p = document.getElementById('reportePeriodoSelect').value;
                if(g===''||p==='') return;
                let grupo = state.grupos[g];
                let periodo = state.periodos[p];
                let html = `<table class="table"><tr><th>Estudiante</th><th>TC</th><th>Tareas</th><th>Proyecto</th><th>Prueba</th><th>Demo</th><th>Prom</th></tr>`;
                grupo.estudiantes.forEach(e => {
                    let n = e.notas[periodo.id] || {};
                    html += `<tr><td>${e.nombre}</td><td>${n.tc||'-'}</td><td>${n.tareas||'-'}</td><td>${n.proyecto||'-'}</td><td>${n.prueba||'-'}</td><td>${n.demo||'-'}</td><td>${n.promedio||'-'}</td></tr>`;
                });
                html += '</table>';
                document.getElementById('reporteResultado').innerHTML = html;
            });

            // Acta final
            document.getElementById('consolidarActa')?.addEventListener('click', ()=>{
                let acta = 'ACTA FINAL DE EVALUACI√ìN 2026\n\n';
                state.grupos.forEach(g => {
                    acta += `${g.nombre}\n`;
                    g.estudiantes.forEach(e => {
                        let suma = 0, c = 0;
                        state.periodos.forEach(p => { if(e.notas[p.id]?.promedio) { suma += parseFloat(e.notas[p.id].promedio); c++; } });
                        let prom = c>0 ? (suma/c).toFixed(2) : '--';
                        let cond = prom>=65 ? 'Aprobado' : (prom>0? 'Convocatoria':'Reprobado');
                        acta += `${e.nombre}: ${prom} - ${cond}\n`;
                    });
                });
                document.getElementById('actaResultado').innerText = acta;
            });

            // Respaldos
            document.getElementById('exportarJSON')?.addEventListener('click', ()=>{
                let data = JSON.stringify(state,null,2);
                let a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([data],{type:'application/json'})); a.download = 'mep_respaldo.json'; a.click();
                state.respaldo.fecha = new Date().toLocaleString(); document.getElementById('fechaUltimoRespaldo').innerText = state.respaldo.fecha; saveToast();
            });
            document.getElementById('importarJSONBtn')?.addEventListener('click', ()=> document.getElementById('importJSONFile').click());
            document.getElementById('importJSONFile')?.addEventListener('change', (e)=>{
                let file = e.target.files[0]; if(!file) return;
                let reader = new FileReader();
                reader.onload = (ev) => { try { let newState = JSON.parse(ev.target.result); if(confirm('¬øSobrescribir todo?')) { state = newState; saveToast(); actualizarTodo(); } } catch(ex){ alert('Error'); } };
                reader.readAsText(file);
            });

            // Guardar configuraci√≥n
            document.getElementById('guardarInstitucion')?.addEventListener('click', ()=>{
                state.institucion.nombre = document.getElementById('institucionNombre').value;
                state.institucion.logo = document.getElementById('institucionLogo').value;
                saveToast();
            });
            document.getElementById('selectModalidad')?.addEventListener('change', (e)=>{
                state.modalidad = e.target.value;
                saveToast(); actualizarTodo();
            });

            document.getElementById('agregarPeriodo')?.addEventListener('click', ()=>{
                state.periodos.push({ id:'p'+Date.now(), nombre:'Nuevo periodo', tc:25, tareas:25, proyecto:25, prueba:25, demo:0 });
                saveToast(); actualizarTodo();
            });

            document.getElementById('guardarPorcentajes')?.addEventListener('click', ()=>{
                document.querySelectorAll('.periodoNombre').forEach(i => { let idx=i.dataset.idx; state.periodos[idx].nombre = i.value; });
                document.querySelectorAll('.periodoTc').forEach(i => { let idx=i.dataset.idx; state.periodos[idx].tc = parseInt(i.value)||0; });
                document.querySelectorAll('.periodoTareas').forEach(i => { let idx=i.dataset.idx; state.periodos[idx].tareas = parseInt(i.value)||0; });
                document.querySelectorAll('.periodoProyecto').forEach(i => { let idx=i.dataset.idx; state.periodos[idx].proyecto = parseInt(i.value)||0; });
                document.querySelectorAll('.periodoPrueba').forEach(i => { let idx=i.dataset.idx; state.periodos[idx].prueba = parseInt(i.value)||0; });
                document.querySelectorAll('.periodoDemo').forEach(i => { let idx=i.dataset.idx; state.periodos[idx].demo = parseInt(i.value)||0; });
                let ok = true;
                state.periodos.forEach((p,idx) => { let s = validarSumaPeriodo(p); if(s !== 100) { alert(`Periodo ${p.nombre} suma ${s}%`); ok = false; } });
                if(ok) { saveToast('‚úÖ Porcentajes v√°lidos'); actualizarTodo(); }
            });

            // Modo oscuro
            document.getElementById('toggleModo')?.addEventListener('click', ()=> document.body.classList.toggle('dark'));

            // Men√∫ pesta√±as
            document.querySelectorAll('#menuNav button').forEach(b => b.addEventListener('click', (e)=>{
                document.querySelectorAll('#menuNav button').forEach(bb=>bb.classList.remove('active'));
                b.classList.add('active');
                document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
                document.getElementById(b.dataset.tab).classList.add('active');
            }));

            function actualizarTodo() {
                renderPeriodos();
                renderGrupos();
                llenarSelectores();
                recalcularTotalPeriodos();
                document.getElementById('selectModalidad').value = state.modalidad;
                document.getElementById('institucionNombre').value = state.institucion.nombre;
                document.getElementById('currentInstitucion').innerText = state.institucion.nombre;
            }

            actualizarTodo();
            setInterval(() => saveToast('‚è≤Ô∏è Auto-guardado'), 45000);
        })();
    </script>
</body>
</html>
